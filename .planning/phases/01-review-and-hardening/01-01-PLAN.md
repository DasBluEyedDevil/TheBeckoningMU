---
phase: 01-review-and-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/traits/api.py
  - beckonmu/traits/utils.py
autonomous: true

must_haves:
  truths:
    - "No traits API endpoint has @csrf_exempt decorator"
    - "CharacterImportAPI rejects unauthenticated and non-staff requests"
    - "CharacterExportAPI rejects unauthenticated requests and enforces ownership"
    - "CharacterAvailableTraitsAPI rejects unauthenticated requests"
    - "CharacterValidationAPI rejects unauthenticated requests"
    - "Trait catalog GET endpoints (categories, traits, powers) require login"
    - "CharacterApprovalAPI rejects double-approval with 409 Conflict"
    - "CharacterCreateAPI error messages do not leak ORM details"
    - "Server rejects character with more than 15 additional attribute dots"
    - "Server rejects character with more than 27 total skill dots"
    - "Server rejects character with discipline dots != 3 or < 2 in-clan"
    - "Server rejects character with advantage points != 7 or flaw points > 2"
  artifacts:
    - path: "beckonmu/traits/api.py"
      provides: "All 11 traits API views with CSRF and auth fixes"
      contains: "login_required|is_authenticated"
    - path: "beckonmu/traits/utils.py"
      provides: "V5 chargen validation constants and pool validation logic"
      contains: "V5_CHARGEN_RULES"
  key_links:
    - from: "beckonmu/traits/api.py"
      to: "beckonmu/traits/utils.py"
      via: "CharacterCreateAPI calls enhanced_import_character_from_json which validates pools"
      pattern: "enhanced_import_character_from_json"
    - from: "beckonmu/traits/api.py"
      to: "Django CSRF middleware"
      via: "No csrf_exempt means middleware enforces CSRF on POST"
      pattern: "NOT csrf_exempt"
---

<objective>
Harden all character creation API endpoints by removing CSRF exemptions, adding authentication and authorization checks, adding idempotent approval protection, sanitizing error messages, and implementing server-side V5 chargen rule validation.

Purpose: REVW-01 and REVW-03 (character creation portion) -- prevent unauthenticated access, CSRF bypass, invalid character submission, and double-approval race conditions. These are the most critical security findings from the research phase.

Output: Modified `traits/api.py` with all 11 views secured, and modified `traits/utils.py` with V5 pool validation logic added to `enhanced_import_character_from_json`.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-review-and-hardening/01-RESEARCH.md

Source files to modify:
@beckonmu/traits/api.py
@beckonmu/traits/utils.py

Reference for V5 validation rules (frontend implementation to mirror):
@beckonmu/web/templates/character_creation.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove all @csrf_exempt decorators and add authentication checks to traits API</name>
  <files>beckonmu/traits/api.py</files>
  <action>
Remove the `@method_decorator(csrf_exempt, name='dispatch')` decorator from ALL 11 API view classes in traits/api.py. The frontend already sends X-CSRFToken headers (verified in character_creation.html line 1412 and character_approval.html line 353). For GET-only endpoints, removing csrf_exempt is a no-op (Django does not enforce CSRF on GET), but removing it keeps the codebase clean.

Also remove the `from django.views.decorators.csrf import csrf_exempt` import since it will no longer be used.

Then add authentication and authorization checks to the 7 endpoints that currently have NONE:

1. **TraitCategoriesAPI.get()** -- Add: if not request.user.is_authenticated: return JsonResponse({'error': 'Authentication required'}, status=401)
2. **TraitsAPI.get()** -- Same auth check as above
3. **DisciplinePowersAPI.get()** -- Same auth check as above
4. **CharacterValidationAPI.post()** -- Same auth check as above
5. **CharacterImportAPI.post()** -- Add BOTH auth check AND staff check: if not request.user.is_authenticated: return 401. if not request.user.is_staff: return JsonResponse({'error': 'Staff permissions required'}, status=403). This is the CRITICAL fix -- currently any anonymous user can overwrite character traits.
6. **CharacterExportAPI.get()** -- Add auth check, then add ownership/staff check: after fetching the character, verify request.user is the character's db_account OR is_staff. Return 403 if neither.
7. **CharacterAvailableTraitsAPI.get()** -- Same ownership/staff pattern as CharacterExportAPI.

Additionally, add auth checks BEFORE the existing staff check logic to follow the is_authenticated-first pattern:
- PendingCharactersAPI already checks is_authenticated AND is_staff -- OK as-is
- CharacterDetailAPI already checks is_authenticated AND is_staff -- OK as-is

Fix CharacterImportAPI error messages that leak ORM details:
- Line 206: Change `f'Account {account_name} not found'` to `'Account not found'`
- Line 208: Change `f'Character {character_name} not found for account {account_name}'` to `'Character not found'`

Fix CharacterCreateAPI error messages:
- Line 472: Change `f'Invalid data: {e}'` to `'Invalid character data'`
- Line 480: Change `f'Not found: {e}'` to `'Required data not found'`

Add idempotent approval check to CharacterApprovalAPI.post():
After fetching the bio, before processing the action, add:
```python
if action == 'approve' and bio.approved:
    return JsonResponse({'error': 'Character already approved', 'approved_by': bio.approved_by}, status=409)
```

The best place to add auth checks is in the individual get/post methods (not in dispatch or via mixin) to match the existing pattern used by PendingCharactersAPI and CharacterDetailAPI. This keeps the codebase consistent.
  </action>
  <verify>
Grep for `csrf_exempt` in traits/api.py -- should return 0 matches.
Grep for `is_authenticated` in traits/api.py -- should appear in every API view class.
Grep for `f'Not found:` and `f'Account ` in traits/api.py -- should return 0 matches (no leaky error messages).
  </verify>
  <done>
All 11 @csrf_exempt decorators removed from traits/api.py.
7 endpoints that had zero auth checks now require authentication.
CharacterImportAPI requires staff permissions.
CharacterExportAPI and CharacterAvailableTraitsAPI enforce ownership or staff.
CharacterApprovalAPI returns 409 if character already approved.
Error messages in CharacterImportAPI and CharacterCreateAPI use generic text.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add server-side V5 chargen pool validation</name>
  <files>beckonmu/traits/utils.py</files>
  <action>
Add V5 character creation validation constants and pool validation logic to traits/utils.py. The frontend already enforces these rules (character_creation.html lines 319-345 for attributes, 404-431 for skills, 557-558 for disciplines). The server currently only validates individual trait min/max ranges but NOT total dot pools.

Step 1: Add V5 validation constants near the top of the file (after imports):

```python
# V5 Character Creation Rules -- must match frontend validation
# Source: character_creation.html lines 319-345, 404-431, 557-558
V5_CHARGEN_RULES = {
    'attribute_total_additional': 15,  # 7 + 5 + 3 (above base 1 per attribute)
    'attribute_base_per': 1,
    'attribute_count': 9,              # 3 physical + 3 social + 3 mental
    'skill_total': 27,                 # 13 + 9 + 5
    'discipline_total': 3,
    'discipline_min_in_clan': 2,       # At least 2 must be in-clan (non-Caitiff)
    'advantage_total': 7,
    'flaw_max': 2,
    'trait_max': 5,
}
```

Step 2: Add a validation function `validate_v5_chargen_pools(json_data, clan=None)` that:
- Sums all attribute ratings from the json_data (attributes category). Attributes have a base of 1, so total additional dots = sum of all attribute ratings - 9. Validate that total additional dots equals exactly 15.
- Sums all skill ratings. Validate total equals exactly 27.
- Counts discipline dots (from the disciplines category in json_data). Validate total equals exactly 3.
- If clan is provided and clan != 'Caitiff' and clan != 'Thin-Blood', check that at least 2 discipline dots are in in-clan disciplines. To determine in-clan, look up Trait objects with category code 'disciplines' that have splat_restriction matching the clan. NOTE: if the clan-to-discipline mapping is not easily available in the Trait model, skip the in-clan check for now and add a comment noting it needs the clan-discipline mapping from the frontend or a new model field. Do NOT block on this -- it's a nice-to-have that staff review catches.
- Sums advantage points. Validate total equals exactly 7.
- Sums flaw points. Validate total is at most 2.
- Returns a list of validation error strings (empty if valid).

The function should be resilient to missing data -- if a category key is missing from json_data, treat it as zero dots (which will fail validation, correctly).

Step 3: Call `validate_v5_chargen_pools()` at the beginning of `enhanced_import_character_from_json()`, BEFORE processing individual traits. Pass the json_data and the clan from `json_data.get('clan')`. If pool validation returns errors, add them to results['validation_errors'] and set results['success'] = False, then return early (do not import any traits).

Important: The validate_only=True path should ALSO run pool validation (it is validation, after all). Do not skip it in validate_only mode.

Do NOT try to validate the priority assignment (which specific category gets 7 vs 5 vs 3). The research explicitly recommends against this: "Do NOT try to validate priority distribution (which category gets 7/5/3) -- this is hard to reverse-engineer from flat trait data and staff review catches it anyway."
  </action>
  <verify>
Grep for `V5_CHARGEN_RULES` in traits/utils.py -- should exist.
Grep for `validate_v5_chargen_pools` in traits/utils.py -- should exist and be called from enhanced_import_character_from_json.
Read the function and verify it checks: attribute total, skill total, discipline total, advantage total, flaw max.
  </verify>
  <done>
V5_CHARGEN_RULES constants defined in traits/utils.py matching frontend values.
validate_v5_chargen_pools() function validates attribute pool (15 additional), skill pool (27), discipline dots (3), advantage points (7), and flaw cap (2).
enhanced_import_character_from_json() calls pool validation before processing traits and returns early with errors if pools are invalid.
Both validate_only and full import modes run pool validation.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete:

1. `grep -c "csrf_exempt" beckonmu/traits/api.py` returns 0
2. `grep -c "is_authenticated" beckonmu/traits/api.py` returns at least 7 (one per unprotected endpoint)
3. `grep "V5_CHARGEN_RULES" beckonmu/traits/utils.py` finds the constants
4. `grep "validate_v5_chargen_pools" beckonmu/traits/utils.py` finds the function and its call site
5. No import of csrf_exempt remains in traits/api.py
6. CharacterApprovalAPI contains "already approved" idempotency check
7. Error messages in exception handlers use generic text, not f-strings with exception details
</verification>

<success_criteria>
- Zero @csrf_exempt decorators in traits/api.py
- All 11 API views require authentication
- CharacterImportAPI requires staff permissions (is_staff check)
- CharacterExportAPI and CharacterAvailableTraitsAPI enforce ownership or staff access
- CharacterApprovalAPI returns 409 on double-approval
- Error messages are generic (no ORM detail leakage)
- Server-side V5 pool validation rejects invalid attribute/skill/discipline/advantage/flaw totals
- enhanced_import_character_from_json calls pool validation before processing traits
</success_criteria>

<output>
After completion, create `.planning/phases/01-review-and-hardening/01-01-SUMMARY.md`
</output>
