---
phase: 01-review-and-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/web/builder/views.py
  - beckonmu/web/builder/exporter.py
  - beckonmu/web/builder/validators.py
  - beckonmu/web/builder/models.py
autonomous: true

must_haves:
  truths:
    - "No builder view has @csrf_exempt decorator"
    - "Exporter output contains no @py commands"
    - "Exporter handles missing exit source/target keys without KeyError"
    - "Exporter handles missing object room key without KeyError"
    - "Staff user saving a project sees an updated version number in the response"
    - "Staff user saving with outdated data receives a conflict error instead of silently overwriting"
    - "Newly created projects have a schema_version in their map data"
    - "Validator rejects rooms that are missing a name or have non-dict data"
  artifacts:
    - path: "beckonmu/web/builder/views.py"
      provides: "Builder API views with CSRF fix and concurrency control"
      contains: "version"
    - path: "beckonmu/web/builder/exporter.py"
      provides: "Batch script generator without @py injection"
      contains: ".get("
    - path: "beckonmu/web/builder/validators.py"
      provides: "Project validator with data shape checks"
      contains: "name"
    - path: "beckonmu/web/builder/models.py"
      provides: "BuildProject model with version field and schema_version in defaults"
      contains: "version"
  key_links:
    - from: "beckonmu/web/builder/views.py"
      to: "beckonmu/web/builder/models.py"
      via: "SaveProjectView reads and increments project.version for optimistic concurrency"
      pattern: "version"
    - from: "beckonmu/web/builder/exporter.py"
      to: "map_data JSON"
      via: "All key access uses .get() with validation"
      pattern: "\\.get\\("
---

<objective>
Harden all grid builder views, exporter, validator, and model by removing CSRF exemptions, fixing the @py injection risk in the exporter, replacing unsafe direct key access with .get(), adding optimistic concurrency control to saves, adding schema_version to new projects, and improving the validator to check room data shape.

Purpose: REVW-02 and REVW-03 (builder portion) -- prevent CSRF bypass on builder mutation endpoints, eliminate injection risk in batch export, prevent data corruption from concurrent saves, and ensure robustness against malformed project data.

Output: Modified builder views.py (CSRF removed, concurrency control added), exporter.py (@py removed, safe key access), validators.py (shape validation), and models.py (version field, schema_version default).
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-review-and-hardening/01-RESEARCH.md

Source files to modify:
@beckonmu/web/builder/views.py
@beckonmu/web/builder/exporter.py
@beckonmu/web/builder/validators.py
@beckonmu/web/builder/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove @csrf_exempt from builder views and add optimistic concurrency control</name>
  <files>beckonmu/web/builder/views.py, beckonmu/web/builder/models.py</files>
  <action>
**In beckonmu/web/builder/views.py:**

Remove the `@method_decorator(csrf_exempt, name="dispatch")` decorator from all three views that have it:
- SaveProjectView (line 70)
- DeleteProjectView (line 146)
- BuildProjectView (line 167)

Also remove the `from django.views.decorators.csrf import csrf_exempt` import since it will no longer be used.

The frontend already sends X-CSRFToken header (verified in editor.html line 810).

Then add optimistic concurrency control to SaveProjectView.post():

When UPDATING an existing project (project_id is truthy):
1. After fetching the project with get_object_or_404, read `client_version = data.get("version")`.
2. If client_version is provided, compare it to `project.version`. If they do not match, return:
   ```python
   return JsonResponse({
       "status": "error",
       "error": "Project was modified by another session. Reload and try again.",
       "server_version": project.version
   }, status=409)
   ```
3. After saving, increment the version: `project.version = (project.version or 0) + 1` before `project.save()`.
4. Include the new version in the success response: add `"version": project.version` to the response JSON.

When CREATING a new project, set version=1 on the new project (it will default from the model field).

Also include `"version": project.version` in the create response.

**In beckonmu/web/builder/models.py:**

Add a `version` field to BuildProject:
```python
version = models.PositiveIntegerField(default=1, help_text="Optimistic concurrency version -- incremented on each save")
```

Add it after the `is_public` field.

Update `get_default_map_data()` to include `schema_version`:
```python
def get_default_map_data(self):
    """Return empty map data structure."""
    return {
        "schema_version": 1,
        "rooms": {},
        "exits": {},
        "objects": {},
        "next_room_id": 1,
        "next_exit_id": 1,
        "next_object_id": 1,
    }
```

After modifying the model, create and run a Django migration:
```bash
cd beckonmu && python ../manage.py makemigrations builder && python ../manage.py migrate
```

Note: The manage.py location may vary -- check for manage.py in the project root or use `evennia migrate` if that is the standard command. Try `evennia makemigrations builder` first, fall back to finding manage.py manually.

If migration commands are unclear, create the migration file manually by looking at existing migration files in `beckonmu/web/builder/migrations/` for the pattern. The migration should add a `version` field with default=1.
  </action>
  <verify>
Grep for `csrf_exempt` in builder/views.py -- should return 0 matches.
Grep for `version` in builder/views.py -- should appear in SaveProjectView.
Grep for `version` in builder/models.py -- should appear as a model field.
Grep for `schema_version` in builder/models.py -- should appear in get_default_map_data.
Check that migration file exists in beckonmu/web/builder/migrations/.
  </verify>
  <done>
All 3 @csrf_exempt decorators removed from builder views.
SaveProjectView implements optimistic concurrency: compares client version to server version, returns 409 on mismatch, increments version on save.
BuildProject model has version field (default=1).
get_default_map_data includes schema_version: 1.
Migration created and applied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix exporter @py injection and unsafe key access</name>
  <files>beckonmu/web/builder/exporter.py</files>
  <action>
Fix two issues in beckonmu/web/builder/exporter.py:

**Issue 1: Remove @py injection risk (line 264)**

Replace the @py line:
```python
lines.append(f"@py from evennia import logger; logger.log_info('Web Builder: Project {project_id} ({project.name}) built successfully')")
```

With a safe @set command:
```python
lines.append(f"@set {sandbox_alias}/build_completed = True")
lines.append("#")
lines.append(f"@set {sandbox_alias}/build_project_id = {project_id}")
```

This removes the code execution vector entirely. The project name is no longer interpolated into executable code.

**Issue 2: Replace direct key access with .get() (lines 180-181, 222)**

Line 180-181 -- Exit source/target:
```python
# BEFORE:
source_alias = f"_bld_{project_id}_{exit_data['source']}"
target_alias = f"_bld_{project_id}_{exit_data['target']}"

# AFTER:
source_id = exit_data.get('source')
target_id = exit_data.get('target')
if not source_id or not target_id:
    # Skip malformed exit data -- validator should catch this
    continue
source_alias = f"_bld_{project_id}_{source_id}"
target_alias = f"_bld_{project_id}_{target_id}"
```

Line 222 -- Object room:
```python
# BEFORE:
room_alias = f"_bld_{project_id}_{obj_data['room']}"

# AFTER:
room_id = obj_data.get('room')
if not room_id:
    continue
room_alias = f"_bld_{project_id}_{room_id}"
```

Also review the rest of the file for any other direct dictionary key access on user-provided data. The room.get("name"), room.get("description"), exit_data.get("name"), etc. already use .get() correctly. The v5.get() calls are also correct. The haven.get() calls are correct. The obj_data.get() calls on lines 223, 230, 244 are correct. The only unsafe accesses are the three fixed above.
  </action>
  <verify>
Grep for `@py` in exporter.py -- should return 0 matches.
Grep for `exit_data\['` in exporter.py -- should return 0 matches (all replaced with .get()).
Grep for `obj_data\['` in exporter.py -- should return 0 matches.
Grep for `.get(` in exporter.py -- should appear for source, target, and room access.
  </verify>
  <done>
@py line removed from exporter, replaced with safe @set commands.
All direct key access on exit_data and obj_data replaced with .get() and validation.
Malformed data (missing source/target/room) is safely skipped instead of raising KeyError.
  </done>
</task>

<task type="auto">
  <name>Task 3: Improve validator to check room data shape</name>
  <files>beckonmu/web/builder/validators.py</files>
  <action>
Enhance the validate_project() function in validators.py to check room data shape beyond just connectivity. Currently it only validates room/exit connections and warns about missing descriptions and duplicate names.

Add shape validation for each room BEFORE the connectivity checks:

```python
# Validate room data shape
for room_id, room in rooms.items():
    if not isinstance(room, dict):
        errors.append(f"Room '{room_id}' has invalid data format")
        continue
    if not room.get("name"):
        errors.append(f"Room '{room_id}' is missing a name")
    # Position validation (rooms should have x, y coordinates)
    if "x" not in room and "gridX" not in room:
        warnings.append(f"Room '{room.get('name', room_id)}' has no grid position")
```

Also validate exit data shape:

```python
# Validate exit data shape
for exit_id, exit_data in exits.items():
    if not isinstance(exit_data, dict):
        errors.append(f"Exit '{exit_id}' has invalid data format")
        continue
    if not exit_data.get("source"):
        errors.append(f"Exit '{exit_id}' is missing source room")
    if not exit_data.get("target"):
        errors.append(f"Exit '{exit_id}' is missing target room")
    if not exit_data.get("name"):
        warnings.append(f"Exit '{exit_id}' has no name")
```

Move the existing exit connectivity validation AFTER the shape validation, and only process exits that passed shape validation (have source and target).

Keep the existing warnings for isolated rooms, unreachable rooms, empty descriptions, and duplicate names -- they are useful.

Important: Do NOT make this validation overly strict. Rooms should be allowed to have minimal data (just a name). The V5 settings, description, and position are all optional. The goal is to catch malformed JSON that would cause KeyError in the exporter, not to enforce a complete room specification.
  </action>
  <verify>
Read validators.py and confirm it checks: room is dict, room has name, exit has source/target.
Verify existing connectivity and duplicate-name warnings are preserved.
  </verify>
  <done>
Validator checks room data shape (dict type, name field present).
Validator checks exit data shape (dict type, source and target fields present).
Existing connectivity warnings and duplicate name checks preserved.
Validation catches malformed data before it reaches the exporter.
  </done>
</task>

</tasks>

<verification>
After all tasks are complete:

1. `grep -c "csrf_exempt" beckonmu/web/builder/views.py` returns 0
2. `grep -c "@py" beckonmu/web/builder/exporter.py` returns 0
3. `grep "exit_data\['" beckonmu/web/builder/exporter.py` returns 0 matches
4. `grep "obj_data\['" beckonmu/web/builder/exporter.py` returns 0 matches
5. `grep "version" beckonmu/web/builder/models.py` shows the version field
6. `grep "schema_version" beckonmu/web/builder/models.py` shows schema_version in defaults
7. `grep "isinstance.*dict" beckonmu/web/builder/validators.py` shows shape validation
8. Builder migration file exists and is applied
</verification>

<success_criteria>
- Zero @csrf_exempt decorators in builder views.py
- Exporter contains no @py commands
- All dictionary key access on user data uses .get() with validation
- BuildProject has version field for optimistic concurrency
- SaveProjectView compares versions and returns 409 on conflict
- New projects include schema_version: 1 in map_data
- Validator catches malformed room and exit data shapes
- Migration created and applied for version field
</success_criteria>

<output>
After completion, create `.planning/phases/01-review-and-hardening/01-02-SUMMARY.md`
</output>
