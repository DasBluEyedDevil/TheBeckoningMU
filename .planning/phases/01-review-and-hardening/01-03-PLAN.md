---
phase: 01-review-and-hardening
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All POST endpoints return 403 when called without CSRF token"
    - "All unprotected endpoints return 401 when called without authentication"
    - "CharacterImportAPI returns 403 for non-staff authenticated users"
    - "CharacterExportAPI returns 403 when non-owner non-staff accesses another user's character"
    - "CharacterApprovalAPI returns 409 when approving an already-approved character"
    - "CharacterCreateAPI rejects character with invalid V5 dot pools"
    - "Builder SaveProjectView returns 409 on version mismatch"
    - "Exporter produces valid batch script without @py for a sample project"
  artifacts: []
  key_links:
    - from: "All POST/DELETE endpoints"
      to: "Django CSRF middleware"
      via: "No csrf_exempt means middleware blocks requests without valid token"
      pattern: "403 Forbidden"
---

<objective>
Verify all hardening changes from Plans 01 and 02 work correctly end-to-end. This plan performs a manual smoke test of the critical security fixes and validation logic.

Purpose: Catch any regressions from the CSRF, auth, concurrency, and validation changes before the phase is marked complete. This is a blocking verification gate.

Output: Confirmed working system with all security hardening applied.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-review-and-hardening/01-RESEARCH.md
@.planning/phases/01-review-and-hardening/01-01-SUMMARY.md
@.planning/phases/01-review-and-hardening/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated verification of security fixes</name>
  <files></files>
  <action>
Run a comprehensive verification of all changes made in Plans 01 and 02. This is a code review + static analysis pass, not a test suite (Evennia requires a running server for full integration tests).

**Step 1: Verify CSRF exemptions are fully removed**
```bash
grep -rn "csrf_exempt" beckonmu/traits/api.py beckonmu/web/builder/views.py
```
Expected: Zero matches. If any remain, report as a gap.

**Step 2: Verify authentication checks are present**
For each of these 7 endpoints, confirm `is_authenticated` check exists:
- TraitCategoriesAPI
- TraitsAPI
- DisciplinePowersAPI
- CharacterValidationAPI
- CharacterImportAPI (should also have is_staff)
- CharacterExportAPI (should also have ownership check)
- CharacterAvailableTraitsAPI (should also have ownership check)

```bash
grep -A5 "class TraitCategoriesAPI" beckonmu/traits/api.py
grep -A5 "class CharacterImportAPI" beckonmu/traits/api.py
# etc. for all 7
```

**Step 3: Verify V5 pool validation**
Confirm that `validate_v5_chargen_pools` is defined AND called from `enhanced_import_character_from_json`:
```bash
grep -n "def validate_v5_chargen_pools" beckonmu/traits/utils.py
grep -n "validate_v5_chargen_pools" beckonmu/traits/utils.py
```
Expected: At least 2 matches (definition + call site).

Verify the function checks all 5 pools: attributes, skills, disciplines, advantages, flaws.

**Step 4: Verify exporter fixes**
```bash
grep -n "@py" beckonmu/web/builder/exporter.py
grep -n "exit_data\['" beckonmu/web/builder/exporter.py
grep -n "obj_data\['" beckonmu/web/builder/exporter.py
```
Expected: Zero matches for all three.

**Step 5: Verify concurrency control**
Confirm version field exists in model and is used in SaveProjectView:
```bash
grep -n "version" beckonmu/web/builder/models.py
grep -n "version" beckonmu/web/builder/views.py
```
Expected: version field in model, version check in SaveProjectView.

**Step 6: Verify validator improvements**
Confirm shape validation exists:
```bash
grep -n "isinstance" beckonmu/web/builder/validators.py
grep -n "\.get(" beckonmu/web/builder/validators.py
```

**Step 7: Check for Python syntax errors**
```bash
python -c "import py_compile; py_compile.compile('beckonmu/traits/api.py', doraise=True)"
python -c "import py_compile; py_compile.compile('beckonmu/traits/utils.py', doraise=True)"
python -c "import py_compile; py_compile.compile('beckonmu/web/builder/views.py', doraise=True)"
python -c "import py_compile; py_compile.compile('beckonmu/web/builder/exporter.py', doraise=True)"
python -c "import py_compile; py_compile.compile('beckonmu/web/builder/validators.py', doraise=True)"
python -c "import py_compile; py_compile.compile('beckonmu/web/builder/models.py', doraise=True)"
```
Expected: All compile successfully with no errors.

**Step 8: Verify no unintended changes**
Run git diff --stat to confirm only the expected files were modified.

Report all findings. If any verification step fails, document exactly what is wrong.
  </action>
  <verify>
All 8 verification steps pass with expected results.
  </verify>
  <done>
Automated verification confirms:
- 0 csrf_exempt decorators remain
- 7 endpoints have authentication checks
- V5 pool validation is defined and called
- Exporter has no @py or unsafe key access
- Concurrency control is implemented
- Validator checks data shape
- All files compile without syntax errors
- Only expected files were modified
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete security hardening of character creation and grid builder systems:
1. Removed all 14 @csrf_exempt decorators (11 in traits/api.py, 3 in builder/views.py)
2. Added authentication to 7 unprotected API endpoints
3. Added staff-only check to CharacterImportAPI (was completely open)
4. Added ownership checks to CharacterExportAPI and CharacterAvailableTraitsAPI
5. Added idempotent approval check (409 on double-approve)
6. Sanitized error messages (no ORM detail leakage)
7. Added server-side V5 chargen pool validation (attributes, skills, disciplines, advantages, flaws)
8. Removed @py injection risk from batch exporter
9. Fixed unsafe dictionary key access in exporter
10. Added optimistic concurrency control to builder saves
11. Added schema_version to new project map data
12. Improved validator to check room/exit data shapes
  </what-built>
  <how-to-verify>
1. Start the Evennia server: `evennia start` (or `evennia restart` if already running)
2. Open browser to http://localhost:4001/character-creation/
3. Verify the character creation page loads (CSRF token is correctly included)
4. Try filling out and submitting a test character -- confirm no 403 CSRF errors
5. Open browser to http://localhost:4001/builder/
6. Verify the builder dashboard loads
7. Try creating/saving a builder project -- confirm no 403 CSRF errors
8. Check Evennia logs for any errors: `evennia --log` or check the server log file

If anything returns 403 Forbidden that previously worked, the CSRF token may not be correctly sent by that specific frontend page. Report which page/action fails.
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe which pages/actions produce errors</resume-signal>
</task>

</tasks>

<verification>
Phase 1 is complete when:
1. All automated verification steps pass
2. Human verification confirms character creation and builder still work in browser
3. No 403 CSRF errors on previously-working functionality
4. Server starts without errors
</verification>

<success_criteria>
- All security hardening verified via automated checks
- Human confirms browser-based character creation still works
- Human confirms browser-based builder still works
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-review-and-hardening/01-03-SUMMARY.md`
</output>
