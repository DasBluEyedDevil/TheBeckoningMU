---
phase: 02-character-approval-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/traits/models.py
  - beckonmu/traits/migrations/0002_characterbio_status_background.py
  - beckonmu/traits/api.py
  - beckonmu/commands/chargen.py
autonomous: true

must_haves:
  truths:
    - "CharacterBio has a status CharField with choices draft/submitted/rejected/approved"
    - "CharacterBio has a background TextField for backstory"
    - "CharacterBio has rejection_notes TextField and rejection_count PositiveIntegerField"
    - "All existing code that used bio.approved boolean still works via @property backward compat"
    - "PendingCharactersAPI returns characters with status submitted or rejected (not draft, not approved)"
    - "CharacterApprovalAPI sets bio.status instead of bio.approved"
    - "CharacterCreateAPI sets bio.status to submitted instead of bio.approved to False"
    - "CmdApprove and CmdReject set bio.status instead of bio.approved"
    - "CmdReject stores rejection reason in bio.rejection_notes and increments bio.rejection_count"
    - "Migration converts existing approved=True rows to status=approved and approved=False to status=submitted"
  artifacts:
    - path: "beckonmu/traits/models.py"
      provides: "CharacterBio with status/background/rejection_notes/rejection_count fields and approved @property"
      contains: "STATUS_CHOICES"
    - path: "beckonmu/traits/migrations/0002_characterbio_status_background.py"
      provides: "Django migration adding new fields and data migration from boolean to status"
      contains: "migrations.AddField"
    - path: "beckonmu/traits/api.py"
      provides: "All API views using bio.status instead of bio.approved for writes"
      contains: "bio.status"
    - path: "beckonmu/commands/chargen.py"
      provides: "CmdApprove and CmdReject using bio.status, CmdReject storing rejection_notes on model"
      contains: "bio.status"
  key_links:
    - from: "beckonmu/traits/models.py"
      to: "beckonmu/traits/api.py"
      via: "CharacterBio.approved @property returns self.status == approved for backward compat"
      pattern: "bio\\.approved|bio\\.status"
    - from: "beckonmu/traits/models.py"
      to: "beckonmu/commands/chargen.py"
      via: "CmdApprove/CmdReject write to bio.status, read via bio.approved property"
      pattern: "bio\\.status|bio\\.approved"
    - from: "beckonmu/traits/migrations/0002_characterbio_status_background.py"
      to: "beckonmu/traits/models.py"
      via: "Migration adds fields that model now declares"
      pattern: "AddField.*status|AddField.*background"
---

<objective>
Extend the CharacterBio model with status lifecycle field (replacing the boolean `approved`), background text field, and rejection tracking fields. Then refactor ALL existing Python call sites to write to `bio.status` instead of `bio.approved`, while keeping a backward-compatible `approved` property for read-only access.

Purpose: This is the foundation for the entire Phase 2. Every other plan depends on the status field existing and all existing code working correctly with it. CHAR-01 (rejection resubmission) needs the status/rejection fields. CHAR-02 (background) needs the background field. The remaining features (auto-placement, notifications, draft save, frontend) all depend on the status field being in place.

Output: Modified `traits/models.py` with new fields, a Django migration that adds fields and converts existing data, and refactored `traits/api.py` + `commands/chargen.py` with all write sites updated from boolean to status string.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character-approval-completion/02-RESEARCH.md

Source files to modify:
@beckonmu/traits/models.py
@beckonmu/traits/api.py
@beckonmu/commands/chargen.py

Migration reference (existing migration to chain from):
@beckonmu/traits/migrations/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status, background, rejection fields to CharacterBio model and create migration</name>
  <files>beckonmu/traits/models.py, beckonmu/traits/migrations/0002_characterbio_status_background.py</files>
  <action>
Modify the `CharacterBio` class in `beckonmu/traits/models.py`:

1. Add STATUS_CHOICES constant at class level:
   ```python
   STATUS_CHOICES = [
       ('draft', 'Draft'),
       ('submitted', 'Submitted'),
       ('rejected', 'Rejected'),
       ('approved', 'Approved'),
   ]
   ```

2. Add new fields AFTER the existing `splat` field and BEFORE the existing `approved` field:
   ```python
   status = models.CharField(
       max_length=20,
       choices=STATUS_CHOICES,
       default='submitted',
       help_text="Current approval status"
   )
   background = models.TextField(
       blank=True,
       help_text="Character's backstory/background narrative"
   )
   rejection_notes = models.TextField(
       blank=True,
       help_text="Staff feedback on why character was rejected"
   )
   rejection_count = models.PositiveIntegerField(
       default=0,
       help_text="Number of times this character has been rejected"
   )
   ```
   NOTE: default='submitted' (not 'draft') because the existing CharacterCreateAPI creates bios at submission time. New draft-save functionality (Plan 03) will set 'draft' explicitly.

3. REMOVE the existing `approved = models.BooleanField(default=False, ...)` field declaration.

4. Add an `@property` named `approved` that returns `self.status == 'approved'` for backward compatibility with any read-only checks (templates, conditions). Place it after the `is_mortal` property:
   ```python
   @property
   def approved(self):
       """Backward compatibility: returns True if status is 'approved'."""
       return self.status == 'approved'
   ```

5. Create the migration file. The migration MUST:
   - Depend on the previous migration (check the `0001_initial.py` or whatever the latest migration is in `beckonmu/traits/migrations/`)
   - Add the `status` CharField with default='submitted'
   - Add the `background` TextField
   - Add the `rejection_notes` TextField
   - Add the `rejection_count` PositiveIntegerField
   - Include a data migration (RunPython) that converts existing rows: `approved=True` -> `status='approved'`, `approved=False` -> `status='submitted'`
   - Remove the `approved` BooleanField

   To generate the migration, run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe beckonmu/manage.py makemigrations traits`

   If makemigrations doesn't handle the remove+property correctly (since we're removing a field and adding a same-named property), you may need to write the migration manually. The approach:
   - Step 1 operations: AddField for status, background, rejection_notes, rejection_count
   - Step 2 operations: RunPython for data migration (forward: set status from approved boolean; reverse: set approved from status)
   - Step 3 operations: RemoveField for approved boolean

   The data migration function:
   ```python
   def convert_approved_to_status(apps, schema_editor):
       CharacterBio = apps.get_model('traits', 'CharacterBio')
       CharacterBio.objects.filter(approved=True).update(status='approved')
       CharacterBio.objects.filter(approved=False).update(status='submitted')

   def convert_status_to_approved(apps, schema_editor):
       CharacterBio = apps.get_model('traits', 'CharacterBio')
       CharacterBio.objects.filter(status='approved').update(approved=True)
       CharacterBio.objects.exclude(status='approved').update(approved=False)
   ```
  </action>
  <verify>
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe beckonmu/manage.py makemigrations --check traits` -- should report no new migrations needed (all changes captured).
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe beckonmu/manage.py migrate --run-syncdb --check` or verify migration file exists and has correct operations.
Verify: `CharacterBio` model file has `STATUS_CHOICES`, `status` field, `background` field, `rejection_notes` field, `rejection_count` field, and `approved` property.
Verify: No `approved = models.BooleanField` line remains in the model.
  </verify>
  <done>CharacterBio model has status/background/rejection_notes/rejection_count fields. Migration file exists with data migration that converts existing boolean data. The approved @property provides backward-compatible read access.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor all API and command call sites from bio.approved boolean writes to bio.status string writes</name>
  <files>beckonmu/traits/api.py, beckonmu/commands/chargen.py</files>
  <action>
Refactor every location that WRITES to `bio.approved` (the boolean that no longer exists as a field) to instead write to `bio.status`. Read-only checks via `bio.approved` still work because of the @property, but all writes MUST change.

**In `beckonmu/traits/api.py`:**

1. `CharacterCreateAPI.post()` (~line 449-461): Change `approved=False` in `CharacterBio.objects.create(...)` to `status='submitted'`. Remove `approved=False` from the create call entirely (the default is 'submitted'). Also add `background=character_data.get('background', '')` to the create call to support the new background field.

2. `CharacterApprovalAPI.post()` (~line 544-552): Replace the approval logic:
   - OLD: `if action == 'approve': bio.approved = True` / `else: bio.approved = False`
   - NEW:
     ```python
     if action == 'approve':
         # Idempotent check should use status instead of property
         if bio.status == 'approved':
             return JsonResponse({'error': 'Character already approved', 'approved_by': bio.approved_by}, status=409)
         bio.status = 'approved'
         bio.approved_by = request.user.username
         bio.approved_at = timezone.now()
         bio.save()
     elif action == 'reject':
         bio.status = 'rejected'
         bio.rejection_notes = notes  # from request.json.get('notes', '')
         bio.rejection_count += 1
         bio.approved_by = request.user.username  # who reviewed
         bio.approved_at = timezone.now()  # when reviewed
         bio.save()
     ```
   - Also store rejection notes in Evennia attributes for in-game access: `if notes: character.db.approval_notes = notes`

3. `PendingCharactersAPI.get()` (~line 311): Change `CharacterBio.objects.filter(approved=False)` to `CharacterBio.objects.filter(status__in=['submitted', 'rejected'])` so pending list shows both submitted and rejected characters. Add `status` to the returned data dict for each character.

4. `CharacterDetailAPI.get()` (~line 347-361): Add `status`, `background`, `rejection_notes`, `rejection_count` to the `bio_data` dict. Keep `approved` in the response for backward compat (it reads from the property).

**In `beckonmu/commands/chargen.py`:**

5. `CmdApprove.func()` (~line 447-455): Change:
   - `bio.approved = True` -> `bio.status = 'approved'`
   - Keep `bio.approved_by` and `bio.approved_at` assignments.
   - Update the already-approved check: `if bio.approved:` still works (reads property) but change to `if bio.status == 'approved':` for clarity.

6. `CmdReject.func()` (~line 570-595): Add after the bio get_or_create:
   ```python
   bio.status = 'rejected'
   bio.rejection_notes = reason
   bio.rejection_count += 1
   bio.save()
   ```
   The existing code does NOT set bio.approved=False on reject (it just notifies). Now we explicitly set the status and store the rejection notes on the model.

7. `CmdPending.func()` and `CmdReview.func()`: Search for any `bio.approved` references in these commands. If they filter by `approved=False`, change to `status__in=['submitted', 'rejected']`. If they just read `bio.approved` as a display value, the property handles it.

8. **Bug fix (Pitfall 6):** In `CmdApprove.func()` and `CmdReject.func()`, find `Comment.objects.create(...)` calls that use `text=comment_text`. Change `text=comment_text` to `content=comment_text` to match the Comment model's actual field name. This is a pre-existing bug documented in the research.

IMPORTANT: Do NOT change any code that only READS `bio.approved` (e.g., `if bio.approved:` in conditionals). The @property handles those. Only change WRITES (`bio.approved = True/False`).
  </action>
  <verify>
Search for `bio.approved = ` (with assignment) in both files -- should return zero results.
Search for `approved=False` in CharacterBio.objects.create/filter calls -- should return zero results (replaced with status).
Search for `text=comment_text` in chargen.py -- should return zero results (replaced with content=).
Search for `bio.status` in api.py and chargen.py -- should find the new status assignments.
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe -c "import beckonmu.traits.api; import beckonmu.commands.chargen; print('Import OK')"` -- should not raise ImportError.
  </verify>
  <done>All write sites for bio.approved have been changed to bio.status. PendingCharactersAPI filters by status__in=['submitted', 'rejected']. CharacterApprovalAPI stores rejection_notes and increments rejection_count on reject. CharacterCreateAPI creates bios with status='submitted'. CmdReject stores rejection notes on the CharacterBio model. Comment field name bug is fixed (text -> content).</done>
</task>

</tasks>

<verification>
1. `CharacterBio` model has: STATUS_CHOICES, status field, background field, rejection_notes field, rejection_count field, approved @property
2. Migration file exists with AddField + RunPython (data migration) + RemoveField operations
3. No `bio.approved = True` or `bio.approved = False` assignment remains in any Python file
4. No `approved=False` in any CharacterBio.objects.create() or .filter() call
5. `PendingCharactersAPI` filters by `status__in=['submitted', 'rejected']`
6. `CharacterApprovalAPI` sets `bio.status = 'approved'` or `bio.status = 'rejected'` and stores rejection_notes
7. `CmdReject` writes rejection reason to `bio.rejection_notes` and increments `bio.rejection_count`
8. Comment.objects.create uses `content=` not `text=`
</verification>

<success_criteria>
- CharacterBio model has all 4 new fields (status, background, rejection_notes, rejection_count)
- Migration converts existing approved=True -> status='approved', approved=False -> status='submitted'
- All Python write sites use bio.status instead of bio.approved
- Read-only access via bio.approved property still returns correct boolean
- Existing approval/rejection flow works with new status field
- Comment field name bug (text -> content) is fixed
</success_criteria>

<output>
After completion, create `.planning/phases/02-character-approval-completion/02-01-SUMMARY.md`
</output>
