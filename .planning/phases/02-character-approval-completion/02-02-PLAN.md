---
phase: 02-character-approval-completion
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - beckonmu/traits/api.py
  - beckonmu/traits/urls.py
  - beckonmu/typeclasses/accounts.py
  - beckonmu/commands/chargen.py
  - beckonmu/web/website/views/__init__.py
autonomous: true

must_haves:
  truths:
    - "GET /api/traits/my-characters/ returns all characters owned by the logged-in player with their status"
    - "GET /api/traits/character/<id>/for-edit/ returns full character data for a rejected character owned by the requester"
    - "POST /api/traits/character/<id>/resubmit/ updates traits and bio, clears rejection notes, sets status to submitted"
    - "Approving a character via API places it in the starting room with location and home set"
    - "Approving a character via +approve command places it in the starting room"
    - "Rejecting a character stores a notification on account.db.pending_notifications"
    - "Approving a character stores a notification on account.db.pending_notifications"
    - "Player sees pending notifications on login via at_post_login delivery"
    - "Resubmission deletes existing CharacterTrait and CharacterPower rows before re-importing"
    - "CharacterCreationView passes edit_character_id to template context when ?edit=<id> is in URL"
    - "CharacterDetailAPI returns background in bio_data dict for staff review"
  artifacts:
    - path: "beckonmu/traits/api.py"
      provides: "MyCharactersAPI, CharacterEditDataAPI, CharacterResubmitAPI classes + notify_account + place_approved_character helpers"
      contains: "class MyCharactersAPI|class CharacterEditDataAPI|class CharacterResubmitAPI|def notify_account|def place_approved_character"
    - path: "beckonmu/traits/urls.py"
      provides: "URL routes for my-characters, for-edit, resubmit endpoints"
      contains: "my-characters|for-edit|resubmit"
    - path: "beckonmu/typeclasses/accounts.py"
      provides: "at_post_login hook delivering pending notifications"
      contains: "at_post_login|pending_notifications"
    - path: "beckonmu/commands/chargen.py"
      provides: "CmdApprove with auto-placement and notification, CmdReject with notification"
      contains: "place_approved_character|notify_account"
    - path: "beckonmu/web/website/views/__init__.py"
      provides: "CharacterCreationView passing edit_character_id from query param"
      contains: "edit_character_id"
  key_links:
    - from: "beckonmu/traits/api.py"
      to: "beckonmu/traits/utils.py"
      via: "CharacterResubmitAPI calls enhanced_import_character_from_json for trait re-import"
      pattern: "enhanced_import_character_from_json"
    - from: "beckonmu/traits/api.py"
      to: "beckonmu/traits/utils.py"
      via: "CharacterEditDataAPI calls export_character_to_json to serialize character for editing"
      pattern: "export_character_to_json"
    - from: "beckonmu/traits/api.py"
      to: "beckonmu/typeclasses/accounts.py"
      via: "notify_account stores on account.db.pending_notifications, at_post_login reads and delivers"
      pattern: "pending_notifications"
    - from: "beckonmu/commands/chargen.py"
      to: "beckonmu/traits/api.py"
      via: "CmdApprove/CmdReject import and call place_approved_character and notify_account helpers"
      pattern: "from.*traits.*api.*import|place_approved_character|notify_account"
    - from: "beckonmu/traits/api.py"
      to: "beckonmu/traits/models.py"
      via: "CharacterResubmitAPI deletes existing CharacterTrait/CharacterPower rows before re-import to prevent duplicates"
      pattern: "CharacterTrait\\.objects\\.filter.*delete|CharacterPower\\.objects\\.filter.*delete"
---

<objective>
Add new API endpoints for the resubmission workflow (my-characters list, character edit data, resubmit), implement auto-placement of approved characters, implement offline notification storage and delivery, and update chargen commands to use these new capabilities.

Purpose: This delivers the backend for CHAR-01 (resubmission), CHAR-03 (auto-placement), and CHAR-04 (notifications). After this plan, the frontend can call these endpoints to enable the full rejection-edit-resubmit cycle, and players will receive notifications whether online or offline.

Output: Three new API views, two helper functions (notify_account, place_approved_character), updated chargen commands, notification delivery via at_post_login, and CharacterCreationView passing edit context.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character-approval-completion/02-RESEARCH.md
@.planning/phases/02-character-approval-completion/02-01-SUMMARY.md

Source files to modify:
@beckonmu/traits/api.py
@beckonmu/traits/urls.py
@beckonmu/typeclasses/accounts.py
@beckonmu/commands/chargen.py
@beckonmu/web/website/views/__init__.py

Reference files (read-only, for patterns):
@beckonmu/traits/utils.py
@beckonmu/traits/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper functions and three new API endpoints with URL routing</name>
  <files>beckonmu/traits/api.py, beckonmu/traits/urls.py, beckonmu/web/website/views/__init__.py</files>
  <action>
**Add helper functions to `beckonmu/traits/api.py`** (place them BEFORE the class definitions, after the imports):

1. `notify_account(account, message, notification_type="info")`:
   ```python
   def notify_account(account, message, notification_type="info"):
       """Store a notification for delivery on next login, and try immediate delivery."""
       from django.utils import timezone as tz
       if not account.db.pending_notifications:
           account.db.pending_notifications = []
       account.db.pending_notifications.append({
           'message': message,
           'type': notification_type,
           'timestamp': tz.now().isoformat(),
           'read': False,
       })
       # Try immediate delivery if player is online
       if account.sessions.count():
           account.msg(message)
   ```

2. `place_approved_character(character)`:
   ```python
   def place_approved_character(character):
       """Move an approved character to the starting room. Sets home and location."""
       from django.conf import settings as django_settings
       from evennia.objects.models import ObjectDB

       start_location = getattr(django_settings, 'START_LOCATION', '#2')
       try:
           if isinstance(start_location, str):
               room_id = int(start_location.strip('#'))
           else:
               room_id = int(start_location)
           start_room = ObjectDB.objects.get(id=room_id)
       except (ValueError, ObjectDB.DoesNotExist):
           # Fallback to Limbo (#2)
           start_room = ObjectDB.objects.get(id=2)

       character.home = start_room
       character.save()
       # Use quiet=True to suppress room announcements (safe from web context)
       character.move_to(start_room, quiet=True)
   ```

**Add three new API view classes to `beckonmu/traits/api.py`** (place them after CharacterApprovalAPI):

3. `MyCharactersAPI` -- GET endpoint returning all characters owned by the authenticated user with their status:
   - Auth check: `request.user.is_authenticated` (401 if not)
   - Query: `ObjectDB.objects.filter(db_account=request.user, db_typeclass_path__contains='characters')`
   - For each character, get its CharacterBio (skip if DoesNotExist)
   - Return: `{'characters': [{'character_id', 'character_name', 'status', 'clan', 'concept', 'rejection_notes' (only if status=='rejected'), 'rejection_count', 'created_at', 'updated_at'}]}`

4. `CharacterEditDataAPI` -- GET endpoint returning full character data for editing a rejected character:
   - Auth check: `request.user.is_authenticated` (401 if not)
   - Get character by ID, verify ownership (`character.db_account != request.user` -> 403)
   - Get bio, verify `bio.status == 'rejected'` (400 if not)
   - Use existing `export_character_to_json(character, include_powers=True)` from `traits/utils.py` to get trait data
   - Merge in bio fields not included in export: background, ambition, desire, sire, generation, predator_type, full_name, concept, clan, splat
   - Return: `{'character_id', 'character_data': {...merged data}, 'rejection_notes', 'rejection_count'}`

5. `CharacterResubmitAPI` -- POST endpoint for resubmitting a rejected character:
   - Auth check: `request.user.is_authenticated` (401 if not)
   - Get character by ID, verify ownership (403)
   - Get bio, verify `bio.status == 'rejected'` (400 if not: "Only rejected characters can be resubmitted")
   - Get `character_data` from `request.json` (400 if missing)
   - **Delete ALL existing CharacterTrait and CharacterPower rows** for this character before re-import (prevents duplicate traits -- see Pitfall 2 in research):
     ```python
     from beckonmu.traits.models import CharacterTrait, CharacterPower
     CharacterTrait.objects.filter(character=character).delete()
     CharacterPower.objects.filter(character=character).delete()
     ```
   - Call `enhanced_import_character_from_json(character, character_data)` to re-import traits
   - If import fails, return 400 with validation errors
   - Update bio fields from character_data: full_name, concept, clan, sire, generation, predator_type, ambition, desire, background
   - Update character.db_key if name changed (check for name conflicts first)
   - Set `bio.status = 'submitted'`, clear `bio.rejection_notes = ''`
   - Save bio
   - Return: `{'success': True, 'character_id', 'message': 'Character resubmitted for approval'}`

**Update the existing `CharacterApprovalAPI.post()` method** to call the new helpers:

6. After setting `bio.status = 'approved'` and saving: call `place_approved_character(character)` for CHAR-03.
7. After approve save: call `notify_account(character.db_account, ...)` with approval message for CHAR-04.
8. After reject save: call `notify_account(character.db_account, ...)` with rejection message including the notes for CHAR-04.

**Update `beckonmu/traits/urls.py`:**

9. Import the three new views: `MyCharactersAPI, CharacterEditDataAPI, CharacterResubmitAPI`
10. Add URL patterns:
    ```python
    path('my-characters/', MyCharactersAPI.as_view(), name='my_characters'),
    path('character/<int:character_id>/for-edit/', CharacterEditDataAPI.as_view(), name='character_for_edit'),
    path('character/<int:character_id>/resubmit/', CharacterResubmitAPI.as_view(), name='character_resubmit'),
    ```

**Update `beckonmu/web/website/views/__init__.py`:**

11. Modify `CharacterCreationView.get_context_data()` to read the `edit` query parameter and pass it to the template:
    ```python
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['page_title'] = 'Create Character'
        edit_id = self.request.GET.get('edit')
        if edit_id:
            try:
                context['edit_character_id'] = int(edit_id)
            except (ValueError, TypeError):
                pass
        return context
    ```
  </action>
  <verify>
Grep for `class MyCharactersAPI` in api.py -- should exist.
Grep for `class CharacterEditDataAPI` in api.py -- should exist.
Grep for `class CharacterResubmitAPI` in api.py -- should exist.
Grep for `def notify_account` in api.py -- should exist.
Grep for `def place_approved_character` in api.py -- should exist.
Grep for `place_approved_character` in CharacterApprovalAPI.post -- should be called after approve.
Grep for `notify_account` in CharacterApprovalAPI.post -- should be called after approve and reject.
Grep for `my-characters` in urls.py -- should exist.
Grep for `for-edit` in urls.py -- should exist.
Grep for `resubmit` in urls.py -- should exist.
Grep for `edit_character_id` in views/__init__.py -- should exist.
Grep for `CharacterTrait.objects.filter.*delete` in api.py -- should exist in CharacterResubmitAPI (confirms Pitfall 2 prevention: old traits deleted before re-import).
Grep for `CharacterPower.objects.filter.*delete` in api.py -- should exist in CharacterResubmitAPI.
Grep for `background` in CharacterDetailAPI section of api.py -- should appear in bio_data dict (confirms CHAR-02 coverage: background returned to staff for review).
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe -c "from beckonmu.traits.api import MyCharactersAPI, CharacterEditDataAPI, CharacterResubmitAPI, notify_account, place_approved_character; print('Import OK')"` -- should succeed.
  </verify>
  <done>Three new API endpoints exist and are routed. Helper functions notify_account and place_approved_character exist. CharacterApprovalAPI calls both helpers on approve/reject. CharacterCreationView passes edit_character_id to template. CharacterResubmitAPI deletes old CharacterTrait/CharacterPower rows before re-import (no duplicates). CharacterDetailAPI includes background in bio_data for staff review.</done>
</task>

<task type="auto">
  <name>Task 2: Update chargen commands with auto-placement and notifications, add at_post_login delivery</name>
  <files>beckonmu/commands/chargen.py, beckonmu/typeclasses/accounts.py</files>
  <action>
**Update `beckonmu/commands/chargen.py`:**

1. At the top of the file, add import for the helpers:
   ```python
   from beckonmu.traits.api import place_approved_character, notify_account
   ```
   If circular import issues arise, move the helper functions to `beckonmu/traits/utils.py` instead and import from there. In that case, also update api.py to import from utils.py.

2. In `CmdApprove.func()`, after `bio.save()` and after the existing "Notify staff" message:
   - Add auto-placement: `place_approved_character(character)`
   - Add self.caller.msg confirmation: `self.caller.msg(f"|gCharacter placed in starting room.|n")`
   - Replace the existing inline notification code (lines ~461-471 that build a notification string and call `character.account.msg()`) with a call to `notify_account()`:
     ```python
     if character.account:
         msg = f"Your character '{character.key}' has been APPROVED by {self.caller.key}!\nYou may now begin playing."
         if message:
             msg += f"\nStaff message: {message}"
         notify_account(character.account, msg, notification_type="approval")
     ```
   This stores the notification for offline delivery AND sends immediately if online.

3. In `CmdReject.func()`, after setting `bio.status = 'rejected'` (from Plan 01) and `bio.save()`:
   - Replace the existing inline notification code (lines ~576-584) with:
     ```python
     if character.account:
         msg = f"Your character '{character.key}' requires revisions.\n"
         msg += f"Staff feedback from {self.caller.key}:\n{reason}\n"
         msg += "Please edit and resubmit via the character creation page."
         notify_account(character.account, msg, notification_type="rejection")
     ```

**Update `beckonmu/typeclasses/accounts.py`:**

4. Override `at_post_login` on the `Account` class to deliver pending notifications:
   ```python
   class Account(DefaultAccount):
       def at_post_login(self, session=None, **kwargs):
           """Deliver any pending notifications on login."""
           super().at_post_login(session=session, **kwargs)

           pending = self.db.pending_notifications
           if pending:
               unread = [n for n in pending if not n.get('read')]
               if unread:
                   self.msg("\n|w=== Notifications ===|n")
                   for notif in unread:
                       self.msg(notif['message'])
                       notif['read'] = True
                   self.msg("|w=====================|n\n")
                   # Remove delivered notifications
                   self.db.pending_notifications = [
                       n for n in pending if not n.get('read')
                   ]
   ```
   IMPORTANT: Keep the existing `pass` body gone -- replace it entirely with the at_post_login method. Keep the docstring and class structure intact. Keep the Guest class unchanged.
  </action>
  <verify>
Grep for `place_approved_character` in chargen.py -- should appear in CmdApprove.func().
Grep for `notify_account` in chargen.py -- should appear in both CmdApprove.func() and CmdReject.func().
Grep for `at_post_login` in accounts.py -- should exist in Account class.
Grep for `pending_notifications` in accounts.py -- should exist.
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe -c "from beckonmu.typeclasses.accounts import Account; print('Import OK')"` -- should succeed.
Run: `cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU && .venv/Scripts/python.exe -c "from beckonmu.commands.chargen import CmdApprove, CmdReject; print('Import OK')"` -- should succeed.
  </verify>
  <done>CmdApprove places approved characters in starting room and stores notification. CmdReject stores notification with rejection reason. Account.at_post_login delivers pending notifications on login and clears them after delivery.</done>
</task>

</tasks>

<verification>
1. `GET /api/traits/my-characters/` returns character list with status field (test with curl or similar)
2. `GET /api/traits/character/<id>/for-edit/` returns full data for a rejected character
3. `POST /api/traits/character/<id>/resubmit/` accepts character_data, re-imports traits, updates status to submitted
4. CharacterApprovalAPI.post() calls place_approved_character() on approve
5. CharacterApprovalAPI.post() calls notify_account() on both approve and reject
6. CmdApprove calls place_approved_character() after bio.save()
7. CmdApprove and CmdReject call notify_account() instead of inline msg()
8. Account.at_post_login reads and delivers pending_notifications
9. CharacterCreationView passes edit_character_id when ?edit=N in URL
10. Resubmission deletes old traits before re-importing (no duplicates)
11. CharacterDetailAPI bio_data dict includes background field for staff review (CHAR-02)
</verification>

<success_criteria>
- Three new API endpoints (my-characters, for-edit, resubmit) are functional and URL-routed
- Auto-placement moves approved characters to settings.START_LOCATION (CHAR-03)
- Notifications stored on account.db.pending_notifications (CHAR-04)
- Notifications delivered on login via at_post_login (CHAR-04)
- Resubmission clears old traits, re-imports, sets status to submitted (CHAR-01 backend)
- Both web API and in-game commands use the same helpers for consistency
- CharacterDetailAPI returns background in bio_data for staff to review during approval
</success_criteria>

<output>
After completion, create `.planning/phases/02-character-approval-completion/02-02-SUMMARY.md`
</output>
