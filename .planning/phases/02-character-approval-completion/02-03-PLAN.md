---
phase: 02-character-approval-completion
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - beckonmu/web/templates/character_approval.html
  - beckonmu/web/templates/character_creation.html
autonomous: true

must_haves:
  truths:
    - "Staff sees a proper textarea modal for rejection notes instead of window.prompt()"
    - "Staff sees character background/backstory on the approval detail view"
    - "Staff sees character status badge (Submitted/Rejected/Approved) on pending list and detail view"
    - "Staff sees rejection count on characters that have been previously rejected"
    - "Player can see rejection notes and a link to edit when viewing a rejected character"
    - "Character creation form includes a Background/Backstory textarea"
    - "When URL has ?edit=<id>, form loads existing character data from for-edit API and enters edit mode"
    - "In edit mode, form shows rejection notes banner at the top"
    - "In edit mode, submit button says Resubmit and POSTs to /resubmit/ endpoint"
    - "Form auto-saves draft to localStorage every 30 seconds and on field blur"
    - "On page load, if localStorage has a draft, prompt to resume it"
    - "Draft is cleared on successful submission or resubmission"
    - "Draft is keyed by character ID for edit mode and as chargen_draft_new for new characters"
  artifacts:
    - path: "beckonmu/web/templates/character_approval.html"
      provides: "Rejection notes modal, background display, status badges"
      contains: "rejection-modal|background|status-badge"
    - path: "beckonmu/web/templates/character_creation.html"
      provides: "Edit mode, background field, draft save/resume, resubmission"
      contains: "editMode|chargen_draft|background|resubmit"
  key_links:
    - from: "beckonmu/web/templates/character_creation.html"
      to: "/api/traits/character/<id>/for-edit/"
      via: "JavaScript fetch on page load when edit_character_id is set"
      pattern: "for-edit|editCharacterId"
    - from: "beckonmu/web/templates/character_creation.html"
      to: "/api/traits/character/<id>/resubmit/"
      via: "JavaScript fetch on form submit in edit mode"
      pattern: "resubmit"
    - from: "beckonmu/web/templates/character_creation.html"
      to: "localStorage"
      via: "saveDraft/loadDraft functions keyed by character ID"
      pattern: "localStorage|chargen_draft"
    - from: "beckonmu/web/templates/character_approval.html"
      to: "/api/traits/character/<id>/approval/"
      via: "Rejection modal sends notes in POST body"
      pattern: "rejection.*notes|approval"
---

<objective>
Update both web templates to complete the frontend for Phase 2: (1) character_approval.html gets a proper rejection notes modal, background display, and status badges; (2) character_creation.html gets edit mode for rejected characters, a background/backstory field, draft save/resume via localStorage, and resubmission flow.

Purpose: This delivers the user-facing UI for CHAR-01 (rejection resubmission web flow), CHAR-02 (background field in creation form and approval display), and CHAR-05 (draft save/resume). After this plan, the complete character lifecycle works end-to-end through the web interface.

Output: Updated character_approval.html with rejection modal and status display. Updated character_creation.html with edit mode, background field, draft persistence, and resubmit capability.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character-approval-completion/02-RESEARCH.md
@.planning/phases/02-character-approval-completion/02-01-SUMMARY.md
@.planning/phases/02-character-approval-completion/02-02-SUMMARY.md

Source files to modify:
@beckonmu/web/templates/character_approval.html
@beckonmu/web/templates/character_creation.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update character_approval.html with rejection modal, background display, and status badges</name>
  <files>beckonmu/web/templates/character_approval.html</files>
  <action>
Read `beckonmu/web/templates/character_approval.html` (430 lines) in full first. Then make these targeted changes:

**1. Add status badges to the pending characters list.**
The existing code renders a table of pending characters. Each row should now include a status badge. In the JavaScript that renders the pending list (look for the function that iterates pending_characters and creates table rows), add a status column:
- `submitted` -> `<span class="badge bg-warning">Submitted</span>`
- `rejected` -> `<span class="badge bg-danger">Rejected (N)</span>` where N is rejection_count

The API (PendingCharactersAPI) now returns `status` and `rejection_count` in each character object.

**2. Add background display to the character detail view.**
When staff clicks a character to review, the detail panel shows bio fields. Find where `concept`, `ambition`, `desire` are displayed and add a section for background:
```html
<div class="mb-3">
    <label class="form-label fw-bold">Background/Backstory</label>
    <div class="border rounded p-2" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;" id="detail-background">
        <!-- Populated by JS -->
    </div>
</div>
```
In the JavaScript that populates the detail view from the API response, add: `document.getElementById('detail-background').textContent = data.bio.background || 'No background provided';`

Also display rejection history if the character has been rejected before:
```html
<div class="mb-3" id="rejection-history-section" style="display: none;">
    <label class="form-label fw-bold text-danger">Previous Rejection Notes</label>
    <div class="border border-danger rounded p-2" id="detail-rejection-notes"></div>
    <small class="text-muted">Rejected <span id="detail-rejection-count">0</span> time(s)</small>
</div>
```
Show this section only when `rejection_count > 0`.

**3. Replace window.prompt() rejection with a proper Bootstrap modal.**
Find the reject button handler. Currently it uses `window.prompt('Enter rejection reason:')` or similar. Replace with a Bootstrap 5 modal:

Add the modal HTML before the closing `</body>` or in a suitable location:
```html
<div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectionModalLabel">Reject Character</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Rejecting: <strong id="reject-char-name"></strong></p>
        <div class="mb-3">
          <label for="rejection-notes-input" class="form-label">Rejection Notes (required)</label>
          <textarea class="form-control" id="rejection-notes-input" rows="5"
                    placeholder="Explain what needs to be changed..."></textarea>
          <div class="form-text">These notes will be visible to the player when they edit and resubmit.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-reject-btn">Reject Character</button>
      </div>
    </div>
  </div>
</div>
```

Update the reject button click handler to:
- Store the character ID being rejected in a variable (e.g., `window._rejectingCharId = characterId`)
- Set `#reject-char-name` text to the character's name
- Show the modal: `new bootstrap.Modal(document.getElementById('rejectionModal')).show()`
- Clear the textarea

Add a click handler on `#confirm-reject-btn` that:
- Gets the notes from the textarea
- Validates that notes are not empty (show alert if empty)
- Sends the POST to `/api/traits/character/${window._rejectingCharId}/approval/` with `{action: 'reject', notes: notes}`
- On success: close modal, refresh the pending list, show success toast/alert
- On error: show error message

**4. Update the approve action to show placement confirmation.**
After a successful approve API call, the response doesn't change, but add a visual confirmation that the character was placed: `alert('Character approved and placed in starting room!')` or a Bootstrap toast.

IMPORTANT: The existing HTML uses Bootstrap 5.1.3. Use Bootstrap's JS modal API (`new bootstrap.Modal(...)`) not jQuery. The frontend is vanilla JS -- do NOT introduce jQuery.
  </action>
  <verify>
Open character_approval.html in a text editor and verify:
- Search for `rejectionModal` -- modal HTML exists
- Search for `confirm-reject-btn` -- click handler exists
- Search for `window.prompt` -- should NOT appear (replaced by modal)
- Search for `detail-background` -- background display section exists
- Search for `rejection-history-section` -- rejection history section exists
- Search for `badge` -- status badges exist in pending list
  </verify>
  <done>Staff approval page has: proper rejection notes modal (replaces prompt()), background/backstory display in character detail, status badges on pending list, rejection history display for previously-rejected characters.</done>
</task>

<task type="auto">
  <name>Task 2: Update character_creation.html with edit mode, background field, draft save, and resubmission</name>
  <files>beckonmu/web/templates/character_creation.html</files>
  <action>
Read `beckonmu/web/templates/character_creation.html` (1,471 lines) in full first. This is a large file with extensive JavaScript. Make these targeted changes:

**1. Add Background/Backstory textarea to the form (CHAR-02).**
Find the section where concept, ambition, desire fields are defined (look for the "Character Concept" or "Background" step/section). Add a new form field:
```html
<div class="mb-3">
    <label for="background" class="form-label">Background / Backstory</label>
    <textarea class="form-control" id="background" name="background" rows="6"
              placeholder="Write your character's backstory here. This is free-text and will be reviewed by staff."
              maxlength="5000"></textarea>
    <div class="form-text">Optional but recommended. Tell us about your character's history, personality, and motivations.</div>
</div>
```
Place it AFTER the desire field and BEFORE the form submission area.

Make sure the form submission JavaScript includes `background` in the character_data payload sent to the API. Find where `character_data` object is constructed (look for `ambition`, `desire`, `concept` being gathered from form fields) and add:
```javascript
character_data.background = document.getElementById('background').value;
```

**2. Add edit mode for rejected characters (CHAR-01).**
The Django template context now includes `edit_character_id` (from Plan 02). Add a template variable injection at the top of the script section:
```javascript
// Django template variable injection
const editCharacterId = {{ edit_character_id|default:"null" }};
let isEditMode = false;
```

On page load (in the DOMContentLoaded handler or equivalent initialization), check if `editCharacterId` is set:
```javascript
if (editCharacterId) {
    isEditMode = true;
    loadCharacterForEdit(editCharacterId);
}
```

Add the `loadCharacterForEdit` function:
```javascript
async function loadCharacterForEdit(charId) {
    try {
        const response = await fetch(`/api/traits/character/${charId}/for-edit/`, {
            headers: {'X-CSRFToken': getCsrfToken()}
        });
        if (!response.ok) {
            const err = await response.json();
            alert('Cannot edit: ' + (err.error || 'Unknown error'));
            return;
        }
        const data = await response.json();

        // Show rejection notes banner
        if (data.rejection_notes) {
            showRejectionBanner(data.rejection_notes, data.rejection_count);
        }

        // Populate form with existing data
        populateFormFromCharacterData(data.character_data);

        // Change submit button text
        const submitBtn = document.querySelector('[type="submit"]') || document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.textContent = 'Resubmit Character';
        }

        // Update page title
        document.querySelector('h1, .page-title')?.textContent = 'Edit & Resubmit Character';
    } catch (err) {
        console.error('Error loading character for edit:', err);
        alert('Failed to load character data.');
    }
}
```

Add the rejection banner function:
```javascript
function showRejectionBanner(notes, count) {
    const banner = document.createElement('div');
    banner.className = 'alert alert-danger mb-4';
    banner.innerHTML = `
        <h5 class="alert-heading">Character Requires Revisions</h5>
        <p><strong>Staff feedback:</strong></p>
        <p style="white-space: pre-wrap;">${escapeHtml(notes)}</p>
        <hr>
        <small>This character has been rejected ${count} time(s). Please address the feedback and resubmit.</small>
    `;
    // Insert at the top of the form or main content area
    const form = document.querySelector('form') || document.querySelector('.container');
    form.insertBefore(banner, form.firstChild);
}
```

Add an `escapeHtml` utility if one doesn't exist:
```javascript
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
```

Add `populateFormFromCharacterData(data)` function that sets all form field values from the API response. This mirrors the form construction in reverse. Map the character_data fields to form element IDs:
- `data.name` -> `#full_name` or `#character_name` (check actual form field ID)
- `data.concept` -> `#concept`
- `data.clan` -> `#clan` (may be a select)
- `data.ambition` -> `#ambition`
- `data.desire` -> `#desire`
- `data.sire` -> `#sire`
- `data.generation` -> `#generation`
- `data.predator_type` -> `#predator_type` (may be a select)
- `data.background` -> `#background`
- For traits (attributes, skills, disciplines, advantages, flaws): iterate the trait data from export and set the corresponding values in the form's internal state variables (traitValues, disciplineValues, etc.)
- After setting values, trigger any UI update functions so dots/displays refresh

CHECK the actual form field IDs by reading the HTML before writing this function. The IDs may differ from what's listed here.

**3. Modify form submission to handle resubmission (CHAR-01).**
Find the form submission handler (the function that POSTs to `/api/traits/character/create/`). Wrap it in a conditional:
```javascript
if (isEditMode && editCharacterId) {
    // Resubmit to the resubmit endpoint
    const response = await fetch(`/api/traits/character/${editCharacterId}/resubmit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({character_data: characterData})
    });
    // ... handle response, clear draft, show success
} else {
    // Original create flow (existing code)
    // ... existing POST to /api/traits/character/create/
}
```
On successful resubmission: clear the draft from localStorage, show success message ("Character resubmitted for approval!"), and redirect to a character list page or show a confirmation.

**4. Add draft save/resume via localStorage (CHAR-05).**
Add draft save/load functions. Key drafts by context:
- Edit mode: `chargen_draft_${editCharacterId}`
- New character: `chargen_draft_new`

```javascript
function getDraftKey() {
    return isEditMode ? `chargen_draft_${editCharacterId}` : 'chargen_draft_new';
}

function saveDraft() {
    const draft = {
        full_name: document.getElementById('full_name')?.value || '',
        concept: document.getElementById('concept')?.value || '',
        clan: document.getElementById('clan')?.value || '',
        ambition: document.getElementById('ambition')?.value || '',
        desire: document.getElementById('desire')?.value || '',
        sire: document.getElementById('sire')?.value || '',
        generation: document.getElementById('generation')?.value || '',
        predator_type: document.getElementById('predator_type')?.value || '',
        background: document.getElementById('background')?.value || '',
        // Include internal state for trait dots
        savedAt: new Date().toISOString(),
    };

    // Save trait state if the variables exist
    if (typeof traitValues !== 'undefined') draft.traitValues = {...traitValues};
    if (typeof disciplineValues !== 'undefined') draft.disciplineValues = {...disciplineValues};
    if (typeof advantageValues !== 'undefined') draft.advantageValues = {...advantageValues};
    if (typeof flawValues !== 'undefined') draft.flawValues = {...flawValues};
    if (typeof attributePriorities !== 'undefined') draft.attributePriorities = {...attributePriorities};
    if (typeof skillPriorities !== 'undefined') draft.skillPriorities = {...skillPriorities};

    try {
        localStorage.setItem(getDraftKey(), JSON.stringify(draft));
    } catch (e) {
        console.warn('Draft save failed:', e);
    }
}

function loadDraft() {
    try {
        const saved = localStorage.getItem(getDraftKey());
        if (!saved) return;
        const draft = JSON.parse(saved);
        const savedDate = new Date(draft.savedAt);
        const ageMinutes = (Date.now() - savedDate.getTime()) / 60000;

        // Don't offer drafts older than 7 days
        if (ageMinutes > 10080) {
            localStorage.removeItem(getDraftKey());
            return;
        }

        if (confirm(`Resume draft from ${savedDate.toLocaleString()}?`)) {
            applyDraftToForm(draft);
        } else {
            localStorage.removeItem(getDraftKey());
        }
    } catch (e) {
        console.warn('Draft load failed:', e);
    }
}

function applyDraftToForm(draft) {
    // Set simple form fields
    const fields = ['full_name', 'concept', 'clan', 'ambition', 'desire', 'sire', 'generation', 'predator_type', 'background'];
    for (const field of fields) {
        const el = document.getElementById(field);
        if (el && draft[field]) {
            el.value = draft[field];
            // Trigger change event for any listeners
            el.dispatchEvent(new Event('change', {bubbles: true}));
        }
    }

    // Restore trait state variables
    if (draft.traitValues && typeof traitValues !== 'undefined') Object.assign(traitValues, draft.traitValues);
    if (draft.disciplineValues && typeof disciplineValues !== 'undefined') Object.assign(disciplineValues, draft.disciplineValues);
    if (draft.advantageValues && typeof advantageValues !== 'undefined') Object.assign(advantageValues, draft.advantageValues);
    if (draft.flawValues && typeof flawValues !== 'undefined') Object.assign(flawValues, draft.flawValues);

    // Trigger UI refresh for trait displays
    if (typeof updateAllDisplays === 'function') updateAllDisplays();
    if (typeof refreshTraitUI === 'function') refreshTraitUI();
}

function clearDraft() {
    localStorage.removeItem(getDraftKey());
}
```

Wire up the draft system:
- On DOMContentLoaded (BEFORE edit mode check): call `loadDraft()` only if NOT in edit mode (edit mode loads from server, not localStorage)
- Set up auto-save interval: `setInterval(saveDraft, 30000);` (every 30 seconds)
- Add blur listeners to key fields: `document.querySelectorAll('input, textarea, select').forEach(el => el.addEventListener('blur', saveDraft));`
- On successful form submission (both create and resubmit): call `clearDraft()`

IMPORTANT NOTES:
- Check the actual JavaScript variable names for trait state. The form may use different names than `traitValues`, `disciplineValues`, etc. Read the existing JS to find the right variable names.
- The form likely already has a CSRF token getter function (e.g., `getCsrfToken()` or reads from a cookie). Use the existing one, do not create a duplicate.
- Check if there is an existing `DOMContentLoaded` listener or an init function -- add draft loading to the existing one rather than creating a second listener.
- The form may use steps/wizard navigation. Background field should be in the appropriate step (likely the "Bio" or "Background" step).
  </action>
  <verify>
Open character_creation.html in a text editor and verify:
- Search for `background` -- textarea field exists in form
- Search for `editCharacterId` or `edit_character_id` -- Django template variable injection exists
- Search for `loadCharacterForEdit` -- function exists
- Search for `populateFormFromCharacterData` -- function exists
- Search for `showRejectionBanner` -- function exists
- Search for `resubmit` -- resubmission fetch call exists
- Search for `saveDraft` -- draft save function exists
- Search for `loadDraft` -- draft load function exists
- Search for `clearDraft` -- draft clear function exists
- Search for `chargen_draft` -- localStorage key pattern used
- Search for `setInterval.*saveDraft` -- auto-save timer exists
  </verify>
  <done>Character creation form has: background/backstory textarea (CHAR-02), edit mode that loads rejected character data and shows rejection notes banner (CHAR-01), resubmission flow that POSTs to /resubmit/ endpoint (CHAR-01), draft auto-save to localStorage every 30s (CHAR-05), draft resume prompt on page load (CHAR-05), draft cleared on successful submit (CHAR-05), drafts keyed by character ID to prevent cross-contamination (CHAR-05).</done>
</task>

</tasks>

<verification>
1. character_approval.html: Rejection uses modal textarea, not window.prompt()
2. character_approval.html: Background/backstory visible in character detail view
3. character_approval.html: Status badges (Submitted/Rejected) on pending list
4. character_approval.html: Rejection history shown for previously-rejected characters
5. character_creation.html: Background textarea is part of the form and included in submission data
6. character_creation.html: URL with ?edit=<id> triggers edit mode, loads character data from API
7. character_creation.html: Edit mode shows rejection notes banner and "Resubmit" button
8. character_creation.html: Resubmission POSTs to /api/traits/character/<id>/resubmit/
9. character_creation.html: Draft saves to localStorage every 30 seconds
10. character_creation.html: Page load offers to resume draft (when not in edit mode)
11. character_creation.html: Draft cleared after successful submission
12. character_creation.html: Draft keyed by character ID (edit) vs "new" (create)
</verification>

<success_criteria>
- Staff can reject a character with detailed notes via a proper modal (not prompt())
- Staff can see character background and rejection history during review
- Player can navigate to /character-creation/?edit=<id> and see their rejected character pre-filled
- Player sees staff rejection feedback prominently
- Player can edit and resubmit without starting over (CHAR-01 complete)
- Player can write a background as part of character creation (CHAR-02 frontend complete)
- Player can save progress and resume later (CHAR-05 complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-character-approval-completion/02-03-SUMMARY.md`
</output>
