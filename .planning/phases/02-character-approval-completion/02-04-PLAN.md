---
phase: 02-character-approval-completion
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Player whose character was rejected can see rejection notes, edit, and resubmit"
    - "Player can write a free-text background as part of character creation"
    - "Approved character appears in the starting room"
    - "Player receives notification on login when character is approved or rejected"
    - "Player can save draft and resume later"
  artifacts: []
  key_links: []
---

<objective>
Run the database migration and verify the complete character approval lifecycle end-to-end: new character creation with background, staff rejection with notes, player resubmission, staff approval with auto-placement, notification delivery, and draft save/resume.

Purpose: This is the final verification for Phase 2 -- confirming all five requirements (CHAR-01 through CHAR-05) work together as a complete workflow. Also runs the pending migration from Plan 01.

Output: Migration applied, all requirements verified working.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character-approval-completion/02-RESEARCH.md
@.planning/phases/02-character-approval-completion/02-01-SUMMARY.md
@.planning/phases/02-character-approval-completion/02-02-SUMMARY.md
@.planning/phases/02-character-approval-completion/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run migration and automated verification checks</name>
  <files></files>
  <action>
1. Apply the database migration:
   ```
   cd C:/Users/dasbl/PycharmProjects/TheBeckoningMU
   .venv/Scripts/python.exe beckonmu/manage.py migrate traits
   ```
   Verify output shows the migration applied successfully.

2. Verify the model has the correct fields:
   ```python
   .venv/Scripts/python.exe -c "
   import django; import os
   os.environ['DJANGO_SETTINGS_MODULE'] = 'server.conf.settings'
   os.chdir('beckonmu')
   django.setup()
   from traits.models import CharacterBio
   fields = [f.name for f in CharacterBio._meta.get_fields()]
   print('Fields:', fields)
   assert 'status' in fields, 'Missing status field'
   assert 'background' in fields, 'Missing background field'
   assert 'rejection_notes' in fields, 'Missing rejection_notes field'
   assert 'rejection_count' in fields, 'Missing rejection_count field'
   assert 'approved' not in [f.name for f in CharacterBio._meta.concrete_fields], 'approved should be a property not a field'
   print('Model fields: PASS')
   "
   ```

3. Verify all imports work:
   ```python
   .venv/Scripts/python.exe -c "
   import django; import os
   os.environ['DJANGO_SETTINGS_MODULE'] = 'server.conf.settings'
   os.chdir('beckonmu')
   django.setup()
   from traits.api import MyCharactersAPI, CharacterEditDataAPI, CharacterResubmitAPI, notify_account, place_approved_character
   from typeclasses.accounts import Account
   print('All imports: PASS')
   "
   ```

4. Verify no `bio.approved = ` assignment pattern exists in Python files:
   ```
   grep -rn "bio\.approved\s*=" beckonmu/traits/api.py beckonmu/commands/chargen.py
   ```
   Should return zero results (only `bio.status = ` should exist for writes).

5. Verify `text=comment_text` bug is fixed in chargen.py:
   ```
   grep -n "text=comment_text" beckonmu/commands/chargen.py
   ```
   Should return zero results (should be `content=comment_text`).

6. Verify URL routing:
   ```python
   .venv/Scripts/python.exe -c "
   import django; import os
   os.environ['DJANGO_SETTINGS_MODULE'] = 'server.conf.settings'
   os.chdir('beckonmu')
   django.setup()
   from django.urls import reverse
   print(reverse('traits:my_characters'))
   print(reverse('traits:character_for_edit', kwargs={'character_id': 1}))
   print(reverse('traits:character_resubmit', kwargs={'character_id': 1}))
   print('URL routing: PASS')
   "
   ```

7. Verify Account has at_post_login:
   ```
   grep -n "at_post_login" beckonmu/typeclasses/accounts.py
   ```
   Should find the method definition.

8. Verify frontend changes exist:
   ```
   grep -c "rejectionModal" beckonmu/web/templates/character_approval.html
   grep -c "editCharacterId\|edit_character_id" beckonmu/web/templates/character_creation.html
   grep -c "saveDraft\|loadDraft" beckonmu/web/templates/character_creation.html
   grep -c "background" beckonmu/web/templates/character_creation.html
   ```
   All should return non-zero counts.
  </action>
  <verify>All automated checks pass (migration applied, model fields correct, imports work, no stale bio.approved writes, URLs resolve, frontend markers present).</verify>
  <done>Migration applied and all automated verification checks pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete character approval lifecycle: new character creation with background field, staff rejection with notes modal, player resubmission of rejected characters, staff approval with auto-placement in starting room, offline notification delivery on login, and draft save/resume via localStorage.</what-built>
  <how-to-verify>
Start the Evennia server if not running: `evennia start`

**Test 1: New Character Creation with Background (CHAR-02, CHAR-05)**
1. Open http://localhost:4001/character-creation/ as a player
2. Fill in character name, concept, clan, etc.
3. Verify a Background/Backstory textarea exists -- write some text in it
4. Partially fill the form, wait 30 seconds or change focus away from a field
5. Close the browser tab, reopen http://localhost:4001/character-creation/
6. Verify it prompts to resume your draft (CHAR-05)
7. Accept the draft -- verify your data is restored
8. Complete the form and submit
9. Verify draft is cleared (reopen page -- no resume prompt)

**Test 2: Staff Rejection with Notes (CHAR-01, CHAR-04)**
1. Open http://localhost:4001/staff/character-approval/ as staff
2. Verify the pending list shows the new character with a "Submitted" badge
3. Click the character to review -- verify Background/Backstory is visible
4. Click Reject -- verify a modal with a textarea appears (NOT a browser prompt)
5. Write rejection notes and confirm
6. Verify the character shows as "Rejected" in the pending list

**Test 3: Player Resubmission (CHAR-01)**
1. As the player, verify the character shows as rejected (check /api/traits/my-characters/)
2. Navigate to /character-creation/?edit=<character_id>
3. Verify rejection notes banner is displayed at the top
4. Verify form is pre-populated with the character's existing data
5. Verify submit button says "Resubmit"
6. Make an edit (change concept or background)
7. Click Resubmit -- verify success message

**Test 4: Staff Approval with Auto-Placement (CHAR-03)**
1. As staff, refresh the approval page -- the resubmitted character should show as "Submitted" again
2. Approve the character
3. Log into the MUD client at localhost:4000 as the character's player
4. Puppet the approved character -- verify it is in the starting room (not location=None)

**Test 5: Notification on Login (CHAR-04)**
1. If you were logged out during approval, log in now
2. Verify you see a notification about the character being approved
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Phase 2 is complete when all five success criteria from the roadmap are verified:
1. CHAR-01: Player can see rejection notes, edit, and resubmit without starting over
2. CHAR-02: Player can write a free-text background/backstory
3. CHAR-03: Approved character appears in starting room
4. CHAR-04: Player receives notification on approval/rejection (online or offline)
5. CHAR-05: Player can save partial progress and resume later
</verification>

<success_criteria>
All five roadmap success criteria pass human verification.
</success_criteria>

<output>
After completion, create `.planning/phases/02-character-approval-completion/02-04-SUMMARY.md`
</output>
