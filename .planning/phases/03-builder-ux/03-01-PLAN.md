---
phase: 03-builder-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/web/templates/builder/editor.html
  - beckonmu/web/builder/views.py
autonomous: true

must_haves:
  truths:
    - "Builder can see direction labels (N/S/E/W/NE/NW/SE/SW/U/D) on exits between rooms"
    - "Creating an exit auto-assigns cardinal direction name and aliases based on grid position"
    - "Map canvas shows a compass/orientation indicator in the corner"
    - "Direction calculation handles all 8 compass directions plus up/down"
    - "Conflicting direction names are handled gracefully (numbered suffix or manual override)"
  artifacts:
    - path: "beckonmu/web/templates/builder/editor.html"
      provides: "Canvas compass rose overlay, exit direction labels, orientation indicator widget"
      min_lines: 50
    - path: "beckonmu/web/builder/views.py"
      provides: "API endpoint for direction calculation logic (if server-side needed)"
      exports: ["calculate_direction"]
  key_links:
    - from: "editor.html canvas rendering"
      to: "exit line SVG elements"
      via: "drawExitLines() adds direction labels"
      pattern: "text.*direction.*label"
    - from: "createExit()"
      to: "auto-naming logic"
      via: "calculateDirectionFromGrid() function"
      pattern: "grid.*delta.*direction"
---

<objective>
Add compass rose visualization, exit auto-naming, and map orientation indicator to the builder editor.

Purpose: Builders can orient their maps spatially and exits automatically get meaningful direction names based on their grid position, making the editor faster and more intuitive.

Output: Enhanced editor.html with compass visualization, direction calculation logic, and orientation widget.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-builder-ux/03-CONTEXT.md
@.planning/REQUIREMENTS.md

**Existing builder code:**
- beckonmu/web/templates/builder/editor.html â€” Main builder UI with canvas, room nodes, exit lines
- beckonmu/web/builder/views.py â€” API endpoints (TemplatesView currently returns 501)
- beckonmu/web/builder/models.py â€” BuildProject with map_data JSON field

**Key existing structures:**
- Room: {id, name, description, grid_x, grid_y, v5: {...}, triggers: [], builder_notes: ''}
- Exit: {name, aliases: [], source, target, description, locks: ''}
- Grid system: GRID_SIZE = 20px, rooms snap to grid
- Exit rendering: SVG lines between room centers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add direction calculation utility</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Add a JavaScript function `calculateDirectionFromGrid(sourceRoom, targetRoom)` that:
1. Calculates delta_x = target.grid_x - source.grid_x
2. Calculates delta_y = target.grid_y - source.grid_y
3. Maps (delta_x, delta_y) to direction names:
   - (0, -1) â†’ North / n
   - (0, 1) â†’ South / s
   - (1, 0) â†’ East / e
   - (-1, 0) â†’ West / w
   - (1, -1) â†’ Northeast / ne
   - (-1, -1) â†’ Northwest / nw
   - (1, 1) â†’ Southeast / se
   - (-1, 1) â†’ Southwest / sw
   - For non-cardinal deltas, use closest match or "exit" as fallback
4. Returns object: {name: string, aliases: string[], direction: string}

Add this function in the &lt;script&gt; section of editor.html, before the createExit function.

Include a reverse mapping for the opposite direction (for bidirectional exits):
- North â†” South, East â†” West, etc.
  </action>
  <verify>
Open browser console on builder editor page and test:
```javascript
calculateDirectionFromGrid({grid_x: 0, grid_y: 0}, {grid_x: 0, grid_y: -1})
// Should return {name: "north", aliases: ["n"], direction: "north"}
```
  </verify>
  <done>
Direction calculation function exists and correctly maps all 8 compass directions plus handles edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-name exits on creation</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Modify the `createExit(sourceId, targetId)` function to:
1. Call calculateDirectionFromGrid() with source and target rooms
2. Set exit.name to the calculated direction name (lowercase)
3. Set exit.aliases to the calculated aliases array
4. Store exit.direction = calculated direction (for compass display)
5. Also create the reverse exit automatically (bidirectional):
   - Calculate opposite direction using reverse mapping
   - Create second exit entry with source/target swapped
   - Name it with the opposite direction

Update the exit data structure in mapData.exits to include direction field.

Add a visual indicator during exit creation mode showing which direction will be assigned (optional but helpful).
  </action>
  <verify>
1. Create two rooms in builder
2. Click "+ Exit" mode
3. Click source room then target room
4. Check browser console: mapData.exits should show:
   - Exit with name="north" or appropriate direction
   - aliases array like ["n"]
   - direction field set
   - Two exits created (bidirectional)
  </verify>
  <done>
Creating an exit automatically assigns direction name and aliases based on grid position, and creates bidirectional exits.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add compass rose overlay on exit lines</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Modify the `drawExitLines()` function to add direction labels:
1. For each exit line, calculate midpoint: (x1+x2)/2, (y1+y2)/2
2. Create SVG text element at midpoint showing the direction abbreviation
3. Style: small font (10px), centered, contrasting color (#ccc or #888)
4. Add small background rect behind text for readability if needed
5. Only show label if exit has a direction field set

Add CSS for exit labels:
```css
.exit-label {
    font-size: 10px;
    fill: #ccc;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
}
```

Consider adding arrowheads to exit lines to show direction (optional enhancement).
  </action>
  <verify>
Load builder with existing project containing exits:
1. Each exit line should have a direction label at its midpoint
2. Labels should be readable (n, s, e, w, ne, nw, se, sw)
3. Labels should not interfere with room selection
  </verify>
  <done>
Exit lines display direction labels at their midpoints, clearly showing which direction each exit represents.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add map orientation indicator widget</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Add a compass/orientation indicator widget to the canvas:
1. Position: top-right corner of canvas area (absolute positioned)
2. Design: Simple compass rose with N/S/E/W labels
3. Implementation options (choose simplest that looks good):
   - CSS-based: 4 text labels arranged in compass pattern
   - SVG: Small compass rose graphic
   - Unicode: ðŸ¡… ðŸ¡‡ ðŸ¡„ ðŸ¡† arrows with labels

Add HTML in canvas-area div (after canvas-toolbar):
```html
<div class="orientation-widget">
    <div class="compass-rose">
        <span class="compass-n">N</span>
        <span class="compass-s">S</span>
        <span class="compass-e">E</span>
        <span class="compass-w">W</span>
    </div>
</div>
```

Add CSS:
```css
.orientation-widget {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--builder-panel);
    border: 1px solid var(--builder-border);
    border-radius: 4px;
    padding: 10px;
    z-index: 100;
}
.compass-rose {
    position: relative;
    width: 60px;
    height: 60px;
}
.compass-rose span {
    position: absolute;
    font-size: 12px;
    font-weight: bold;
    color: var(--builder-text);
}
.compass-n { top: 0; left: 50%; transform: translateX(-50%); }
.compass-s { bottom: 0; left: 50%; transform: translateX(-50%); }
.compass-e { right: 0; top: 50%; transform: translateY(-50%); }
.compass-w { left: 0; top: 50%; transform: translateY(-50%); }
```

Optional: Add a small indicator showing "North is up" to clarify orientation.
  </action>
  <verify>
Load builder editor:
1. Compass widget visible in top-right corner
2. Shows N/S/E/W clearly
3. Styling matches dark theme of builder
4. Does not obstruct canvas interaction
  </verify>
  <done>
Map orientation indicator widget is visible on canvas, showing cardinal directions to help builders orient their maps.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] Direction calculation returns correct values for all 8 directions
- [ ] createExit() populates name, aliases, and direction fields
- [ ] Bidirectional exits are created with opposite directions
- [ ] drawExitLines() renders direction labels on SVG
- [ ] Compass widget renders in top-right corner

**Manual verification:**
- [ ] Create rooms at various grid positions
- [ ] Create exits in each direction (N, S, E, W, NE, NW, SE, SW)
- [ ] Verify exit names match expected directions
- [ ] Verify direction labels appear on exit lines
- [ ] Verify compass widget is visible and clear
</verification>

<success_criteria>
1. All 8 compass directions (N/S/E/W/NE/NW/SE/SW) can be auto-assigned based on grid position
2. Exit creation automatically sets name and aliases (e.g., "north" with alias "n")
3. Bidirectional exits are created automatically with opposite directions
4. Direction labels appear on exit lines in the canvas
5. Compass orientation widget is visible in canvas corner
6. Builder can visually understand map orientation at a glance
</success_criteria>

<output>
After completion, create `.planning/phases/03-builder-ux/03-01-SUMMARY.md`
</output>
