---
phase: 03-builder-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/web/builder/views.py
  - beckonmu/web/templates/builder/editor.html
autonomous: true

must_haves:
  truths:
    - "Builder can apply V5 room templates (Elysium, Haven, Rack, etc.) to any room"
    - "Templates pre-fill all V5 room settings (location_type, day_night, danger_level, etc.)"
    - "Template dropdown is available in the room properties panel"
    - "Templates can be applied to both new and existing rooms"
    - "Applying a template shows a preview or confirmation before overwriting"
  artifacts:
    - path: "beckonmu/web/builder/views.py"
      provides: "TemplatesView API endpoint returning V5 room template definitions"
      exports: ["TemplatesView"]
    - path: "beckonmu/web/templates/builder/editor.html"
      provides: "Template dropdown UI, template application logic, V5 settings population"
      min_lines: 30
  key_links:
    - from: "TemplatesView.get()"
      to: "editor.html template dropdown"
      via: "fetch API call on page load"
      pattern: "fetch.*templates"
    - from: "Template selection"
      to: "Room V5 settings"
      via: "applyTemplate() function populates form fields"
      pattern: "document.getElementById.*room-.*\.value"
---

<objective>
Implement V5 room template system with preset configurations for common V5 location types.

Purpose: Builders can quickly apply V5-appropriate settings to rooms using presets (Elysium, Haven, Rack, etc.) instead of manually configuring each setting, speeding up area creation and ensuring lore-appropriate defaults.

Output: Working template API endpoint and editor UI with template dropdown that populates V5 room settings.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-builder-ux/03-CONTEXT.md
@.planning/RESEARCH.md
@.planning/REQUIREMENTS.md

**Existing V5 room settings (from editor.html):**
- location_type: '', 'haven', 'elysium', 'rack', 'hostile', 'neutral', 'mortal', 'supernatural'
- day_night: 'always', 'day_only', 'night_only', 'restricted'
- danger_level: 'safe', 'low', 'moderate', 'high', 'deadly'
- hunting_modifier: -5 to +5
- haven_ratings (when location_type is 'haven'): security, size, luxury, warding (0-5), location_hidden (bool)

**V5 Lore Context for Templates:**
- **Elysium**: Neutral ground where violence is forbidden. Safe, always accessible, neutral danger.
- **Haven**: Vampire's personal sanctuary. High security, restricted access, variable ratings.
- **Rack (Feeding Ground)**: Area for hunting. Night only, moderate danger, positive hunting modifier.
- **Hostile Territory**: Dangerous area controlled by enemies. High/deadly danger, restricted access.
- **Neutral Ground**: Public areas like streets. Safe, always accessible, low danger.
- **Mortal Establishment**: Human businesses. Day/night accessible, safe, low danger.
- **Supernatural Site**: Places of mystical significance. Variable danger, often restricted.

**Current TemplatesView:** Returns {"status": "not_implemented"} — needs full implementation.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define V5 room template presets</name>
  <files>beckonmu/web/builder/views.py</files>
  <action>
Implement the TemplatesView.get() method in beckonmu/web/builder/views.py to return V5 room template definitions.

Add a TEMPLATES dictionary at module level (before the class definitions):

```python
V5_ROOM_TEMPLATES = {
    "elysium": {
        "name": "Elysium",
        "description": "Neutral ground where violence is forbidden. A place of peace among Kindred.",
        "v5": {
            "location_type": "elysium",
            "day_night": "always",
            "danger_level": "safe",
            "hunting_modifier": 0
        }
    },
    "haven": {
        "name": "Haven",
        "description": "A vampire's personal sanctuary and refuge from the outside world.",
        "v5": {
            "location_type": "haven",
            "day_night": "restricted",
            "danger_level": "low",
            "hunting_modifier": 0,
            "haven_ratings": {
                "security": 3,
                "size": 2,
                "luxury": 2,
                "warding": 1,
                "location_hidden": False
            }
        }
    },
    "rack": {
        "name": "Rack (Feeding Ground)",
        "description": "A hunting ground where Kindred feed on mortals. Often dangerous.",
        "v5": {
            "location_type": "rack",
            "day_night": "night_only",
            "danger_level": "moderate",
            "hunting_modifier": 2
        }
    },
    "hostile_territory": {
        "name": "Hostile Territory",
        "description": "Dangerous area controlled by enemies or hostile forces.",
        "v5": {
            "location_type": "hostile",
            "day_night": "restricted",
            "danger_level": "high",
            "hunting_modifier": -2
        }
    },
    "neutral_ground": {
        "name": "Neutral Ground",
        "description": "Public areas like streets and parks. Generally safe but exposed.",
        "v5": {
            "location_type": "neutral",
            "day_night": "always",
            "danger_level": "low",
            "hunting_modifier": 0
        }
    },
    "mortal_establishment": {
        "name": "Mortal Establishment",
        "description": "Human businesses like bars, shops, or restaurants.",
        "v5": {
            "location_type": "mortal",
            "day_night": "always",
            "danger_level": "safe",
            "hunting_modifier": 1
        }
    },
    "supernatural_site": {
        "name": "Supernatural Site",
        "description": "Places of mystical significance or supernatural importance.",
        "v5": {
            "location_type": "supernatural",
            "day_night": "restricted",
            "danger_level": "moderate",
            "hunting_modifier": 0
        }
    },
    "clear": {
        "name": "Clear Template",
        "description": "Reset all V5 settings to defaults.",
        "v5": {
            "location_type": "",
            "day_night": "always",
            "danger_level": "safe",
            "hunting_modifier": 0
        }
    }
}
```

Then implement TemplatesView.get():
```python
class TemplatesView(StaffRequiredMixin, View):
    def get(self, request, *args, **kwargs):
        return JsonResponse({
            "status": "success",
            "templates": V5_ROOM_TEMPLATES
        })
```

Ensure the view requires staff permissions (already has StaffRequiredMixin).
  </action>
  <verify>
Test the API endpoint:
```bash
curl -H "Accept: application/json" http://localhost:4001/builder/api/templates/
```

Should return JSON with all 8 templates and their V5 settings.
  </verify>
  <done>
TemplatesView returns complete V5 room template definitions with lore-appropriate settings for all 8 template types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add template dropdown to room properties</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Add a template selection dropdown to the room properties panel in editor.html.

In the "Basic" section (before or after the Name/Description fields), add:

```html
<div class="form-group">
    <label class="builder-label">Room Template</label>
    <select id="room-template" class="builder-select">
        <option value="">-- Select Template --</option>
        <option value="elysium">Elysium</option>
        <option value="haven">Haven</option>
        <option value="rack">Rack (Feeding Ground)</option>
        <option value="hostile_territory">Hostile Territory</option>
        <option value="neutral_ground">Neutral Ground</option>
        <option value="mortal_establishment">Mortal Establishment</option>
        <option value="supernatural_site">Supernatural Site</option>
        <option value="clear">-- Clear All Settings --</option>
    </select>
    <div id="template-description" class="template-desc"></div>
</div>
```

Add CSS for template description:
```css
.template-desc {
    font-size: 11px;
    color: var(--builder-muted);
    margin-top: 5px;
    font-style: italic;
}
```

Add JavaScript to load templates and handle selection:
```javascript
// Store templates
let roomTemplates = {};

// Load templates on page load
async function loadTemplates() {
    try {
        const response = await fetch("{% url 'builder:templates' %}");
        const result = await response.json();
        if (result.status === 'success') {
            roomTemplates = result.templates;
        }
    } catch (err) {
        console.error('Failed to load templates:', err);
    }
}

// Apply template to current room
function applyTemplate(templateKey) {
    if (!selectedRoomId || !roomTemplates[templateKey]) return;
    
    const template = roomTemplates[templateKey];
    const room = mapData.rooms[selectedRoomId];
    
    // Confirm before applying (unless it's a new room or clear template)
    if (templateKey !== 'clear' && room.v5 && room.v5.location_type) {
        if (!confirm(`Apply "${template.name}" template? This will overwrite current V5 settings.`)) {
            document.getElementById('room-template').value = '';
            return;
        }
    }
    
    // Apply V5 settings
    room.v5 = {...room.v5, ...template.v5};
    
    // Update UI
    document.getElementById('room-location-type').value = room.v5.location_type || '';
    document.getElementById('room-day-night').value = room.v5.day_night || 'always';
    document.getElementById('room-danger').value = room.v5.danger_level || 'safe';
    document.getElementById('room-hunting').value = room.v5.hunting_modifier || 0;
    
    // Update haven section visibility
    toggleHavenSection(room.v5.location_type === 'haven');
    
    // Apply haven ratings if present
    if (room.v5.haven_ratings) {
        document.getElementById('haven-security').value = room.v5.haven_ratings.security || 0;
        document.getElementById('haven-size').value = room.v5.haven_ratings.size || 0;
        document.getElementById('haven-luxury').value = room.v5.haven_ratings.luxury || 0;
        document.getElementById('haven-warding').value = room.v5.haven_ratings.warding || 0;
        document.getElementById('haven-hidden').checked = room.v5.haven_ratings.location_hidden || false;
    }
    
    // Show description
    const descEl = document.getElementById('template-description');
    descEl.textContent = template.description || '';
}

// Bind template dropdown
document.getElementById('room-template').onchange = function(e) {
    if (e.target.value) {
        applyTemplate(e.target.value);
    }
};
```

Call loadTemplates() in the DOMContentLoaded event handler.
  </action>
  <verify>
1. Load builder editor
2. Select a room
3. Template dropdown should be visible in Basic section
4. Selecting a template should populate V5 fields
5. Haven template should show haven ratings section
  </verify>
  <done>
Template dropdown is visible in room properties and selecting a template populates all V5 settings correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add template preview and confirmation</name>
  <files>beckonmu/web/templates/builder/editor.html</files>
  <action>
Enhance the template application with better UX:

1. Add a visual preview of what will change before applying:
```javascript
function showTemplatePreview(templateKey) {
    const template = roomTemplates[templateKey];
    if (!template) return;
    
    const descEl = document.getElementById('template-description');
    let preview = template.description;
    
    // Add settings summary
    const v5 = template.v5;
    preview += `\n\nSettings:\n`;
    preview += `• Type: ${v5.location_type || 'None'}\n`;
    preview += `• Access: ${v5.day_night.replace('_', ' ')}\n`;
    preview += `• Danger: ${v5.danger_level}\n`;
    if (v5.hunting_modifier !== 0) {
        preview += `• Hunting: ${v5.hunting_modifier > 0 ? '+' : ''}${v5.hunting_modifier}\n`;
    }
    
    descEl.textContent = preview;
    descEl.style.whiteSpace = 'pre-line';
}
```

2. Update the onchange handler to show preview on selection, apply on confirmation:
```javascript
document.getElementById('room-template').onchange = function(e) {
    if (e.target.value) {
        showTemplatePreview(e.target.value);
        applyTemplate(e.target.value);
    } else {
        document.getElementById('template-description').textContent = '';
    }
};
```

3. Add a small "Apply Template" button next to the dropdown as an alternative to auto-apply:
```html
<div class="form-group">
    <label class="builder-label">Room Template</label>
    <div class="template-select-row">
        <select id="room-template" class="builder-select">...options...</select>
        <button class="btn btn-sm btn-outline-secondary" onclick="applySelectedTemplate()">Apply</button>
    </div>
    <div id="template-description" class="template-desc"></div>
</div>
```

4. Add CSS for the row layout:
```css
.template-select-row {
    display: flex;
    gap: 8px;
}
.template-select-row .builder-select {
    flex: 1;
}
```

5. Update applySelectedTemplate function to read the dropdown value.
  </action>
  <verify>
1. Select a template from dropdown
2. Description area shows template description and settings summary
3. Clicking Apply button applies the template
4. Template correctly populates all V5 fields including haven ratings when applicable
  </verify>
  <done>
Template selection shows preview with description and settings summary, and applies correctly with user confirmation for existing rooms.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- [ ] TemplatesView returns all 8 templates with complete V5 settings
- [ ] Template JSON structure matches expected format
- [ ] API endpoint requires staff authentication

**Manual verification:**
- [ ] Load builder editor and select a room
- [ ] Template dropdown shows all 8 options
- [ ] Selecting each template shows correct preview
- [ ] Applying Elysium template sets: location_type=elysium, day_night=always, danger_level=safe
- [ ] Applying Haven template shows haven ratings section with values
- [ ] Applying Rack template sets: location_type=rack, day_night=night_only, hunting_modifier=2
- [ ] Clear template resets all settings to defaults
- [ ] Applying template to room with existing settings shows confirmation dialog
</verification>

<success_criteria>
1. TemplatesView API returns 8 V5 room templates (Elysium, Haven, Rack, Hostile Territory, Neutral Ground, Mortal Establishment, Supernatural Site, Clear)
2. Each template has lore-appropriate default settings for all V5 fields
3. Template dropdown is visible in room properties Basic section
4. Selecting a template shows description and settings preview
5. Applying a template populates all V5 fields correctly
6. Haven template shows and populates haven ratings section
7. Clear template resets all settings to defaults
8. Existing room settings are preserved until user confirms template application
</success_criteria>

<output>
After completion, create `.planning/phases/03-builder-ux/03-02-SUMMARY.md`
</output>
