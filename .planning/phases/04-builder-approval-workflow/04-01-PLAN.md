---
phase: 04-builder-approval-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/web/builder/models.py
  - beckonmu/web/builder/views.py
  - beckonmu/web/builder/urls.py
  - beckonmu/web/templates/builder/dashboard.html
  - beckonmu/web/templates/builder/review.html
  - beckonmu/web/builder/migrations/0003_buildproject_status_fields.py
autonomous: false
user_setup: []
must_haves:
  truths:
    - Builder can see project status (Draft/Submitted/Approved/Built/Live) on dashboard
    - Builder can submit a Draft project for staff review
    - Staff can view all submitted projects in a dedicated review interface
    - Staff can see map preview of submitted project before approval
    - Staff can approve a project with optional notes
    - Staff can reject a project with required notes explaining why
    - Rejected project returns to Draft status with rejection notes visible to builder
    - Invalid status transitions are blocked (e.g., cannot submit an already-approved project)
  artifacts:
    - path: "beckonmu/web/builder/models.py"
      provides: "BuildProject status field, STATUS_CHOICES, state transition validation"
      contains: ["status field", "can_transition_to method", "submit method", "approve method", "reject method"]
    - path: "beckonmu/web/builder/views.py"
      provides: "SubmitProjectView, BuildReviewView, ApproveRejectProjectView APIs"
      exports: ["SubmitProjectView", "BuildReviewView", "ApproveRejectProjectView"]
    - path: "beckonmu/web/templates/builder/review.html"
      provides: "Staff review interface with project list, map preview, approve/reject modals"
      min_lines: 200
    - path: "beckonmu/web/builder/migrations/0003_buildproject_status_fields.py"
      provides: "Database migration for status, rejection_notes, rejection_count, reviewed_by, reviewed_at fields"
  key_links:
    - from: "beckonmu/web/templates/builder/dashboard.html"
      to: "/builder/api/submit/<id>/"
      via: "fetch POST when Submit button clicked"
      pattern: "fetch.*api/submit"
    - from: "beckonmu/web/templates/builder/review.html"
      to: "/builder/api/review/projects/"
      via: "fetch GET to load submitted projects"
      pattern: "fetch.*api/review/projects"
    - from: "beckonmu/web/templates/builder/review.html"
      to: "/builder/api/review/<id>/approve/"
      via: "fetch POST when Approve button clicked"
      pattern: "fetch.*approve"
    - from: "beckonmu/web/templates/builder/review.html"
      to: "/builder/api/review/<id>/reject/"
      via: "fetch POST when Reject button clicked with notes"
      pattern: "fetch.*reject"
---

<objective>
Implement the builder project approval workflow with state machine, builder submission capability, and staff review interface.

Purpose: Gate potentially destructive building operations behind staff review, matching the pattern established for character approval (Phase 2).

Output: BuildProject status lifecycle (Draft → Submitted → Approved → Built → Live), builder submission from dashboard, staff review page with map preview and approve/reject actions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character-approval-completion/02-01-SUMMARY.md
@.planning/phases/02-character-approval-completion/02-03-SUMMARY.md

@beckonmu/web/builder/models.py
@beckonmu/web/builder/views.py
@beckonmu/web/builder/urls.py
@beckonmu/web/templates/builder/dashboard.html

# CharacterBio status pattern from Phase 2 (follow this exactly):
# STATUS_CHOICES = [
#     ('draft', 'Draft'),
#     ('submitted', 'Submitted'),
#     ('rejected', 'Rejected'),
#     ('approved', 'Approved'),
# ]
# status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='draft')
# rejection_notes = models.TextField(blank=True)
# rejection_count = models.PositiveIntegerField(default=0)
# approved_by = models.CharField(max_length=100, blank=True)
# approved_at = models.DateTimeField(blank=True, null=True)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BuildProject model with status state machine</name>
  <files>beckonmu/web/builder/models.py, beckonmu/web/builder/migrations/0003_buildproject_status_fields.py</files>
  <action>
Add status field and state machine methods to BuildProject model following the CharacterBio pattern from Phase 2.

1. Add STATUS_CHOICES with these states in order:
   - ('draft', 'Draft') - default
   - ('submitted', 'Submitted')
   - ('approved', 'Approved')
   - ('built', 'Built') - sandbox has been created
   - ('live', 'Live') - promoted to production

2. Add these fields to BuildProject:
   - status = CharField(max_length=20, choices=STATUS_CHOICES, default='draft')
   - rejection_notes = TextField(blank=True)
   - rejection_count = PositiveIntegerField(default=0)
   - reviewed_by = ForeignKey to AUTH_USER_MODEL, null=True, blank=True, on_delete=SET_NULL
   - reviewed_at = DateTimeField(null=True, blank=True)
   - submission_notes = TextField(blank=True) - builder's notes when submitting

3. Add state transition validation method:
   - can_transition_to(new_status) -> returns True/False based on valid transitions
   - Valid transitions:
     - draft -> submitted
     - submitted -> approved
     - submitted -> draft (rejection returns to draft)
     - approved -> built
     - built -> live
     - live -> built (demotion, rare but allowed)
     - built -> approved (sandbox deletion)

4. Add transition methods that validate and update:
   - submit() - draft->submitted, clears rejection_notes
   - approve(user) - submitted->approved, sets reviewed_by/reviewed_at
   - reject(user, notes) - submitted->draft, increments rejection_count, sets rejection_notes, sets reviewed_by/reviewed_at
   - mark_built() - approved->built
   - mark_live() - built->live

5. Create migration file 0003_buildproject_status_fields.py with the schema changes.

6. Update __str__ to include status indicator.

Follow the exact pattern from CharacterBio in Phase 2. Use proper help_text on all fields.
  </action>
  <verify>
    - python -c "from beckonmu.web.builder.models import BuildProject; p = BuildProject(); print(p.STATUS_CHOICES); print(p.can_transition_to('submitted'))"
    - evennia migrate --check (verify migration is recognized)
  </verify>
  <done>
    - BuildProject has status field with 5 choices
    - can_transition_to() method validates all valid transitions
    - submit(), approve(), reject(), mark_built(), mark_live() methods exist
    - Migration file created and syntactically valid
  </done>
</task>

<task type="auto">
  <name>Task 2: Add submission and review API endpoints</name>
  <files>beckonmu/web/builder/views.py, beckonmu/web/builder/urls.py</files>
  <action>
Add API endpoints for builder submission and staff review following the patterns from builder/views.py.

1. Add SubmitProjectView (StaffRequiredMixin, View):
   - POST /builder/api/project/<int:pk>/submit/
   - Only owner can submit their own project
   - Validates project is in 'draft' status (use can_transition_to)
   - Calls project.submit() to transition status
   - Accepts optional 'notes' in request body (stored in submission_notes)
   - Returns JSON: {status: 'success', message: 'Project submitted for review'}
   - Returns 400 if invalid transition, 403 if not owner

2. Add BuildReviewView (StaffRequiredMixin, View):
   - GET /builder/api/review/projects/
   - Returns all projects with status='submitted'
   - Response format: {
       status: 'success',
       projects: [
         {
           id, name, description, user: {id, username},
           submission_notes, created_at, updated_at,
           room_count: (count from map_data.rooms),
           exit_count: (count from map_data.exits)
         }
       ]
     }

3. Add ApproveRejectProjectView (StaffRequiredMixin, View):
   - POST /builder/api/review/<int:pk>/approve/
     - Calls project.approve(request.user)
     - Returns {status: 'success', message: 'Project approved'}
   - POST /builder/api/review/<int:pk>/reject/
     - Requires 'notes' in request body (non-empty validation)
     - Calls project.reject(request.user, notes)
     - Returns {status: 'success', message: 'Project rejected with feedback'}
   - Both check project is in 'submitted' status
   - Return 400 if project not in submitted status

4. Update urls.py to add new patterns:
   - path("api/project/<int:pk>/submit/", views.SubmitProjectView.as_view(), name="submit_project")
   - path("api/review/projects/", views.BuildReviewView.as_view(), name="review_projects")
   - path("api/review/<int:pk>/approve/", views.ApproveRejectProjectView.as_view(), name="approve_project")
   - path("api/review/<int:pk>/reject/", views.ApproveRejectProjectView.as_view(), name="reject_project")

Use the same error response format as existing views: {"status": "error", "error": "message"}
Use @method_decorator(staff_member_required) pattern for class-based views.
  </action>
  <verify>
    - python -c "from beckonmu.web.builder.urls import urlpatterns; print([p.name for p in urlpatterns])" | grep -E "(submit|review|approve|reject)"
    - curl -X POST http://localhost:4001/builder/api/project/1/submit/ -H "Content-Type: application/json" -d '{"notes":"Ready for review"}' (test with valid session)
  </verify>
  <done>
    - SubmitProjectView handles POST to /builder/api/project/<pk>/submit/
    - BuildReviewView handles GET to /builder/api/review/projects/
    - ApproveRejectProjectView handles POST to /builder/api/review/<pk>/approve/ and /reject/
    - All endpoints return proper JSON responses
    - URL patterns registered in urls.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Update builder dashboard with status and submission UI</name>
  <files>beckonmu/web/templates/builder/dashboard.html</files>
  <action>
Update the builder dashboard template to show status badges and add submission functionality.

1. Update the Status column in My Projects table:
   - Replace current logic (promoted_at/sandbox_room_id based) with status field
   - Badge colors:
     - draft: bg-secondary (gray)
     - submitted: bg-warning text-dark (yellow)
     - approved: bg-info (blue)
     - built: bg-primary (indigo)
     - live: bg-success (green)
   - Show status display name with capital first letter

2. Add Submit button for draft projects:
   - In Actions column, add "Submit" button only when project.status == 'draft'
   - Use btn-sm btn-outline-success class
   - Add onclick handler: submitProject(projectId, projectName)
   - Include confirmation dialog: "Submit 'Project Name' for staff review? You cannot edit while under review."

3. Add rejection notes display for rejected projects:
   - When status is 'draft' AND rejection_notes is not empty, show:
     - Small text below status badge: "Rejected {{ project.rejection_count }} time(s)"
     - Tooltip or expandable section showing rejection_notes

4. Add JavaScript submitProject function:
   - async function submitProject(id, name)
   - Show confirmation dialog
   - POST to /builder/api/project/${id}/submit/
   - On success: reload page to show updated status
   - On error: alert() with error message from response
   - Include CSRF token in headers (use existing pattern from other templates)

5. Add submission notes modal (optional enhancement):
   - When submitting, allow builder to add optional notes
   - Simple Bootstrap modal with textarea
   - Include notes in POST body

Use vanilla JavaScript (no jQuery) following existing codebase patterns.
Use escapeHtml() utility for XSS protection (copy from character_approval.html if needed).
Preserve all existing functionality (Edit, Export buttons, Public Projects section).
  </action>
  <verify>
    - Open http://localhost:4001/builder/ and verify status badges appear correctly
    - Verify Submit button appears only for draft projects
    - Verify rejection notes display for previously rejected projects
  </verify>
  <done>
    - Status column shows colored badge based on project.status
    - Draft projects have Submit button in Actions column
    - Submit button shows confirmation dialog
    - JavaScript submitProject function handles API call and page reload
    - Rejection notes visible for rejected projects
  </done>
</task>

<task type="auto">
  <name>Task 4: Create staff review page with map preview</name>
  <files>beckonmu/web/templates/builder/review.html, beckonmu/web/builder/views.py, beckonmu/web/builder/urls.py</files>
  <action>
Create the staff review interface page where staff can view submitted projects, preview maps, and approve/reject.

1. Create beckonmu/web/templates/builder/review.html:
   - Extend base.html
   - Title: "Build Review - Staff"
   - Main content:
     - Header: "Submitted Build Projects" with count badge
     - Empty state: "No projects awaiting review" when none submitted
     - Project cards (Bootstrap card layout):
       - Card header: Project name, builder username, submission date
       - Card body:
         - Description (truncated if long)
         - Stats row: X rooms, Y exits, created Z days ago
         - Submission notes (if provided by builder)
       - Map preview canvas (miniature view):
         - Use canvas element (200x150px or similar)
         - Render rooms as small rectangles, exits as lines
         - Simple rendering - no interactivity needed
         - Can reuse rendering logic from editor if possible
       - Card footer:
         - Approve button (btn-success): onclick="approveProject(id, name)"
         - Reject button (btn-outline-danger): onclick="showRejectModal(id, name)"

2. Add Reject Modal (Bootstrap 5):
   - Modal with textarea for rejection notes (required)
   - Character counter (min 10 chars)
   - Submit Rejection button
   - Cancel button

3. Add JavaScript functions:
   - async loadProjects() - GET /builder/api/review/projects/, render cards
   - async approveProject(id, name) - confirmation, POST to approve endpoint, reload
   - showRejectModal(id, name) - show modal, store projectId
   - async submitRejection() - validate notes, POST to reject endpoint, reload
   - renderMiniMap(canvas, map_data) - draw rooms/exits on canvas

4. Add BuildReviewDashboardView in views.py:
   - TemplateView for /builder/review/ URL
   - Use StaffRequiredMixin
   - Template: builder/review.html

5. Add URL pattern:
   - path("review/", views.BuildReviewDashboardView.as_view(), name="build_review")

6. Add navigation link:
   - In dashboard.html, add link to review page for staff users:
     - Check {% if user.is_staff %}
     - Button: "Review Submissions (X)" where X is count of submitted projects

Use Bootstrap 5 styling consistent with other templates.
Use vanilla JavaScript, no jQuery.
Include CSRF token handling for POST requests.
  </action>
  <verify>
    - Navigate to http://localhost:4001/builder/review/ as staff user
    - Verify submitted projects are listed with map preview
    - Test approve and reject functionality
  </verify>
  <done>
    - review.html template exists with project cards and map preview
    - BuildReviewDashboardView renders the page
    - JavaScript loads projects via API and renders them
    - Approve/Reject buttons work with confirmation
    - Reject modal requires notes before submission
    - URL /builder/review/ accessible to staff
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 5: Verify end-to-end builder approval workflow</name>
  <what-built>
Complete builder approval workflow:
1. BuildProject model with status field (draft/submitted/approved/built/live) and state machine
2. API endpoints for submission (/builder/api/project/<id>/submit/) and review (/builder/api/review/)
3. Updated builder dashboard with status badges and Submit button
4. New staff review page at /builder/review/ with map preview and approve/reject actions
  </what-built>
  <how-to-verify>
Test the complete workflow:

1. **Create a test project:**
   - Log in as a builder (staff user)
   - Go to /builder/ and create a new project
   - Verify status shows "Draft" (gray badge)
   - Verify Submit button appears

2. **Test submission:**
   - Click Submit on the draft project
   - Confirm the dialog
   - Verify status changes to "Submitted" (yellow badge)
   - Verify Submit button disappears

3. **Test staff review page:**
   - Go to /builder/review/ as staff
   - Verify the submitted project appears with:
     - Project name and builder username
     - Room/exit counts
     - Map preview canvas showing rooms
   - Click Approve
   - Verify project disappears from review list

4. **Test rejection flow:**
   - Create another project and submit it
   - On review page, click Reject
   - Enter rejection notes (required)
   - Submit rejection
   - Go back to /builder/ as the builder
   - Verify status shows "Draft" with rejection count
   - Verify rejection notes are visible

5. **Test invalid transitions:**
   - Try to submit an already-approved project (should fail gracefully)
   - Try to approve a draft project (should fail)

6. **Verify database:**
   - evennia shell
   - from beckonmu.web.builder.models import BuildProject
   - p = BuildProject.objects.first()
   - print(p.status, p.rejection_count, p.reviewed_by)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Overall phase verification:
- [ ] BuildProject has status field with 5 valid states
- [ ] State machine validates transitions (cannot go draft->approved directly)
- [ ] Builder can submit draft projects via dashboard
- [ ] Staff can view submitted projects at /builder/review/
- [ ] Staff can approve projects (status -> approved)
- [ ] Staff can reject projects with notes (status -> draft, rejection_count++)
- [ ] Rejection notes are visible to builder on dashboard
- [ ] Map preview renders on review page
- [ ] All API endpoints require proper authentication
</verification>

<success_criteria>
Measurable completion:
1. BuildProject model has status, rejection_notes, rejection_count, reviewed_by, reviewed_at fields
2. Valid status transitions enforced by can_transition_to() method
3. /builder/api/project/<id>/submit/ endpoint works for project owners
4. /builder/api/review/projects/ returns submitted projects for staff
5. /builder/api/review/<id>/approve/ and /reject/ endpoints work for staff
6. /builder/review/ page displays submitted projects with map preview
7. Builder dashboard shows status badges and Submit button for drafts
8. End-to-end workflow tested and functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-builder-approval-workflow/04-01-SUMMARY.md`
</output>
