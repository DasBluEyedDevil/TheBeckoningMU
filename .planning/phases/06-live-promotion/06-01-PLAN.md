---
phase: 06-live-promotion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/web/builder/models.py
  - beckonmu/web/builder/promotion.py
  - beckonmu/web/builder/views.py
  - beckonmu/web/builder/urls.py
  - beckonmu/typeclasses/rooms.py
  - beckonmu/web/templates/builder/dashboard.html
autonomous: true

must_haves:
  truths:
    - "Builder can select a connection room and direction before promoting"
    - "Promotion creates exits linking the live world to the new area"
    - "Sandbox rooms are moved (not copied) to live world with all V5 attributes preserved"
    - "Original sandbox is cleaned up after successful promotion"
    - "Project status changes from 'built' to 'live'"
  artifacts:
    - path: "beckonmu/web/builder/promotion.py"
      provides: "Thread-safe promotion engine that moves rooms and creates connection exits"
      exports: ["promote_project_to_live"]
    - path: "beckonmu/web/builder/views.py"
      provides: "Promotion API endpoints for connection room list and promotion trigger"
      exports: ["ListConnectionRoomsView", "PromoteProjectView"]
    - path: "beckonmu/web/builder/models.py"
      provides: "BuildProject fields for connection point storage"
      contains: ["connection_room_id", "connection_direction"]
  key_links:
    - from: "PromoteProjectView"
      to: "promote_project_to_live"
      via: "POST handler calling promotion engine"
    - from: "promote_project_to_live"
      to: "sandbox_cleanup"
      via: "Cleanup called after successful promotion"
    - from: "promotion.py"
      to: "Room.tags"
      via: "Remove 'sandbox' tag, keep 'web_builder' and 'project_{id}' tags"
---

<objective>
Implement the live promotion system that moves tested sandbox builds into the live game world.

Purpose: Builders need a way to connect their tested sandbox areas to the live game world. This plan implements the connection point selection, promotion engine that moves rooms (not copies), and automatic cleanup.

Output: Complete promotion workflow with API endpoints, promotion engine, and UI integration.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sandbox-building/05-02-SUMMARY.md

@beckonmu/web/builder/models.py
@beckonmu/web/builder/sandbox_builder.py
@beckonmu/web/builder/sandbox_cleanup.py
@beckonmu/web/builder/sandbox_bridge.py
@beckonmu/web/builder/views.py
@beckonmu/web/builder/urls.py
@beckonmu/typeclasses/rooms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection point fields to BuildProject model</name>
  <files>beckonmu/web/builder/models.py</files>
  <action>
Add two new fields to BuildProject model for storing the connection point:

1. `connection_room_id` - IntegerField, null=True, blank=True
   - Stores the dbref of the live room to connect to
   
2. `connection_direction` - CharField, max_length=10, null=True, blank=True
   - Stores the direction from live room into the new area (n/s/e/w/ne/nw/se/sw/u/d)

Add these fields after the existing `sandbox_room_id` field. Both should be nullable since they're only set when preparing for promotion.

Create a migration for these fields. The migration should be:
- 0004_buildproject_connection_fields.py (following the existing 0003 migration)

Do NOT modify existing methods like can_transition_to - the built->live transition is already valid.
  </action>
  <verify>
Run: `evennia migrate --check` to verify migration is valid
Check: `python -c "from beckonmu.web.builder.models import BuildProject; print('connection_room_id' in [f.name for f in BuildProject._meta.fields])"`
  </verify>
  <done>
BuildProject model has connection_room_id and connection_direction fields, migration file exists and is valid
  </done>
</task>

<task type="auto">
  <name>Task 2: Create promotion engine module</name>
  <files>beckonmu/web/builder/promotion.py</files>
  <action>
Create `beckonmu/web/builder/promotion.py` with the promotion engine that moves sandbox rooms to live world.

The module should:

1. Import and use `run_in_main_thread` from Evennia (same pattern as sandbox_cleanup.py)

2. Implement `_do_promotion_in_main_thread(project_id, connection_room_id, connection_direction)`:
   - Find all rooms tagged with `project_{project_id}` and `sandbox`
   - Find the connection room (live world room) by dbref
   - Validate no exit already exists in the specified direction from connection room
   - Remove `sandbox` tag from all project rooms (keeps them in live world)
   - Create exit from connection room to the project's entry room (first room or room with lowest ID)
   - Create return exit from project entry room back to connection room (opposite direction)
   - Return dict with: promoted_rooms, created_exits, entry_room_id

3. Implement `promote_project_to_live(project_id, connection_room_id, connection_direction)`:
   - Validate project exists and is in 'built' status
   - Validate project has active sandbox (sandbox_room_id is set)
   - Call `_do_promotion_in_main_thread` via run_in_main_thread with 30s timeout
   - On success: 
     * Call cleanup_sandbox_for_project to delete the sandbox container room
     * Update project status to 'live' via project.mark_live()
     * Set project.promoted_at to timezone.now()
     * Clear project.sandbox_room_id and save
   - Return (success: bool, result: dict)

4. Helper function `_get_opposite_direction(direction)` to map n<->s, e<->w, ne<->sw, nw<->se, u<->d

Use the same threading.Event pattern as sandbox_cleanup.py for synchronization. Handle errors gracefully - if promotion fails partway, rooms remain in live world (partial success) but sandbox is preserved for retry.
  </action>
  <verify>
Check: `python -c "from beckonmu.web.builder.promotion import promote_project_to_live; print('Import successful')"`
Verify module has no syntax errors and all required functions exist.
  </verify>
  <done>
promotion.py exists with promote_project_to_live function, imports work, follows sandbox_cleanup.py patterns
  </done>
</task>

<task type="auto">
  <name>Task 3: Add promotion API endpoints and UI integration</name>
  <files>beckonmu/web/builder/views.py, beckonmu/web/builder/urls.py, beckonmu/typeclasses/rooms.py</files>
  <action>
Add API endpoints for promotion workflow:

**In views.py:**

1. Create `ListConnectionRoomsView` (StaffRequiredMixin):
   - GET endpoint at `/builder/api/connection-rooms/`
   - Returns list of rooms the builder can connect to (rooms they own or have builder permissions on)
   - Query: search_object with typeclass="beckonmu.typeclasses.rooms.Room" 
   - Filter OUT rooms tagged with 'sandbox' (only live world rooms)
   - Return: [{id, name, key, description}] for each room
   - For now, return all non-sandbox rooms (simplification - ownership check can be enhanced later)

2. Create `PromoteProjectView` (StaffRequiredMixin):
   - POST endpoint at `/builder/api/build/{id}/promote/`
   - Request body: {connection_room_id: int, connection_direction: string}
   - Validate project is in 'built' status
   - Validate builder owns the project
   - Call `promote_project_to_live(project_id, connection_room_id, connection_direction)`
   - On success: return {status: "success", message, promoted_rooms, created_exits, entry_room_id}
   - On failure: return {status: "error", error} with appropriate status code

**In urls.py:**
Add URL patterns:
- `path("api/connection-rooms/", ListConnectionRoomsView.as_view(), name="connection_rooms")`
- `path("api/build/<int:pk>/promote/", PromoteProjectView.as_view(), name="promote_project")`

**In typeclasses/rooms.py:**
Enhance the Room.access() method to allow builders to access their own sandbox rooms during promotion. Currently it blocks all non-staff/non-owners from sandbox rooms. Ensure this doesn't break with the promotion flow (rooms will lose 'sandbox' tag during promotion, so they become accessible).

**In builder dashboard HTML (if exists):**
Add promotion UI elements to the project cards/actions:
- "Promote to Live" button visible when project.status == 'built'
- Button opens modal with:
  * Room picker dropdown (populated from /api/connection-rooms/)
  * Direction dropdown (N/S/E/W/NE/NW/SE/SW/U/D with full names)
  * Room count display
  * Confirm/Cancel buttons
- On confirmation, POST to /api/build/{id}/promote/
- Show success/error messages

If the dashboard template doesn't exist or is minimal, just ensure the API endpoints work - the UI can be tested via curl/JS console.
  </action>
  <verify>
Test with curl commands:
1. `curl -H "Content-Type: application/json" http://localhost:4001/builder/api/connection-rooms/` - returns room list
2. `curl -X POST -H "Content-Type: application/json" -d '{"connection_room_id":2,"connection_direction":"n"}' http://localhost:4001/builder/api/build/1/promote/` - triggers promotion (requires auth and built project)
  </verify>
  <done>
API endpoints respond correctly, promotion workflow completes end-to-end, project status changes to 'live', sandbox is cleaned up
  </done>
</task>

</tasks>

<verification>
1. **Model fields:** BuildProject has connection_room_id and connection_direction fields
2. **Promotion engine:** promotion.py exists with promote_project_to_live function
3. **API endpoints:** /api/connection-rooms/ and /api/build/{id}/promote/ work
4. **End-to-end test:** 
   - Create a project, submit, approve, build sandbox
   - Call promote endpoint with connection room and direction
   - Verify: rooms lose 'sandbox' tag, exits created, project status='live', sandbox cleaned up
5. **Error handling:** Promotion with invalid direction or non-existent room returns proper error
</verification>

<success_criteria>
- Builder can select connection room and direction via API/UI
- Promotion moves rooms from sandbox to live (removes 'sandbox' tag)
- Connection exits created between live world and new area (bidirectional)
- Project status changes from 'built' to 'live'
- Sandbox container is cleaned up after successful promotion
- Failed promotion preserves sandbox for retry
- All V5 attributes preserved on promoted rooms
</success_criteria>

<output>
After completion, create `.planning/phases/06-live-promotion/06-01-SUMMARY.md`
</output>
