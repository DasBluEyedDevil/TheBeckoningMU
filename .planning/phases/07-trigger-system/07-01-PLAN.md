---
phase: 07-trigger-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - beckonmu/typeclasses/rooms.py
  - beckonmu/web/builder/trigger_engine.py
  - beckonmu/web/builder/trigger_actions.py
autonomous: true

must_haves:
  truths:
    - "When a character enters a room with an entry trigger, the trigger fires and executes its action"
    - "When a character leaves a room with an exit trigger, the trigger fires and executes its action"
    - "Trigger actions are whitelisted - only predefined safe actions can execute"
    - "Trigger data stored in room.db.triggers is validated before execution"
  artifacts:
    - path: "beckonmu/typeclasses/rooms.py"
      provides: "Room hooks for entry/exit triggers"
      contains: "at_object_receive, at_object_leave with trigger execution"
    - path: "beckonmu/web/builder/trigger_engine.py"
      provides: "Core trigger execution engine"
      exports: ["execute_triggers", "validate_trigger", "TriggerError"]
    - path: "beckonmu/web/builder/trigger_actions.py"
      provides: "Whitelisted trigger action implementations"
      exports: ["send_message", "emit_message", "set_attribute"]
  key_links:
    - from: "beckonmu/typeclasses/rooms.py"
      to: "beckonmu/web/builder/trigger_engine.py"
      via: "import and call execute_triggers"
      pattern: "from.*trigger_engine import"
    - from: "beckonmu/web/builder/trigger_engine.py"
      to: "beckonmu/web/builder/trigger_actions.py"
      via: "action registry lookup and dispatch"
      pattern: "ACTION_REGISTRY\\[action_name\\]"

user_setup: []
---

<objective>
Build the core trigger execution engine with entry/exit triggers and whitelisted actions.

Purpose: Enable rooms to respond dynamically to character movement with safe, predefined actions.
Output: Working entry/exit trigger system with validated trigger data and whitelisted actions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

**Prior Phase Context (Phase 5-6):**
The sandbox bridge layer (`beckonmu/web/builder/sandbox_bridge.py`) provides `run_sync_in_main_thread()` for thread-safe Evennia API calls. Rooms are created with `room.db.triggers = []` storing trigger data from map_data.

**Trigger Data Structure (from sandbox_builder.py:107-109):**
```python
triggers = room_data.get("triggers", [])
if triggers:
    room.db.triggers = triggers
```

**Room Typeclass (`beckonmu/typeclasses/rooms.py`):**
Currently has no entry/exit hooks. Need to add `at_object_receive()` and `at_object_leave()` to call trigger engine.

**Security Requirement (from RESEARCH.md):**
"Trigger system code injection â€” If triggers can contain Python expressions or `@py` commands, builders with web access can inject arbitrary code. Prevention: Whitelist predefined trigger actions. Never use eval/exec."
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trigger actions whitelist module</name>
  <files>beckonmu/web/builder/trigger_actions.py</files>
  <action>
Create `beckonmu/web/builder/trigger_actions.py` with whitelisted trigger actions:

1. `send_message(obj, message)` - Send message to a specific object (character)
2. `emit_message(location, message, exclude=None)` - Emit message to all in location
3. `set_attribute(obj, attr_name, value)` - Set a database attribute on an object

Each action must:
- Accept only primitive types (strings, numbers, booleans, lists)
- Return None (no return values used)
- Have docstring explaining parameters
- Be safe (no file operations, no network calls, no eval/exec)

Define ACTION_REGISTRY dict mapping action names to functions:
```python
ACTION_REGISTRY = {
    "send_message": send_message,
    "emit_message": emit_message,
    "set_attribute": set_attribute,
}
```

Add `list_actions()` function returning list of available action names for UI.
  </action>
  <verify>
Check file exists and has ACTION_REGISTRY with at least 3 actions:
```bash
grep -n "ACTION_REGISTRY" beckonmu/web/builder/trigger_actions.py
grep -n "def send_message\|def emit_message\|def set_attribute" beckonmu/web/builder/trigger_actions.py
```
  </verify>
  <done>
ACTION_REGISTRY defined with 3+ whitelisted actions, all functions have docstrings, no unsafe operations present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create trigger execution engine</name>
  <files>beckonmu/web/builder/trigger_engine.py</files>
  <action>
Create `beckonmu/web/builder/trigger_engine.py` with:

**TriggerError exception class** - Raised for trigger execution errors

**validate_trigger(trigger_data)** function:
- Check required fields: type, action, parameters
- Validate trigger type is one of: "entry", "exit", "timed", "interaction"
- Validate action exists in ACTION_REGISTRY
- Validate parameters is a dict (not list/string)
- Return (is_valid, error_message) tuple

**execute_triggers(room, trigger_type, character, **context)** function:
- Get triggers from room.db.triggers (default to empty list)
- Filter triggers by trigger_type
- For each matching trigger:
  - Validate trigger data (skip invalid with logging)
  - Look up action in ACTION_REGISTRY
  - Call action with parameters from trigger
  - Catch and log any exceptions (don't crash room)

**Trigger data structure expected:**
```python
{
    "id": "unique-trigger-id",
    "type": "entry",  # or "exit", "timed", "interaction"
    "action": "send_message",
    "parameters": {
        "message": "Welcome to the Elysium."
    },
    "enabled": True
}
```

Add logging for trigger execution (success and failure).
  </action>
  <verify>
Check file exists and exports key functions:
```bash
grep -n "def validate_trigger\|def execute_triggers\|class TriggerError" beckonmu/web/builder/trigger_engine.py
grep -n "from.*trigger_actions import" beckonmu/web/builder/trigger_engine.py
```
  </verify>
  <done>
Trigger engine validates trigger data, executes whitelisted actions, logs all activity, handles errors gracefully without crashing room.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add entry/exit hooks to Room typeclass</name>
  <files>beckonmu/typeclasses/rooms.py</files>
  <action>
Modify `beckonmu/typeclasses/rooms.py` to add entry/exit trigger hooks:

1. Import trigger engine at top of file:
```python
from beckonmu.web.builder.trigger_engine import execute_triggers
```

2. Add `at_object_receive(self, moved_obj, source_location, **kwargs)` method:
- Check if moved_obj has an account (is a player character)
- If yes, call `execute_triggers(self, "entry", moved_obj)`
- Call super().at_object_receive() to preserve default behavior

3. Add `at_object_leave(self, moved_obj, target_location, **kwargs)` method:
- Check if moved_obj has an account (is a player character)
- If yes, call `execute_triggers(self, "exit", moved_obj, target_location=target_location)`
- Call super().at_object_leave() to preserve default behavior

**Important:** Only trigger for characters with accounts (not NPCs, not objects being moved).

**Evennia hook signatures:**
- at_object_receive(moved_obj, source_location, move_type="move", **kwargs)
- at_object_leave(moved_obj, target_location, move_type="move", **kwargs)
  </action>
  <verify>
Check hooks are added and import exists:
```bash
grep -n "from.*trigger_engine import\|def at_object_receive\|def at_object_leave" beckonmu/typeclasses/rooms.py
grep -n "execute_triggers.*entry\|execute_triggers.*exit" beckonmu/typeclasses/rooms.py
```
  </verify>
  <done>
Room typeclass calls execute_triggers for entry and exit events, only for player characters, preserves default Evennia behavior.
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
```bash
# Check all files exist
ls beckonmu/web/builder/trigger_actions.py
ls beckonmu/web/builder/trigger_engine.py

# Check imports work
cd beckonmu && python -c "from web.builder.trigger_actions import ACTION_REGISTRY; print('Actions:', list(ACTION_REGISTRY.keys()))"
cd beckonmu && python -c "from web.builder.trigger_engine import execute_triggers, validate_trigger, TriggerError; print('Engine imports OK')"
cd beckonmu && python -c "from typeclasses.rooms import Room; print('Room import OK')"

# Check Room has hooks
python -c "from beckonmu.typeclasses.rooms import Room; assert hasattr(Room, 'at_object_receive'); assert hasattr(Room, 'at_object_leave'); print('Hooks present')"
```

**Manual verification:**
1. Create a test room with entry trigger in sandbox
2. Walk character into room - trigger should fire
3. Walk character out - exit trigger should fire
</verification>

<success_criteria>
- [ ] trigger_actions.py exists with 3+ whitelisted actions
- [ ] ACTION_REGISTRY maps action names to safe functions
- [ ] trigger_engine.py validates trigger data before execution
- [ ] Room.at_object_receive() calls execute_triggers("entry", ...)
- [ ] Room.at_object_leave() calls execute_triggers("exit", ...)
- [ ] Only player characters trigger entry/exit (not NPCs)
- [ ] Invalid triggers are logged and skipped (don't crash room)
- [ ] No eval/exec or unsafe operations in trigger system
</success_criteria>

<output>
After completion, create `.planning/phases/07-trigger-system/07-01-SUMMARY.md`
</output>
