V5 DICE SYSTEM IMPLEMENTATION TASK

Context: Gemini has analyzed v5_dice.py and provided complete implementation guidance for all 6 TODOs. You will implement these in priority order.

Priority Order:
1. Phase 6: Blood Potency Rouse Check Re-rolls (HIGH)
2. Phase 8: Discipline Modifiers (HIGH)
3. Phase 11: Frenzy Checks (HIGH)
4. Phase 5: ANSI Dice Formatting (MEDIUM)
5. Phase 10: Contested Rolls (MEDIUM)
6. Phase 6: Hunger Penalties (LOW - placeholder only)

---

PHASE 6: BLOOD POTENCY ROUSE CHECK RE-ROLLS (HIGH PRIORITY)

Files to modify:
- beckonmu/world/v5_dice.py

Implementation:

1. Import BLOOD_POTENCY from v5_data.py at top of file (if not already imported)

2. Modify the rouse_check function (currently around lines 121-148) to return Tuple[bool, int, int] instead of just bool:

def rouse_check(character) -> Tuple[bool, int, int]:
    """
    Perform a Rouse check.

    A Rouse check is a single d10 roll:
    - Success (6+): No Hunger increase
    - Failure (1-5): Hunger increases by 1

    Blood Potency may allow re-rolls on the first failure.

    Args:
        character: The character object performing the check.

    Returns:
        Tuple[bool, int, int]: (success, die_result, rerolls_available)
    """
    die_result = random.randint(1, 10)
    success = die_result >= 6

    rerolls_available = 0
    if not success:
        blood_potency = character.db.blood_potency or 0
        if blood_potency in BLOOD_POTENCY:
            bp_data = BLOOD_POTENCY[blood_potency]
            rerolls_available = bp_data.get('rouse_reroll', 0)

    return success, die_result, rerolls_available

3. Add new function rouse_reroll after rouse_check:

def rouse_reroll(character) -> Tuple[bool, int]:
    """
    Performs a re-roll for a failed Rouse check, using Blood Potency.
    This assumes the character is eligible for a re-roll.

    Args:
        character: The character object performing the re-roll.

    Returns:
        Tuple[bool, int]: (success, die_result)
    """
    die_result = random.randint(1, 10)
    success = die_result >= 6
    return success, die_result

Character data requirements:
- character.db.blood_potency (Integer, 0-10)

Remove TODO comment at line around 144-146

---

PHASE 8: DISCIPLINE MODIFIERS (HIGH PRIORITY)

Files to modify:
- beckonmu/world/v5_dice.py

Implementation:

1. Import DISCIPLINES and RESONANCES at top of file (if not already imported)

2. Replace the apply_discipline_modifiers function (currently around line 223-229) with:

def apply_discipline_modifiers(pool: int, character, discipline_name: str = None) -> int:
    """
    Apply discipline-based modifiers to a dice pool.

    Checks for:
    - Prowess (Potence 2): Adds Potence rating to Strength-based rolls.
    - Draught of Elegance (Celerity 4): Adds Celerity rating to Dexterity-based rolls.
    - Draught of Endurance (Fortitude 4): Adds Fortitude rating to Stamina-based rolls.
    - Resonance bonuses.

    Args:
        pool (int): The initial dice pool.
        character: The character object.
        discipline_name (str, optional): The primary discipline being used for the roll.

    Returns:
        int: The modified dice pool.
    """
    # Active Effects (e.g., Prowess, Draughts)
    # Assumes character.db.active_effects is a list of power names
    active_effects = character.db.active_effects or []
    disciplines = character.db.disciplines or {}

    if "Prowess" in active_effects and "potence" in disciplines:
        pool += disciplines["potence"]
    if "Draught of Elegance" in active_effects and "celerity" in disciplines:
        pool += disciplines["celerity"]
    if "Draught of Endurance" in active_effects and "fortitude" in disciplines:
        pool += disciplines["fortitude"]

    # Resonance Bonuses
    resonance = character.db.resonance
    if resonance and discipline_name:
        resonance_data = RESONANCES.get(resonance)
        if resonance_data and discipline_name in resonance_data.get("disciplines", []):
            pool += 1 # Add 1 die for matching resonance

    return pool

Character data requirements:
- character.db.disciplines (Dictionary, e.g., {"potence": 2, "celerity": 4})
- character.db.active_effects (List of strings, e.g., ["Prowess"])
- character.db.resonance (String, e.g., "Choleric")

Remove TODO comment at line around 228

---

PHASE 11: FRENZY CHECKS (HIGH PRIORITY)

Files to modify:
- beckonmu/world/v5_data.py (add new data structure)
- beckonmu/world/v5_dice.py (implement function)

Implementation:

1. Add to beckonmu/world/v5_data.py at the end of the file:

# Frenzy trigger data
FRENZY_TRIGGERS = {
    "hunger": {"difficulty": 3, "compulsion": "Feed"},
    "humiliation": {"difficulty": 2, "compulsion": "Fight"},
    "rage": {"difficulty": 3, "compulsion": "Fight"},
    "fear": {"difficulty": 3, "compulsion": "Flight"},
    "fire": {"difficulty": 4, "compulsion": "Flight"},
    "sunlight": {"difficulty": 5, "compulsion": "Flight"},
}

2. Import FRENZY_TRIGGERS in v5_dice.py at top of file

3. Replace the check_frenzy function (currently around line 232-242) with:

def check_frenzy(character, trigger_type: str) -> Tuple[bool, Optional[str]]:
    """
    Check if a character resists frenzy.

    Args:
        character: The character object.
        trigger_type (str): The type of frenzy trigger (e.g., "hunger", "rage").

    Returns:
        Tuple[bool, Optional[str]]: (resisted, compulsion_on_failure)
    """
    trigger_data = FRENZY_TRIGGERS.get(trigger_type.lower())
    if not trigger_data:
        return (True, None) # Unknown trigger, assume resistance

    difficulty = trigger_data["difficulty"]
    compulsion = trigger_data["compulsion"]

    # Hunger 5 is an automatic hunger frenzy
    if trigger_type == "hunger" and (character.db.hunger or 0) >= 5:
        return (False, compulsion)

    # Pool is Resolve + Composure
    pool = (character.db.resolve or 1) + (character.db.composure or 1)

    # Humanity can limit the pool
    humanity = character.db.humanity or 7
    if humanity < 3:
        pool = min(pool, humanity)

    # Brujah bane
    if character.db.clan == "Brujah" and compulsion == "Fight":
        difficulty += 2

    if pool <= 0:
        return (False, compulsion)

    result = roll_pool(pool, character.db.hunger or 0, difficulty)

    if result.is_success():
        return (True, None)
    else:
        return (False, compulsion)

Character data requirements:
- character.db.resolve (Integer)
- character.db.composure (Integer)
- character.db.humanity (Integer)
- character.db.hunger (Integer)
- character.db.clan (String)

Remove TODO comment at line around 241

---

PHASE 5: ANSI DICE FORMATTING (MEDIUM PRIORITY)

Files to create:
- beckonmu/world/ansi_theme.py (NEW FILE)

Files to modify:
- beckonmu/world/v5_dice.py

Implementation:

1. Create beckonmu/world/ansi_theme.py:

"""
ANSI color constants for V5 dice system theming.
"""

# Dice Symbols
DICE_CRITICAL = "|g(X)|n"  # Critical Success (10)
DICE_SUCCESS = "|g(V)|n"  # Normal Success (6-9)
DICE_FAILURE = "|x(-)|n"  # Failure (1-5)

# Hunger Dice Symbols
DICE_HUNGER_CRITICAL = "|r(X)|n" # Hunger Critical (10)
DICE_HUNGER_SUCCESS = "|r(V)|n" # Hunger Success (6-9)
DICE_HUNGER_FAILURE = "|r(-)|n" # Hunger Failure (1-5)

# Banners
MESSY_CRITICAL_BANNER = "|r|\\/\\/\\ MESSY CRITICAL \\/\\/\\|n"
BESTIAL_FAILURE_BANNER = "|R|\\/\\/\\ BESTIAL FAILURE \\/\\/\\|n"
CRITICAL_SUCCESS_BANNER = "|G*** CRITICAL SUCCESS ***|n"
SUCCESS_BANNER = "|g** SUCCESS **|n"
FAILURE_BANNER = "|x** FAILURE **|n"

2. In v5_dice.py, replace the TODO imports (lines around 166-171) with actual imports:

from beckonmu.world.ansi_theme import (
    DICE_CRITICAL, DICE_SUCCESS, DICE_FAILURE,
    DICE_HUNGER_CRITICAL, DICE_HUNGER_SUCCESS, DICE_HUNGER_FAILURE,
    MESSY_CRITICAL_BANNER, BESTIAL_FAILURE_BANNER, CRITICAL_SUCCESS_BANNER,
    SUCCESS_BANNER, FAILURE_BANNER
)

3. Add helper function _format_die before format_dice_result:

def _format_die(value, is_hunger=False):
    """Helper to format a single die with ANSI colors."""
    if is_hunger:
        if value == 10: return DICE_HUNGER_CRITICAL
        if value >= 6: return DICE_HUNGER_SUCCESS
        return DICE_HUNGER_FAILURE
    else:
        if value == 10: return DICE_CRITICAL
        if value >= 6: return DICE_SUCCESS
        return DICE_FAILURE

4. Replace the format_dice_result function (currently around lines 151-183) with:

def format_dice_result(result: DiceResult, character_name: str = "You") -> str:
    """
    Format a DiceResult as themed output using ansi_theme.py.
    """
    total_dice = len(result.normal_dice) + len(result.hunger_dice)
    total_successes_with_crits = result.successes + (result.criticals * 2)

    # Build dice string
    normal_dice_str = " ".join(_format_die(d) for d in sorted(result.normal_dice, reverse=True))
    hunger_dice_str = " ".join(_format_die(d, is_hunger=True) for d in sorted(result.hunger_dice, reverse=True))
    all_dice_str = f"{normal_dice_str} {hunger_dice_str}".strip()

    # Build output
    output = f"|w{character_name} rolls {total_dice} dice (Difficulty: {result.difficulty})...|n\n"
    output += f"|wResult:|n {all_dice_str}\n"
    output += f"|wSuccesses:|n {total_successes_with_crits} (Margin: {result.margin})\n"

    # Add banners
    if result.is_messy:
        output += f"\n{MESSY_CRITICAL_BANNER}\n"
    elif result.is_bestial:
        output += f"\n{BESTIAL_FAILURE_BANNER}\n"
    elif result.is_critical_success():
        output += f"\n{CRITICAL_SUCCESS_BANNER}\n"
    elif result.is_success():
        output += f"\n{SUCCESS_BANNER}\n"
    else:
        output += f"\n{FAILURE_BANNER}\n"

    return output

Remove TODO comment at lines around 166-171

---

PHASE 10: CONTESTED ROLLS (MEDIUM PRIORITY)

Files to modify:
- beckonmu/world/v5_dice.py

Implementation:

Replace the calculate_contested_roll function (currently around lines 186-216) with:

def calculate_contested_roll(
    attacker_result: DiceResult,
    defender_result: DiceResult
) -> Dict[str, any]:
    """
    Calculate the outcome of a contested roll (attacker vs defender).
    Ties go to the defender. Special outcomes (messy, bestial) are flagged.
    """
    margin_diff = attacker_result.margin - defender_result.margin

    winner = "defender"
    if margin_diff > 0:
        winner = "attacker"

    return {
        "winner": winner,
        "margin_difference": abs(margin_diff),
        "attacker_messy": attacker_result.is_messy,
        "defender_messy": defender_result.is_messy,
        "attacker_bestial": attacker_result.is_bestial,
        "defender_bestial": defender_result.is_bestial,
    }

Remove TODO comment at line around 206

---

PHASE 6: HUNGER PENALTIES (LOW PRIORITY - PLACEHOLDER)

Files to modify:
- beckonmu/world/v5_dice.py

Implementation:

Replace the apply_hunger_penalties function (currently around lines 245-254) with:

def apply_hunger_penalties(pool: int, hunger: int) -> int:
    """
    Apply penalties to dice pool based on Hunger level.

    Note: V5 core rules do not apply direct penalties to dice pools based on
    Hunger. The risk comes from Hunger Dice replacing normal dice, leading to
    Messy Criticals and Bestial Failures. This function is included for
    extensibility in case specific powers or homebrew rules impose penalties.
    """
    # No penalties applied in core V5 rules.
    return pool

Remove TODO comment at line around 253

---

VALIDATION REQUIRED

After implementing all phases:
1. Check that all imports resolve correctly
2. Verify all function signatures match existing call sites
3. Run Python syntax check: python -m py_compile beckonmu/world/v5_dice.py
4. Run Python syntax check: python -m py_compile beckonmu/world/v5_data.py
5. Run Python syntax check: python -m py_compile beckonmu/world/ansi_theme.py
6. Confirm all 6 TODO comments have been removed

OUTPUT REQUIRED:
1. Confirmation that all phases are implemented
2. Any syntax errors encountered and fixed
3. List of all files modified/created
4. Summary of changes made
