{% extends "builder/base.html" %}

{% block title %}Build Review{% endblock %}
{% block nav_review %}active{% endblock %}

{% block extra_css %}
<style>
    /* ── Review Cards ───────────────────────────── */
    .review-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 16px;
    }

    .review-card {
        background: var(--builder-card);
        border: 1px solid var(--builder-border);
        border-radius: 2px;
        overflow: hidden;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .review-card:hover {
        border-color: var(--builder-border-hover);
        box-shadow: 0 0 20px var(--crimson-glow);
    }

    .review-card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--builder-border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .review-card-header h3 {
        font-family: 'Cinzel', serif;
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin: 0 0 2px;
        color: var(--builder-text);
    }
    .review-card-header .author {
        font-size: 12px;
        color: var(--builder-muted);
    }

    .review-card-body {
        padding: 16px 20px;
    }

    .review-card-footer {
        padding: 12px 20px;
        border-top: 1px solid var(--builder-border);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* ── Stats Strip ────────────────────────────── */
    .review-stats {
        display: flex;
        gap: 24px;
        margin-bottom: 14px;
    }
    .review-stat {
        text-align: center;
    }
    .review-stat-value {
        font-family: 'Cinzel', serif;
        font-size: 18px;
        font-weight: 700;
        color: var(--builder-text);
        line-height: 1;
    }
    .review-stat-label {
        font-family: 'Raleway', sans-serif;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--builder-muted);
        margin-top: 2px;
    }

    /* ── Builder Notes ──────────────────────────── */
    .builder-notes {
        background: var(--gold-glow);
        border: 1px solid rgba(154,125,58,0.2);
        border-left: 3px solid var(--gold);
        border-radius: 2px;
        padding: 10px 12px;
        font-size: 12px;
        color: var(--gold-bright);
        margin-bottom: 14px;
    }
    .builder-notes strong {
        color: var(--text-gold);
        font-family: 'Cinzel', serif;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* ── Map Preview ────────────────────────────── */
    .map-preview {
        background: var(--codex-obsidian);
        border: 1px solid var(--builder-border);
        border-radius: 2px;
        overflow: hidden;
    }
    .map-preview canvas {
        display: block;
        width: 100%;
        height: 180px;
    }

    /* ── Description ────────────────────────────── */
    .review-desc {
        font-size: 13px;
        color: var(--builder-muted);
        margin-bottom: 14px;
        line-height: 1.5;
    }

    /* ── Pending Counter ────────────────────────── */
    .pending-pill {
        background: var(--gold-glow);
        color: var(--gold-bright);
        font-family: 'Raleway', sans-serif;
        font-size: 13px;
        font-weight: 600;
        padding: 4px 14px;
        border-radius: 2px;
    }

    /* ── Empty State ────────────────────────────── */
    .review-empty {
        text-align: center;
        padding: 80px 20px;
    }
    .review-empty i {
        font-size: 56px;
        color: var(--builder-border);
        margin-bottom: 20px;
        display: block;
    }
    .review-empty h4 {
        font-family: 'Cinzel', serif;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    .review-empty p {
        color: var(--builder-muted);
        font-size: 14px;
        max-width: 360px;
        margin: 0 auto;
    }

    /* ── Loading Skeleton ───────────────────────── */
    .skeleton-card {
        background: var(--builder-card);
        border: 1px solid var(--builder-border);
        border-radius: 2px;
        height: 340px;
        position: relative;
        overflow: hidden;
    }
    .skeleton-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header -->
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h2>Build Review</h2>
            <p>Review and approve builder submissions</p>
        </div>
        <span class="pending-pill" id="project-count">
            <i class="bi bi-hourglass-split" style="font-size: 12px;"></i> Loading...
        </span>
    </div>

    <!-- Projects Container -->
    <div id="projects-container">
        <!-- Loading state -->
        <div id="loading-state" class="review-grid">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>

        <!-- Empty state (hidden initially) -->
        <div id="empty-state" style="display: none;">
            <div class="review-empty">
                <i class="bi bi-check2-all"></i>
                <h4>All caught up</h4>
                <p>No projects are waiting for review. New submissions will appear here automatically.</p>
            </div>
        </div>

        <!-- Project cards -->
        <div id="project-cards" class="review-grid"></div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Reject <strong id="reject-project-name" class="text-accent"></strong>?</p>
                <p class="text-builder-muted" style="font-size: 13px;">Provide feedback so the builder knows what to improve.</p>
                <div class="mb-3">
                    <label for="rejection-notes" class="form-label">Feedback <span style="color: var(--builder-accent-light);">*</span></label>
                    <textarea class="form-control" id="rejection-notes" rows="4"
                              placeholder="Explain what needs to be changed or improved..."
                              minlength="10"></textarea>
                    <div class="form-text"><span id="char-count">0</span> / 10 minimum characters</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-accent" id="confirm-reject" disabled
                        style="background: var(--builder-accent);">
                    <i class="bi bi-x-lg"></i> Reject
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ── Reject Modal ───────────────────────────────────
let currentProjectId = null;
const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
const rejectionNotes = document.getElementById('rejection-notes');
const charCount = document.getElementById('char-count');
const confirmReject = document.getElementById('confirm-reject');

rejectionNotes.addEventListener('input', function() {
    const len = this.value.length;
    charCount.textContent = len;
    confirmReject.disabled = len < 10;
});

function showRejectModal(id, name) {
    currentProjectId = id;
    document.getElementById('reject-project-name').textContent = name;
    rejectionNotes.value = '';
    charCount.textContent = '0';
    confirmReject.disabled = true;
    rejectModal.show();
}

confirmReject.addEventListener('click', async function() {
    if (!currentProjectId) return;
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Rejecting...';

    const notes = rejectionNotes.value.trim();
    if (notes.length < 10) {
        alert('Please provide at least 10 characters of feedback');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-x-lg"></i> Reject';
        return;
    }

    try {
        const response = await fetch(`/builder/api/review/${currentProjectId}/reject/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ notes: notes })
        });
        const data = await response.json();
        if (data.status === 'success') {
            rejectModal.hide();
            loadProjects();
        } else {
            alert('Error: ' + (data.error || 'Failed to reject project'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-lg"></i> Reject';
        }
    } catch (error) {
        alert('Error rejecting project: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-x-lg"></i> Reject';
    }
});

// ── Approve ────────────────────────────────────────
async function approveProject(id, name) {
    if (!confirm(`Approve "${name}"? This will allow the builder to proceed to sandbox testing.`)) return;

    try {
        const response = await fetch(`/builder/api/review/${id}/approve/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
        });
        const data = await response.json();
        if (data.status === 'success') {
            loadProjects();
        } else {
            alert('Error: ' + (data.error || 'Failed to approve project'));
        }
    } catch (error) {
        alert('Error approving project: ' + error.message);
    }
}

// ── Mini Map Renderer ──────────────────────────────
function renderMiniMap(canvas, mapData) {
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const width = rect.width;
    const height = rect.height;

    // Background
    ctx.fillStyle = '#15151a';
    ctx.fillRect(0, 0, width, height);

    if (!mapData || !mapData.rooms) return;
    const rooms = Object.values(mapData.rooms);
    if (rooms.length === 0) return;

    // Bounds
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    rooms.forEach(room => {
        minX = Math.min(minX, room.x || 0);
        minY = Math.min(minY, room.y || 0);
        maxX = Math.max(maxX, room.x || 0);
        maxY = Math.max(maxY, room.y || 0);
    });

    const padding = 24;
    const roomW = 80, roomH = 50;
    const mapWidth = maxX - minX + roomW;
    const mapHeight = maxY - minY + roomH;
    const scaleX = (width - padding * 2) / mapWidth;
    const scaleY = (height - padding * 2) / mapHeight;
    const scale = Math.min(scaleX, scaleY, 1);
    const offsetX = (width - mapWidth * scale) / 2 - minX * scale;
    const offsetY = (height - mapHeight * scale) / 2 - minY * scale;

    // Draw exits
    if (mapData.exits) {
        ctx.strokeStyle = '#3a3a4a';
        ctx.lineWidth = 1.5;
        Object.values(mapData.exits).forEach(exit => {
            const src = mapData.rooms[exit.source];
            const tgt = mapData.rooms[exit.target];
            if (src && tgt) {
                const x1 = ((src.x || 0) + roomW/2) * scale + offsetX;
                const y1 = ((src.y || 0) + roomH/2) * scale + offsetY;
                const x2 = ((tgt.x || 0) + roomW/2) * scale + offsetX;
                const y2 = ((tgt.y || 0) + roomH/2) * scale + offsetY;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
        });
    }

    // Draw rooms
    rooms.forEach(room => {
        const x = (room.x || 0) * scale + offsetX;
        const y = (room.y || 0) * scale + offsetY;
        const w = roomW * scale;
        const h = roomH * scale;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.roundRect(x + 1, y + 1, w, h, 3 * scale);
        ctx.fill();

        // Room body
        ctx.fillStyle = '#2a2a3a';
        ctx.beginPath();
        ctx.roundRect(x, y, w, h, 3 * scale);
        ctx.fill();

        // Room border
        ctx.strokeStyle = '#4a4a5a';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Room name
        ctx.fillStyle = '#ccc';
        ctx.font = `${Math.max(7, 9 * scale)}px -apple-system, sans-serif`;
        ctx.textAlign = 'center';
        const name = (room.name || 'Unnamed').substring(0, 12);
        ctx.fillText(name, x + w / 2, y + h / 2 + 3);
    });
}

// ── Load Projects ──────────────────────────────────
async function loadProjects() {
    const container = document.getElementById('project-cards');
    const emptyState = document.getElementById('empty-state');
    const loadingState = document.getElementById('loading-state');
    const countBadge = document.getElementById('project-count');

    try {
        const response = await fetch('/builder/api/review/projects/');
        const data = await response.json();

        loadingState.style.display = 'none';

        if (data.status !== 'success') {
            container.innerHTML = `<div class="col-12" style="background: rgba(139,0,0,0.1); border: 1px solid rgba(139,0,0,0.3); border-radius: 8px; padding: 16px; color: var(--builder-accent-light);">Error loading projects: ${data.error || 'Unknown error'}</div>`;
            return;
        }

        const projects = data.projects || [];
        countBadge.innerHTML = `<i class="bi bi-inbox" style="font-size: 12px;"></i> ${projects.length} pending`;

        if (projects.length === 0) {
            container.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        container.innerHTML = projects.map(project => {
            const age = Math.ceil((new Date() - new Date(project.created_at)) / (1000 * 60 * 60 * 24));
            return `
            <div class="review-card">
                <div class="review-card-header">
                    <div>
                        <h3>${escapeHtml(project.name)}</h3>
                        <span class="author">by ${escapeHtml(project.user.username)}</span>
                    </div>
                    <span class="status-badge status-submitted">
                        <span class="status-dot"></span> Submitted
                    </span>
                </div>
                <div class="review-card-body">
                    <p class="review-desc">${escapeHtml(project.description || 'No description provided')}</p>

                    <div class="review-stats">
                        <div class="review-stat">
                            <div class="review-stat-value">${project.room_count}</div>
                            <div class="review-stat-label">Rooms</div>
                        </div>
                        <div class="review-stat">
                            <div class="review-stat-value">${project.exit_count}</div>
                            <div class="review-stat-label">Exits</div>
                        </div>
                        <div class="review-stat">
                            <div class="review-stat-value">${age}d</div>
                            <div class="review-stat-label">Age</div>
                        </div>
                    </div>

                    ${project.submission_notes ? `
                    <div class="builder-notes">
                        <strong>Builder Notes</strong><br>
                        ${escapeHtml(project.submission_notes)}
                    </div>
                    ` : ''}

                    <div class="map-preview">
                        <canvas id="map-canvas-${project.id}"></canvas>
                    </div>
                </div>
                <div class="review-card-footer">
                    <button class="btn-accent" style="flex: 1;"
                            onclick="approveProject(${project.id}, '${escapeHtml(project.name)}')">
                        <i class="bi bi-check-lg"></i> Approve
                    </button>
                    <button class="btn-ghost" style="flex: 1; color: var(--builder-accent-light); border-color: rgba(139,0,0,0.3);"
                            onclick="showRejectModal(${project.id}, '${escapeHtml(project.name)}')">
                        <i class="bi bi-x-lg"></i> Reject
                    </button>
                    <a href="/builder/edit/${project.id}/" class="btn-ghost" style="text-decoration:none;"
                       target="_blank" title="View full map">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            </div>`;
        }).join('');

        // Render map previews
        projects.forEach(project => {
            const canvas = document.getElementById(`map-canvas-${project.id}`);
            if (canvas) {
                fetch(`/builder/api/project/${project.id}/`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success' && data.project.map_data) {
                            renderMiniMap(canvas, data.project.map_data);
                        }
                    })
                    .catch(err => console.error('Failed to load map data:', err));
            }
        });

    } catch (error) {
        loadingState.style.display = 'none';
        container.innerHTML = `<div style="background: rgba(139,0,0,0.1); border: 1px solid rgba(139,0,0,0.3); border-radius: 8px; padding: 16px; color: var(--builder-accent-light);">Error loading projects: ${error.message}</div>`;
    }
}

// XSS protection
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', loadProjects);
</script>
{% endblock %}
