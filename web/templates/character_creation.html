{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Creation - The Beckoning MU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 900px;
            margin: 60px auto 40px;
            padding: 20px;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #1a1a1a;
            border-bottom: 2px solid #8b0000;
            padding: 15px 20px;
            z-index: 1000;
        }
        .header h1 {
            margin: 0;
            color: #ff6b6b;
            font-size: 1.8rem;
        }
        .form-section {
            background-color: #2d2d2d;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .form-section h3 {
            color: #ff6b6b;
            border-bottom: 2px solid #8b0000;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        .form-label {
            color: #aaa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-control, .form-select {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
        }
        .form-control:focus, .form-select:focus {
            background-color: #4a4a4a;
            border-color: #8b0000;
            color: #e0e0e0;
        }
        .trait-group {
            margin-bottom: 20px;
        }
        .trait-group h5 {
            color: #ff6b6b;
            margin-bottom: 15px;
        }
        .trait-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .trait-label {
            flex: 0 0 150px;
            color: #ccc;
        }
        .trait-dots {
            display: flex;
            gap: 5px;
        }
        .dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #8b0000;
            background-color: #2d2d2d;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dot:hover {
            background-color: #4a1a1a;
        }
        .dot.filled {
            background-color: #ff0000;
        }
        .btn-submit {
            background-color: #8b0000;
            border-color: #8b0000;
            color: white;
            font-size: 1.2rem;
            padding: 12px 40px;
        }
        .btn-submit:hover {
            background-color: #a00000;
            border-color: #a00000;
        }
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }
        .clan-info {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #8b0000;
        }
        .help-text {
            color: #999;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .character-points {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2d2d2d;
            border: 2px solid #8b0000;
            padding: 15px;
            border-radius: 8px;
            z-index: 500;
        }
        .points-label {
            color: #ff6b6b;
            font-weight: bold;
        }
        .in-clan {
            color: #ffd700;
            font-weight: bold;
        }
        .trait-instance-input {
            margin-left: 10px;
            flex: 1;
            max-width: 300px;
        }
        .trait-row-with-input {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .trait-specialty-input {
            margin-left: 10px;
            flex: 1;
            max-width: 300px;
        }
        .priority-selector {
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .priority-selector h5 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }
        .priority-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .priority-label {
            flex: 0 0 100px;
            color: #ccc;
        }
        .priority-select {
            flex: 1;
            max-width: 200px;
        }
        .validation-error {
            color: #ff4444;
            font-weight: bold;
        }
        .validation-success {
            color: #44ff44;
            font-weight: bold;
        }
        .error-list {
            background-color: #3a1a1a;
            border: 2px solid #ff4444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .error-list h5 {
            color: #ff4444;
            margin-bottom: 10px;
        }
        .error-list ul {
            margin: 0;
            padding-left: 20px;
        }
        .error-list li {
            color: #ffaaaa;
            margin-bottom: 5px;
        }
        .btn-submit:disabled {
            background-color: #555;
            border-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü©∏ Create Your Character</h1>
    </div>

    <div class="main-container">
        <form id="character-form">
            <!-- Bio Section -->
            <div class="form-section">
                <h3>Basic Information</h3>

                <div class="mb-3">
                    <label class="form-label">Character Name</label>
                    <input type="text" class="form-control" id="full_name" required>
                    <div class="help-text">Your character's full name</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Concept</label>
                    <input type="text" class="form-control" id="concept" required>
                    <div class="help-text">A brief description of your character (e.g., "Street-Smart Detective", "Tormented Artist")</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Clan</label>
                    <select class="form-select" id="clan" required>
                        <option value="">Select a clan...</option>
                        <option value="Brujah">Brujah</option>
                        <option value="Gangrel">Gangrel</option>
                        <option value="Malkavian">Malkavian</option>
                        <option value="Nosferatu">Nosferatu</option>
                        <option value="Toreador">Toreador</option>
                        <option value="Tremere">Tremere</option>
                        <option value="Ventrue">Ventrue</option>
                        <option value="Caitiff">Caitiff</option>
                    </select>
                    <div id="clan-info" class="clan-info" style="display: none;"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Sire</label>
                    <input type="text" class="form-control" id="sire">
                    <div class="help-text">The name of your character's sire (who embraced them)</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Generation</label>
                    <select class="form-select" id="generation">
                        <option value="">Select generation...</option>
                        <option value="13">13th Generation</option>
                        <option value="12">12th Generation</option>
                        <option value="11">11th Generation</option>
                        <option value="10">10th Generation</option>
                    </select>
                    <div class="help-text">Most new vampires are 12th or 13th generation</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Predator Type</label>
                    <select class="form-select" id="predator_type">
                        <option value="">Select predator type...</option>
                        <option value="Alleycat">Alleycat</option>
                        <option value="Bagger">Bagger</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Osiris">Osiris</option>
                        <option value="Sandman">Sandman</option>
                        <option value="Siren">Siren</option>
                    </select>
                    <div class="help-text">How your character prefers to feed</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ambition</label>
                    <textarea class="form-control" id="ambition" rows="2"></textarea>
                    <div class="help-text">Your character's long-term goal</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Desire</label>
                    <textarea class="form-control" id="desire" rows="2"></textarea>
                    <div class="help-text">Your character's short-term want</div>
                </div>
            </div>

            <!-- Attributes Section -->
            <div class="form-section">
                <h3>Attributes</h3>
                <div class="help-text mb-3">Each attribute starts at 1. Assign priorities to categories, then distribute the additional dots.</div>
                
                <!-- Priority Selector -->
                <div class="priority-selector">
                    <h5>Assign Priorities</h5>
                    <div class="priority-row">
                        <span class="priority-label">Primary (7 dots):</span>
                        <select class="form-select priority-select" id="attr-priority-primary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                    <div class="priority-row">
                        <span class="priority-label">Secondary (5 dots):</span>
                        <select class="form-select priority-select" id="attr-priority-secondary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                    <div class="priority-row">
                        <span class="priority-label">Tertiary (3 dots):</span>
                        <select class="form-select priority-select" id="attr-priority-tertiary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Physical <span id="attr-physical-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Strength</span>
                        <div class="trait-dots" data-trait="strength" data-category="physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Dexterity</span>
                        <div class="trait-dots" data-trait="dexterity" data-category="physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Stamina</span>
                        <div class="trait-dots" data-trait="stamina" data-category="physical"></div>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Social <span id="attr-social-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Charisma</span>
                        <div class="trait-dots" data-trait="charisma" data-category="social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Manipulation</span>
                        <div class="trait-dots" data-trait="manipulation" data-category="social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Composure</span>
                        <div class="trait-dots" data-trait="composure" data-category="social"></div>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Mental <span id="attr-mental-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Intelligence</span>
                        <div class="trait-dots" data-trait="intelligence" data-category="mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Wits</span>
                        <div class="trait-dots" data-trait="wits" data-category="mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Resolve</span>
                        <div class="trait-dots" data-trait="resolve" data-category="mental"></div>
                    </div>
                </div>
            </div>

            <!-- Skills Section -->
            <div class="form-section">
                <h3>Skills</h3>
                <div class="help-text mb-3">Skills start at 0. Assign priorities to categories, then distribute the dots.</div>
                
                <!-- Priority Selector -->
                <div class="priority-selector">
                    <h5>Assign Priorities</h5>
                    <div class="priority-row">
                        <span class="priority-label">Primary (13 dots):</span>
                        <select class="form-select priority-select" id="skill-priority-primary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                    <div class="priority-row">
                        <span class="priority-label">Secondary (9 dots):</span>
                        <select class="form-select priority-select" id="skill-priority-secondary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                    <div class="priority-row">
                        <span class="priority-label">Tertiary (5 dots):</span>
                        <select class="form-select priority-select" id="skill-priority-tertiary">
                            <option value="">Select category...</option>
                            <option value="physical">Physical</option>
                            <option value="social">Social</option>
                            <option value="mental">Mental</option>
                        </select>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Physical Skills <span id="skill-physical-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Athletics</span>
                        <div class="trait-dots" data-trait="athletics" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Brawl</span>
                        <div class="trait-dots" data-trait="brawl" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Craft</span>
                        <div class="trait-dots" data-trait="craft" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Drive</span>
                        <div class="trait-dots" data-trait="drive" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Firearms</span>
                        <div class="trait-dots" data-trait="firearms" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Melee</span>
                        <div class="trait-dots" data-trait="melee" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Larceny</span>
                        <div class="trait-dots" data-trait="larceny" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Stealth</span>
                        <div class="trait-dots" data-trait="stealth" data-category="skills-physical"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Survival</span>
                        <div class="trait-dots" data-trait="survival" data-category="skills-physical"></div>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Social Skills <span id="skill-social-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Animal Ken</span>
                        <div class="trait-dots" data-trait="animal_ken" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Etiquette</span>
                        <div class="trait-dots" data-trait="etiquette" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Insight</span>
                        <div class="trait-dots" data-trait="insight" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Intimidation</span>
                        <div class="trait-dots" data-trait="intimidation" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Leadership</span>
                        <div class="trait-dots" data-trait="leadership" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Performance</span>
                        <div class="trait-dots" data-trait="performance" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Persuasion</span>
                        <div class="trait-dots" data-trait="persuasion" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Streetwise</span>
                        <div class="trait-dots" data-trait="streetwise" data-category="skills-social"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Subterfuge</span>
                        <div class="trait-dots" data-trait="subterfuge" data-category="skills-social"></div>
                    </div>
                </div>

                <div class="trait-group">
                    <h5>Mental Skills <span id="skill-mental-pool"></span></h5>
                    <div class="trait-row">
                        <span class="trait-label">Academics</span>
                        <div class="trait-dots" data-trait="academics" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Awareness</span>
                        <div class="trait-dots" data-trait="awareness" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Finance</span>
                        <div class="trait-dots" data-trait="finance" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Investigation</span>
                        <div class="trait-dots" data-trait="investigation" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Medicine</span>
                        <div class="trait-dots" data-trait="medicine" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Occult</span>
                        <div class="trait-dots" data-trait="occult" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Politics</span>
                        <div class="trait-dots" data-trait="politics" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Science</span>
                        <div class="trait-dots" data-trait="science" data-category="skills-mental"></div>
                    </div>
                    <div class="trait-row">
                        <span class="trait-label">Technology</span>
                        <div class="trait-dots" data-trait="technology" data-category="skills-mental"></div>
                    </div>
                </div>
            </div>

            <!-- Disciplines Section -->
            <div class="form-section">
                <h3>Disciplines</h3>
                <div class="help-text mb-3">Spend 3 dots total. Must have at least 2 dots in one discipline. Max 3 dots per discipline.</div>
                <div id="disciplines-container">
                    <div class="text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading disciplines...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advantages Section -->
            <div class="form-section">
                <h3>Advantages</h3>
                <div class="help-text mb-3">Spend up to 7 points on merits and advantages. Each dot costs 1 point.</div>
                <div id="advantages-container">
                    <div class="text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading advantages...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flaws Section -->
            <div class="form-section">
                <h3>Flaws</h3>
                <div class="help-text mb-3">Optionally take up to 2 points of flaws.</div>
                <div id="flaws-container">
                    <div class="text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading flaws...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validation Errors -->
            <div id="validation-errors" class="error-list" style="display: none;">
                <h5>‚ö† Please fix the following issues:</h5>
                <ul id="error-list-items"></ul>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-submit btn-lg" id="submit-button" disabled>Submit Character for Approval</button>
                <div class="help-text mt-2">Complete all sections to enable submission</div>
            </div>
        </form>
    </div>

        <!-- Character Points Tracker -->
    <div class="character-points">
        <div class="points-label">Attributes Spent</div>
        <div id="tracker-attr-physical">Physical: <span id="points-physical">0</span>/<span id="attr-physical-max">?</span></div>
        <div id="tracker-attr-social">Social: <span id="points-social">0</span>/<span id="attr-social-max">?</span></div>
        <div id="tracker-attr-mental">Mental: <span id="points-mental">0</span>/<span id="attr-mental-max">?</span></div>
        <hr>
        <div class="points-label">Skills Spent</div>
        <div id="tracker-skill-physical">Physical: <span id="points-skills-physical">0</span>/<span id="skill-physical-max">?</span></div>
        <div id="tracker-skill-social">Social: <span id="points-skills-social">0</span>/<span id="skill-social-max">?</span></div>
        <div id="tracker-skill-mental">Mental: <span id="points-skills-mental">0</span>/<span id="skill-mental-max">?</span></div>
        <hr>
        <div class="points-label">Disciplines Spent</div>
        <div id="tracker-disciplines"><span id="points-disciplines">0</span>/3 dots</div>
        <hr>
        <div class="points-label">Advantages Spent</div>
        <div id="tracker-advantages"><span id="points-advantages">0</span>/7 points</div>
        <hr>
        <div class="points-label">Flaws Spent</div>
        <div id="tracker-flaws"><span id="points-flaws">0</span>/2 points</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CSRF_TOKEN = '{{ csrf_token }}';

        // Clan data
        const CLANS = {
            "Brujah": {
                disciplines: ["Celerity", "Potence", "Presence"],
                bane: "Violent Temper: Difficulty +2 to resist fury frenzy"
            },
            "Gangrel": {
                disciplines: ["Animalism", "Fortitude", "Protean"],
                bane: "Bestial Features: Animal features emerge when Hunger 4+"
            },
            "Malkavian": {
                disciplines: ["Auspex", "Dominate", "Obfuscate"],
                bane: "Fractured Perspective: Must have at least one mental derangement"
            },
            "Nosferatu": {
                disciplines: ["Animalism", "Obfuscate", "Potence"],
                bane: "Repulsive: Appearance 0, automatic fail on Persuasion/Performance vs mortals"
            },
            "Toreador": {
                disciplines: ["Auspex", "Celerity", "Presence"],
                bane: "Aesthetic Fixation: May become entranced by beauty"
            },
            "Tremere": {
                disciplines: ["Auspex", "Blood Sorcery", "Dominate"],
                bane: "Deficient Blood: Blood bonds form one step stronger"
            },
            "Ventrue": {
                disciplines: ["Dominate", "Fortitude", "Presence"],
                bane: "Rarefied Taste: Can only feed from specific type of mortal"
            },
            "Caitiff": {
                disciplines: [],
                bane: "Suspect Blood: Ostracized by Camarilla"
            }
        };

        // Trait values storage
        const traitValues = {};
        const disciplineValues = {};
        const advantageValues = {};
        const flawValues = {};
        
        // Priority assignments
        const attributePriorities = {
            primary: null,
            secondary: null,
            tertiary: null
        };
        const skillPriorities = {
            primary: null,
            secondary: null,
            tertiary: null
        };
        
        // Trait data from API
        let disciplinesData = [];
        let advantagesData = [];
        let flawsData = [];

        // Initialize dots
        document.addEventListener('DOMContentLoaded', function() {
            initializeDots();
            setupClanSelector();
            setupFormSubmit();
            loadTraitData();
            setupPrioritySelectors();
        });

        function initializeDots() {
            document.querySelectorAll('.trait-dots').forEach(container => {
                const trait = container.dataset.trait;
                const category = container.dataset.category;
                const maxDots = 5;

                // Initialize trait value
                traitValues[trait] = category.startsWith('skills') ? 0 : 1;

                // Create dot elements
                for (let i = 1; i <= maxDots; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i <= traitValues[trait]) {
                        dot.classList.add('filled');
                    }
                    dot.dataset.value = i;

                    dot.addEventListener('click', function() {
                        const clickedValue = parseInt(this.dataset.value);
                        const minValue = category.startsWith('skills') ? 0 : 1;
                        const currentValue = traitValues[trait] ?? minValue;
                        let newValue = clickedValue;

                        // Toggle off if clicking the same filled dot
                        if (clickedValue === currentValue) {
                            newValue = Math.max(minValue, currentValue - 1);
                        }

                        traitValues[trait] = newValue;
                        updateDots(container, newValue);
                        updatePointsDisplay();
                        validateForm();
                    });

                    container.appendChild(dot);
                }
            });

            updatePointsDisplay();
        }

        function updateDots(container, value) {
            container.querySelectorAll('.dot').forEach(dot => {
                const dotValue = parseInt(dot.dataset.value);
                if (dotValue <= value) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            });
        }

        function updatePointsDisplay() {
            // Attributes (start at 1, so subtract base)
            const physicalSpent = (['strength', 'dexterity', 'stamina']
                .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;
            const socialSpent = (['charisma', 'manipulation', 'composure']
                .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;
            const mentalSpent = (['intelligence', 'wits', 'resolve']
                .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;

            document.getElementById('points-physical').textContent = physicalSpent;
            document.getElementById('points-social').textContent = socialSpent;
            document.getElementById('points-mental').textContent = mentalSpent;
            
            // Update attribute pool displays
            updatePoolDisplay('attr', 'physical', physicalSpent, getAttributePoolForCategory('physical'));
            updatePoolDisplay('attr', 'social', socialSpent, getAttributePoolForCategory('social'));
            updatePoolDisplay('attr', 'mental', mentalSpent, getAttributePoolForCategory('mental'));

            // Skills
            const physicalSkills = ['athletics', 'brawl', 'craft', 'drive', 'firearms', 'melee', 'larceny', 'stealth', 'survival'];
            const socialSkills = ['animal_ken', 'etiquette', 'insight', 'intimidation', 'leadership', 'performance', 'persuasion', 'streetwise', 'subterfuge'];
            const mentalSkills = ['academics', 'awareness', 'finance', 'investigation', 'medicine', 'occult', 'politics', 'science', 'technology'];

            const physicalSkillsSpent = physicalSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);
            const socialSkillsSpent = socialSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);
            const mentalSkillsSpent = mentalSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);

            document.getElementById('points-skills-physical').textContent = physicalSkillsSpent;
            document.getElementById('points-skills-social').textContent = socialSkillsSpent;
            document.getElementById('points-skills-mental').textContent = mentalSkillsSpent;
            
            // Update skill pool displays
            updatePoolDisplay('skill', 'physical', physicalSkillsSpent, getSkillPoolForCategory('physical'));
            updatePoolDisplay('skill', 'social', socialSkillsSpent, getSkillPoolForCategory('social'));
            updatePoolDisplay('skill', 'mental', mentalSkillsSpent, getSkillPoolForCategory('mental'));
            
            // Disciplines
            const disciplinesSpent = Object.values(disciplineValues).reduce((sum, val) => sum + val, 0);
            document.getElementById('points-disciplines').textContent = disciplinesSpent;
            
            // Advantages
            const advantagesSpent = Object.values(advantageValues).reduce((sum, adv) => sum + adv.value, 0);
            document.getElementById('points-advantages').textContent = advantagesSpent;
            
            // Flaws
            const flawsSpent = Object.values(flawValues).reduce((sum, flaw) => sum + flaw.value, 0);
            document.getElementById('points-flaws').textContent = flawsSpent;
        }
        
        function setupPrioritySelectors() {
            // Attribute priority selectors
            ['primary', 'secondary', 'tertiary'].forEach(level => {
                document.getElementById(`attr-priority-${level}`).addEventListener('change', function() {
                    handleAttributePriorityChange(level, this.value);
                });
                document.getElementById(`skill-priority-${level}`).addEventListener('change', function() {
                    handleSkillPriorityChange(level, this.value);
                });
            });
        }
        
        function handleAttributePriorityChange(level, category) {
            attributePriorities[level] = category || null;
            
            // Prevent duplicate selections
            validatePrioritySelections('attr');
            
            // Update max values in tracker
            updateAttributeMaxValues();
            updatePointsDisplay();
            validateForm();
        }
        
        function handleSkillPriorityChange(level, category) {
            skillPriorities[level] = category || null;
            
            // Prevent duplicate selections
            validatePrioritySelections('skill');
            
            // Update max values in tracker
            updateSkillMaxValues();
            updatePointsDisplay();
            validateForm();
        }
        
        function validatePrioritySelections(type) {
            const priorities = type === 'attr' ? attributePriorities : skillPriorities;
            const prefix = type === 'attr' ? 'attr' : 'skill';
            
            // Get all selected values
            const selected = Object.values(priorities).filter(v => v !== null);
            
            // Disable already-selected options in other dropdowns
            ['primary', 'secondary', 'tertiary'].forEach(level => {
                const select = document.getElementById(`${prefix}-priority-${level}`);
                const currentValue = priorities[level];
                
                Array.from(select.options).forEach(option => {
                    if (option.value && option.value !== currentValue) {
                        option.disabled = selected.includes(option.value);
                    }
                });
            });
        }
        
        function getAttributePoolForCategory(category) {
            if (attributePriorities.primary === category) return 7;
            if (attributePriorities.secondary === category) return 5;
            if (attributePriorities.tertiary === category) return 3;
            return null;
        }
        
        function getSkillPoolForCategory(category) {
            if (skillPriorities.primary === category) return 13;
            if (skillPriorities.secondary === category) return 9;
            if (skillPriorities.tertiary === category) return 5;
            return null;
        }
        
        function updateAttributeMaxValues() {
            document.getElementById('attr-physical-max').textContent = getAttributePoolForCategory('physical') ?? '?';
            document.getElementById('attr-social-max').textContent = getAttributePoolForCategory('social') ?? '?';
            document.getElementById('attr-mental-max').textContent = getAttributePoolForCategory('mental') ?? '?';
            
            // Update section headers
            const physPool = getAttributePoolForCategory('physical');
            const socPool = getAttributePoolForCategory('social');
            const menPool = getAttributePoolForCategory('mental');
            
            document.getElementById('attr-physical-pool').textContent = physPool ? `(${physPool} dots)` : '';
            document.getElementById('attr-social-pool').textContent = socPool ? `(${socPool} dots)` : '';
            document.getElementById('attr-mental-pool').textContent = menPool ? `(${menPool} dots)` : '';
        }
        
        function updateSkillMaxValues() {
            document.getElementById('skill-physical-max').textContent = getSkillPoolForCategory('physical') ?? '?';
            document.getElementById('skill-social-max').textContent = getSkillPoolForCategory('social') ?? '?';
            document.getElementById('skill-mental-max').textContent = getSkillPoolForCategory('mental') ?? '?';
            
            // Update section headers
            const physPool = getSkillPoolForCategory('physical');
            const socPool = getSkillPoolForCategory('social');
            const menPool = getSkillPoolForCategory('mental');
            
            document.getElementById('skill-physical-pool').textContent = physPool ? `(${physPool} dots)` : '';
            document.getElementById('skill-social-pool').textContent = socPool ? `(${socPool} dots)` : '';
            document.getElementById('skill-mental-pool').textContent = menPool ? `(${menPool} dots)` : '';
        }
        
        function updatePoolDisplay(type, category, spent, max) {
            const trackerId = `tracker-${type}-${category}`;
            const tracker = document.getElementById(trackerId);
            if (!tracker) return;

            // Normalize the prefix so we never accumulate multiple ‚úì/‚ùå
            const normalizePrefix = (symbol) => {
                tracker.innerHTML = tracker.innerHTML
                    // Replace any existing marks after the colon and before the first span
                    .replace(/^([^<]*:)\s*(?:[‚úì‚ùå]\s*)*/, `$1 ${symbol} `);
            };
            const clearPrefixMarks = () => {
                tracker.innerHTML = tracker.innerHTML
                    .replace(/^([^<]*:)\s*(?:[‚úì‚ùå]\s*)*/, '$1 ');
            };
            
            if (max === null) {
                tracker.className = '';
                clearPrefixMarks();
                return;
            }
            
            if (spent === max) {
                tracker.className = 'validation-success';
                normalizePrefix('‚úì');
            } else if (spent > max) {
                tracker.className = 'validation-error';
                normalizePrefix('‚ùå');
            } else {
                tracker.className = 'validation-error';
                normalizePrefix('‚ùå');
            }
        }

        function setupClanSelector() {
            document.getElementById('clan').addEventListener('change', function() {
                const clanInfo = document.getElementById('clan-info');
                const selectedClan = this.value;

                if (selectedClan && CLANS[selectedClan]) {
                    const clan = CLANS[selectedClan];
                    let html = `<strong>${selectedClan}</strong><br>`;
                    if (clan.disciplines.length > 0) {
                        html += `<strong>Disciplines:</strong> ${clan.disciplines.join(', ')}<br>`;
                    } else {
                        html += `<strong>Disciplines:</strong> Choose any 2 disciplines at character creation<br>`;
                    }
                    html += `<strong>Bane:</strong> ${clan.bane}`;
                    clanInfo.innerHTML = html;
                    clanInfo.style.display = 'block';
                    
                    // Re-render disciplines if they're already loaded
                    if (disciplinesData.length > 0) {
                        renderDisciplines();
                    }
                } else {
                    clanInfo.style.display = 'none';
                }
            });
        }

        async function loadTraitData() {
            try {
                // Load disciplines, advantages, and flaws in parallel
                const [disciplinesResponse, advantagesResponse, flawsResponse] = await Promise.all([
                    fetch('/api/traits/?category=disciplines'),
                    fetch('/api/traits/?category=advantages'),
                    fetch('/api/traits/?category=flaws')
                ]);

                if (!disciplinesResponse.ok || !advantagesResponse.ok || !flawsResponse.ok) {
                    throw new Error('Failed to load trait data');
                }

                const disciplinesJson = await disciplinesResponse.json();
                const advantagesJson = await advantagesResponse.json();
                const flawsJson = await flawsResponse.json();

                // Extract the traits array from the API response objects
                disciplinesData = disciplinesJson.traits;
                advantagesData = advantagesJson.traits;
                flawsData = flawsJson.traits;

                renderDisciplines();
                renderAdvantages();
                renderFlaws();

            } catch (error) {
                console.error('Error loading trait data:', error);
                showToast('Error loading trait data: ' + error.message, 'danger');
            }
        }

        function renderDisciplines() {
            const container = document.getElementById('disciplines-container');
            const selectedClan = document.getElementById('clan').value;
            const inClanDisciplines = selectedClan && CLANS[selectedClan] ? CLANS[selectedClan].disciplines : [];
            
            let html = '<div class="trait-group">';
            
            disciplinesData.forEach(discipline => {
                const isInClan = inClanDisciplines.includes(discipline.name);
                const labelClass = isInClan ? 'trait-label in-clan' : 'trait-label';
                
                html += `
                    <div class="trait-row">
                        <span class="${labelClass}">${discipline.name}${isInClan ? ' ‚òÖ' : ''}</span>
                        <div class="trait-dots" data-trait="${discipline.name}" data-category="disciplines"></div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Initialize discipline dots
            container.querySelectorAll('.trait-dots').forEach(dotsContainer => {
                const trait = dotsContainer.dataset.trait;
                disciplineValues[trait] = disciplineValues[trait] || 0;
                
                // Create dots (max 3 for disciplines)
                for (let i = 1; i <= 3; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i <= disciplineValues[trait]) {
                        dot.classList.add('filled');
                    }
                    dot.dataset.value = i;
                    
                    dot.addEventListener('click', function() {
                        const clickedValue = parseInt(this.dataset.value);
                        const currentValue = disciplineValues[trait] ?? 0;
                        let newValue = clickedValue;
                        if (clickedValue === currentValue) {
                            newValue = Math.max(0, currentValue - 1);
                        }
                        disciplineValues[trait] = newValue;
                        updateDots(dotsContainer, newValue);
                        updatePointsDisplay();
                        validateForm();
                    });
                    
                    dotsContainer.appendChild(dot);
                }
            });
            
            updatePointsDisplay();
        }

        function renderAdvantages() {
            const container = document.getElementById('advantages-container');
            
            let html = '<div class="trait-group">';
            
            advantagesData.forEach(advantage => {
                const needsInstance = advantage.is_instanced || false;
                const needsSpecialty = advantage.has_specialties || false;
                
                html += `
                    <div class="trait-row-with-input">
                        <span class="trait-label">${advantage.name}</span>
                        <div class="trait-dots" data-trait="${advantage.name}" data-category="advantages"></div>
                `;
                
                if (needsInstance) {
                    html += `
                        <input type="text" class="form-control trait-instance-input" 
                               id="advantage-instance-${advantage.name.replace(/\s+/g, '_')}" 
                               placeholder="Specify instance...">
                    `;
                } else if (needsSpecialty) {
                    html += `
                        <input type="text" class="form-control trait-specialty-input" 
                               id="advantage-specialty-${advantage.name.replace(/\s+/g, '_')}" 
                               placeholder="Specify specialty...">
                    `;
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Initialize advantage dots
            container.querySelectorAll('.trait-dots').forEach(dotsContainer => {
                const trait = dotsContainer.dataset.trait;
                advantageValues[trait] = advantageValues[trait] || { value: 0 };
                
                // Create dots (1-5 for advantages)
                for (let i = 1; i <= 5; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i <= advantageValues[trait].value) {
                        dot.classList.add('filled');
                    }
                    dot.dataset.value = i;
                    
                    dot.addEventListener('click', function() {
                        const clickedValue = parseInt(this.dataset.value);
                        const currentValue = advantageValues[trait].value ?? 0;
                        let newValue = clickedValue;
                        if (clickedValue === currentValue) {
                            newValue = Math.max(0, currentValue - 1);
                        }
                        advantageValues[trait].value = newValue;
                        updateDots(dotsContainer, newValue);
                        updatePointsDisplay();
                        validateForm();
                    });
                    
                    dotsContainer.appendChild(dot);
                }
            });
            
            updatePointsDisplay();
        }

        function renderFlaws() {
            const container = document.getElementById('flaws-container');
            
            let html = '<div class="trait-group">';
            
            flawsData.forEach(flaw => {
                const needsInstance = flaw.is_instanced || false;
                const needsSpecialty = flaw.has_specialties || false;
                
                html += `
                    <div class="trait-row-with-input">
                        <span class="trait-label">${flaw.name}</span>
                        <div class="trait-dots" data-trait="${flaw.name}" data-category="flaws"></div>
                `;
                
                if (needsInstance) {
                    html += `
                        <input type="text" class="form-control trait-instance-input" 
                               id="flaw-instance-${flaw.name.replace(/\s+/g, '_')}" 
                               placeholder="Specify instance...">
                    `;
                } else if (needsSpecialty) {
                    html += `
                        <input type="text" class="form-control trait-specialty-input" 
                               id="flaw-specialty-${flaw.name.replace(/\s+/g, '_')}" 
                               placeholder="Specify specialty...">
                    `;
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Initialize flaw dots
            container.querySelectorAll('.trait-dots').forEach(dotsContainer => {
                const trait = dotsContainer.dataset.trait;
                flawValues[trait] = flawValues[trait] || { value: 0 };
                
                // Create dots (1-5 for flaws)
                for (let i = 1; i <= 5; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i <= flawValues[trait].value) {
                        dot.classList.add('filled');
                    }
                    dot.dataset.value = i;
                    
                    dot.addEventListener('click', function() {
                        const newValue = parseInt(this.dataset.value);
                        flawValues[trait].value = newValue;
                        updateDots(dotsContainer, newValue);
                        updatePointsDisplay();
                        validateForm();
                    });
                    
                    dotsContainer.appendChild(dot);
                }
            });
            
            updatePointsDisplay();
        }

        function validateForm() {
            const errors = [];
            
            // Validate attribute priorities are assigned
            if (!attributePriorities.primary || !attributePriorities.secondary || !attributePriorities.tertiary) {
                errors.push('You must assign all attribute priorities (Primary, Secondary, Tertiary)');
            } else {
                // Validate attribute spending
                const physicalSpent = (['strength', 'dexterity', 'stamina']
                    .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;
                const socialSpent = (['charisma', 'manipulation', 'composure']
                    .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;
                const mentalSpent = (['intelligence', 'wits', 'resolve']
                    .reduce((sum, trait) => sum + traitValues[trait], 0)) - 3;
                
                const physicalMax = getAttributePoolForCategory('physical');
                const socialMax = getAttributePoolForCategory('social');
                const mentalMax = getAttributePoolForCategory('mental');
                
                if (physicalSpent !== physicalMax) {
                    errors.push(`Physical Attributes: Must spend exactly ${physicalMax} dots (currently ${physicalSpent})`);
                }
                if (socialSpent !== socialMax) {
                    errors.push(`Social Attributes: Must spend exactly ${socialMax} dots (currently ${socialSpent})`);
                }
                if (mentalSpent !== mentalMax) {
                    errors.push(`Mental Attributes: Must spend exactly ${mentalMax} dots (currently ${mentalSpent})`);
                }
            }
            
            // Validate skill priorities are assigned
            if (!skillPriorities.primary || !skillPriorities.secondary || !skillPriorities.tertiary) {
                errors.push('You must assign all skill priorities (Primary, Secondary, Tertiary)');
            } else {
                // Validate skill spending
                const physicalSkills = ['athletics', 'brawl', 'craft', 'drive', 'firearms', 'melee', 'larceny', 'stealth', 'survival'];
                const socialSkills = ['animal_ken', 'etiquette', 'insight', 'intimidation', 'leadership', 'performance', 'persuasion', 'streetwise', 'subterfuge'];
                const mentalSkills = ['academics', 'awareness', 'finance', 'investigation', 'medicine', 'occult', 'politics', 'science', 'technology'];
                
                const physicalSkillsSpent = physicalSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);
                const socialSkillsSpent = socialSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);
                const mentalSkillsSpent = mentalSkills.reduce((sum, trait) => sum + (traitValues[trait] || 0), 0);
                
                const physicalSkillMax = getSkillPoolForCategory('physical');
                const socialSkillMax = getSkillPoolForCategory('social');
                const mentalSkillMax = getSkillPoolForCategory('mental');
                
                if (physicalSkillsSpent !== physicalSkillMax) {
                    errors.push(`Physical Skills: Must spend exactly ${physicalSkillMax} dots (currently ${physicalSkillsSpent})`);
                }
                if (socialSkillsSpent !== socialSkillMax) {
                    errors.push(`Social Skills: Must spend exactly ${socialSkillMax} dots (currently ${socialSkillsSpent})`);
                }
                if (mentalSkillsSpent !== mentalSkillMax) {
                    errors.push(`Mental Skills: Must spend exactly ${mentalSkillMax} dots (currently ${mentalSkillsSpent})`);
                }
            }
            
            // Validate disciplines
            const selectedClan = document.getElementById('clan').value;
            const disciplinesSpent = Object.values(disciplineValues).reduce((sum, val) => sum + val, 0);
            
            if (disciplinesSpent !== 3) {
                errors.push(`Disciplines: Must spend exactly 3 dots (currently ${disciplinesSpent})`);
            } else if (selectedClan && CLANS[selectedClan]) {
                // Validate in-clan dots
                const inClanDisciplines = CLANS[selectedClan].disciplines;
                const inClanSpent = Object.entries(disciplineValues)
                    .filter(([disc, val]) => inClanDisciplines.includes(disc) && val > 0)
                    .reduce((sum, [disc, val]) => sum + val, 0);
                
                if (inClanSpent < 2) {
                    errors.push(`Disciplines: Must spend at least 2 dots in in-clan disciplines (currently ${inClanSpent})`);
                }
            }
            
            // Validate advantages
            const advantagesSpent = Object.values(advantageValues).reduce((sum, adv) => sum + adv.value, 0);
            if (advantagesSpent !== 7) {
                errors.push(`Advantages: Must spend exactly 7 points (currently ${advantagesSpent})`);
            }
            
            // Validate flaws (maximum 2)
            const flawsSpent = Object.values(flawValues).reduce((sum, flaw) => sum + flaw.value, 0);
            if (flawsSpent > 2) {
                errors.push(`Flaws: Cannot exceed 2 points (currently ${flawsSpent})`);
            }
            
            // Update tracker display with validation status
            const trackerDisciplines = document.getElementById('tracker-disciplines');
            // Helper to normalize trailing label markers like 'dots' or 'points'
            const normalizeSuffix = (el, word, symbol) => {
                const re = new RegExp(`(${word})[\\s‚úì‚ùå]*`);
                el.innerHTML = el.innerHTML.replace(re, `$1 ${symbol} `);
            };

            if (disciplinesSpent === 3) {
                trackerDisciplines.className = 'validation-success';
                normalizeSuffix(trackerDisciplines, 'dots', '‚úì');
            } else {
                trackerDisciplines.className = 'validation-error';
                normalizeSuffix(trackerDisciplines, 'dots', '‚ùå');
            }
            
            const trackerAdvantages = document.getElementById('tracker-advantages');
            if (advantagesSpent === 7) {
                trackerAdvantages.className = 'validation-success';
                normalizeSuffix(trackerAdvantages, 'points', '‚úì');
            } else {
                trackerAdvantages.className = 'validation-error';
                normalizeSuffix(trackerAdvantages, 'points', '‚ùå');
            }
            
            const trackerFlaws = document.getElementById('tracker-flaws');
            if (flawsSpent <= 2) {
                trackerFlaws.className = 'validation-success';
                normalizeSuffix(trackerFlaws, 'points', '‚úì');
            } else {
                trackerFlaws.className = 'validation-error';
                normalizeSuffix(trackerFlaws, 'points', '‚ùå');
            }
            
            // Display errors or hide error section
            const errorSection = document.getElementById('validation-errors');
            const errorList = document.getElementById('error-list-items');
            const submitButton = document.getElementById('submit-button');
            
            if (errors.length > 0) {
                errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
                errorSection.style.display = 'block';
                submitButton.disabled = true;
            } else {
                errorSection.style.display = 'none';
                submitButton.disabled = false;
            }
            
            return errors.length === 0;
        }
        
        function setupFormSubmit() {
            document.getElementById('character-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Final validation check
                if (!validateForm()) {
                    showToast('Please fix all validation errors before submitting', 'danger');
                    return;
                }

                // Build character data
                const character_data = {
                    name: document.getElementById('full_name').value,
                    concept: document.getElementById('concept').value,
                    clan: document.getElementById('clan').value,
                    sire: document.getElementById('sire').value,
                    generation: parseInt(document.getElementById('generation').value) || null,
                    predator_type: document.getElementById('predator_type').value,
                    ambition: document.getElementById('ambition').value,
                    desire: document.getElementById('desire').value,
                    splat: 'vampire'
                };

                // Add basic traits (attributes and skills)
                for (const [trait, value] of Object.entries(traitValues)) {
                    character_data[trait] = value;
                }

                // Add disciplines
                const disciplines = {};
                for (const [discipline, value] of Object.entries(disciplineValues)) {
                    if (value > 0) {
                        disciplines[discipline] = value;
                    }
                }
                character_data.disciplines = disciplines;

                // Add advantages with instance/specialty data
                const advantages = {};
                for (const [advantage, data] of Object.entries(advantageValues)) {
                    if (data.value > 0) {
                        const advantageData = { value: data.value };
                        
                        // Check for instance input
                        const instanceInput = document.getElementById(`advantage-instance-${advantage.replace(/\s+/g, '_')}`);
                        if (instanceInput && instanceInput.value) {
                            advantageData.instance = instanceInput.value;
                        }
                        
                        // Check for specialty input
                        const specialtyInput = document.getElementById(`advantage-specialty-${advantage.replace(/\s+/g, '_')}`);
                        if (specialtyInput && specialtyInput.value) {
                            advantageData.specialty = specialtyInput.value;
                        }
                        
                        advantages[advantage] = advantageData;
                    }
                }
                character_data.advantages = advantages;

                // Add flaws with instance/specialty data
                const flaws = {};
                for (const [flaw, data] of Object.entries(flawValues)) {
                    if (data.value > 0) {
                        const flawData = { value: data.value };
                        
                        // Check for instance input
                        const instanceInput = document.getElementById(`flaw-instance-${flaw.replace(/\s+/g, '_')}`);
                        if (instanceInput && instanceInput.value) {
                            flawData.instance = instanceInput.value;
                        }
                        
                        // Check for specialty input
                        const specialtyInput = document.getElementById(`flaw-specialty-${flaw.replace(/\s+/g, '_')}`);
                        if (specialtyInput && specialtyInput.value) {
                            flawData.specialty = specialtyInput.value;
                        }
                        
                        flaws[flaw] = flawData;
                    }
                }
                character_data.flaws = flaws;

                const payload = { character_data };
                console.log('Submitting character:', payload);

                try {
                    const response = await fetch('/api/traits/character/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to submit character');
                    }

                    const data = await response.json();
                    console.log('Success response:', data);

                    showToast('Character submitted for approval!', 'success');

                    // Clear form or redirect
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);

                } catch (error) {
                    console.error('Error submitting character:', error);
                    showToast('Error: ' + error.message, 'danger');
                }
            });
        }

        function showToast(message, type = 'info') {
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Toast container not found');
                return;
            }

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = toastHTML.trim();
            const toastEl = tempDiv.firstChild;
            container.appendChild(toastEl);

            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }
    </script>
</body>
</html>
